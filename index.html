<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard v1.2</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
 body{background:#0f172a;color:#f8fafc;font-family:'Inter',sans-serif;}
 .card{background:#1e293b;border-radius:1rem;padding:1rem;margin-bottom:1rem;}
 .btn{padding:.6rem 1rem;border-radius:.6rem;font-weight:600;transition:.2s all;}
 .btn:hover{filter:brightness(1.1);}
 .metric-main{font-size:3rem;font-weight:700;}
 .metric-label{font-size:.9rem;color:#94a3b8;margin-top:-.3rem;}
 .log-box{font-family:monospace;font-size:.8rem;background:#0f172a;padding:.5rem;border-radius:.5rem;max-height:180px;overflow-y:auto;}
</style>
</head>
<body class="min-h-screen flex flex-col items-center px-3 py-4">

<header class="text-center mb-4">
  <h1 class="text-2xl font-bold text-blue-400">MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard</h1>
  <p class="text-gray-400 text-sm mt-1">v1.2 ¬∑ FTMS + Heart Rate BLE Dual Stream</p>
</header>

<!-- CONTROLES PRINCIPALES -->
<div class="card w-full max-w-lg text-center">
  <div class="flex flex-wrap justify-center gap-2 mb-2">
    <button id="connectFTMS" class="btn bg-blue-600 text-white">Conectar Rower</button>
    <button id="disconnectFTMS" class="btn bg-gray-600 text-white" disabled>Desconectar</button>
    <button id="wakeLockBtn" class="btn bg-indigo-600 text-white">Mantener pantalla activa</button>
    <button id="exportCSV" class="btn bg-sky-600 text-white">Exportar CSV</button>
  </div>
  <p id="status" class="text-sm text-gray-400 mt-1">Estado FTMS: Desconectado</p>
</div>

<!-- SENSOR CARD√çACO -->
<div class="card w-full max-w-lg text-center">
  <h2 class="text-lg font-semibold mb-2">Sensor Card√≠aco BLE</h2>
  <div class="flex flex-wrap justify-center gap-2">
    <button id="connectHRBtn" class="btn bg-red-600 text-white">‚ù§Ô∏è Conectar HR</button>
    <button id="disconnectHRBtn" class="btn bg-gray-700 text-white" disabled>üîå Desconectar</button>
  </div>
  <p id="hrStatus" class="text-sm text-gray-400 mt-2">Estado: Desconectado</p>
  <div id="hrDisplay" class="metric-main text-red-400 mt-1">-- bpm</div>
</div>

<!-- M√âTRICAS PRINCIPALES -->
<div class="card w-full max-w-lg text-center">
  <div class="grid grid-cols-3 gap-4">
    <div><div id="mainSPM" class="metric-main text-blue-400">--</div><div class="metric-label">SPM</div></div>
    <div><div id="mainPower" class="metric-main text-orange-400">--</div><div class="metric-label">W</div></div>
    <div><div id="mainBPM" class="metric-main text-red-400">--</div><div class="metric-label">BPM</div></div>
  </div>
</div>

<!-- M√âTRICAS EN VIVO -->
<div class="card w-full max-w-lg">
  <h2 class="text-lg font-semibold mb-2">M√©tricas en vivo</h2>
  <table class="w-full text-sm text-left">
    <thead><tr class="text-gray-400"><th>Par√°metro</th><th>Valor</th><th>Detalle</th></tr></thead>
    <tbody id="metricsBody" class="divide-y divide-gray-700"></tbody>
  </table>
</div>

<!-- REGISTRO -->
<div class="card w-full max-w-lg">
  <h2 class="text-lg font-semibold mb-2">Registro</h2>
  <div id="log" class="log-box"></div>
</div>

<script>
let deviceFTMS=null, charFTMS=null;
let deviceHR=null, charHR=null;
let wakeLock=null,currentHR=0;
let metricsLog=[];

function log(txt){
 const box=document.getElementById("log");
 box.textContent+=`[${new Date().toLocaleTimeString()}] ${txt}\n`;
 box.scrollTop=box.scrollHeight;
}
function upsertField(name,val,desc){
 const body=document.getElementById("metricsBody");
 let row=[...body.querySelectorAll("tr")].find(r=>r.dataset.name===name);
 if(!val||val==="0"||val==="0.0"||val==="--"){ if(row)row.remove(); return; }
 if(!row){
  row=document.createElement("tr"); row.dataset.name=name;
  row.innerHTML=`<td class='py-1'>${name}</td><td id='v_${name}' class='py-1 font-semibold'>${val}</td><td class='py-1 text-gray-400'>${desc||''}</td>`;
  body.appendChild(row);
 }else{row.children[1].textContent=val;}
}

document.getElementById("wakeLockBtn").onclick=async()=>{
 try{wakeLock=await navigator.wakeLock.request("screen");log("üîí Pantalla activa");}
 catch(e){log("Error wakeLock: "+e);}
};

// ---------- FTMS ----------
document.getElementById("connectFTMS").onclick=async()=>{
 try{
  deviceFTMS=await navigator.bluetooth.requestDevice({filters:[{services:[0x1826]}]});
  const server=await deviceFTMS.gatt.connect();
  const service=await server.getPrimaryService(0x1826);
  let characteristics = await service.getCharacteristics();
let found = characteristics.find(c =>
  c.uuid.toLowerCase().includes("2ad2") || c.uuid.toLowerCase().includes("2ad1")
);
if (!found) throw new Error("No se encontr√≥ characteristic FTMS (0x2AD1 ni 0x2AD2)");
charFTMS = found;
await charFTMS.startNotifications();
charFTMS.addEventListener("characteristicvaluechanged", handleFTMS);
log(`‚úÖ FTMS conectado (${charFTMS.uuid.includes("2ad2") ? "Indoor Rowing Data 0x2AD2" : "Fitness Machine Data 0x2AD1"})`);
  document.getElementById("status").textContent="Estado FTMS: Conectado";
  document.getElementById("disconnectFTMS").disabled=false;
  log("‚úÖ FTMS conectado");
 }catch(e){log("‚ùå Error FTMS: "+e);}
};
document.getElementById("disconnectFTMS").onclick=()=>{
 try{deviceFTMS?.gatt.disconnect();document.getElementById("status").textContent="Estado FTMS: Desconectado";
 document.getElementById("disconnectFTMS").disabled=true;log("üîå FTMS desconectado");}catch{}
};

// Parse Indoor Rowing Data (0x2AD2)
function handleFTMS(event){
 const d=event.target.value;
 const flags=d.getUint16(0,true);let i=2;
 const avgStroke=(flags&0x0002),distFlag=(flags&0x0004),paceFlag=(flags&0x0008),
       powerFlag=(flags&0x0020),elapsedFlag=(flags&0x0200),hrFlag=(flags&0x0100);
 const strokeRate=d.getUint8(i++),strokeCount=d.getUint16(i,true);i+=2;
 let avgSR=null;if(avgStroke){avgSR=d.getUint8(i++);}
 let dist=null;if(distFlag){dist=(d.getUint16(i,true)+(d.getUint8(i+2)<<16))/1000;i+=3;}
 let pace=null;if(paceFlag){pace=(d.getUint16(i,true)/10).toFixed(1);i+=2;}
 let power=null;if(powerFlag){power=d.getInt16(i,true);i+=2;}
 let hrRow=null;if(hrFlag){hrRow=d.getUint8(i++);}
 let elapsed=null;if(elapsedFlag){elapsed=d.getUint16(i,true);i+=2;}

 upsertField("Stroke Rate",strokeRate,"Brazadas/min");
 upsertField("Stroke Count",strokeCount,"Total remadas");
 if(avgSR)upsertField("Avg Stroke Rate",avgSR,"Promedio");
 if(power!==null&&power>0)upsertField("Instant Power",power,"W");
 if(dist!==null)upsertField("Total Distance",dist.toFixed(3)+" km","Distancia");
 if(pace)upsertField("Pace",pace,"s/500 m");
 if(elapsed)upsertField("Elapsed",elapsed+" seg","");
 if(hrRow>0)upsertField("Heart Rate",hrRow+" bpm","FTMS");
 if(currentHR>0)upsertField("Heart Rate",currentHR+" bpm","Sensor BLE");

 document.getElementById("mainSPM").textContent=strokeRate||"--";
 document.getElementById("mainPower").textContent=(power&&power>0)?power:"--";
 document.getElementById("mainBPM").textContent=currentHR>0?currentHR:(hrRow||"--");

 metricsLog.push({t:Date.now(),spm:strokeRate,power:power,hr:currentHR});
}

// ---------- HR SENSOR ----------
async function connectHeartRate(){
 try{
  const d=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}]});
  deviceHR=d;const s=await d.gatt.connect();
  const svc=await s.getPrimaryService("heart_rate");
  charHR=await svc.getCharacteristic("heart_rate_measurement");
  await charHR.startNotifications();
  charHR.addEventListener("characteristicvaluechanged",handleHR);
  document.getElementById("hrStatus").textContent="Estado: Conectado";
  document.getElementById("connectHRBtn").disabled=true;
  document.getElementById("disconnectHRBtn").disabled=false;
  log("‚ù§Ô∏è Sensor HR conectado");
 }catch(e){log("‚ùå Error HR: "+e);}
}
function handleHR(e){
 const v=e.target.value,f=v.getUint8(0);
 currentHR=(f&1)?v.getUint16(1,true):v.getUint8(1);
 document.getElementById("hrDisplay").textContent=currentHR+" bpm";
 document.getElementById("mainBPM").textContent=currentHR;
}
function disconnectHeartRate(){
 try{
  deviceHR?.gatt.disconnect();
  document.getElementById("hrStatus").textContent="Estado: Desconectado";
  document.getElementById("hrDisplay").textContent="-- bpm";
  document.getElementById("mainBPM").textContent="--";
  document.getElementById("connectHRBtn").disabled=false;
  document.getElementById("disconnectHRBtn").disabled=true;
  log("üîå Sensor HR desconectado");
 }catch(e){log("Error desconectar HR:"+e);}
}
document.getElementById("connectHRBtn").onclick=connectHeartRate;
document.getElementById("disconnectHRBtn").onclick=disconnectHeartRate;

// ---------- EXPORTAR CSV ----------
document.getElementById("exportCSV").onclick=()=>{
 if(!metricsLog.length){alert("Sin datos para exportar");return;}
 const header="timestamp,spm,power,hr\n";
 const rows=metricsLog.map(m=>`${new Date(m.t).toISOString()},${m.spm||""},${m.power||""},${m.hr||""}`).join("\n");
 const blob=new Blob([header+rows],{type:"text/csv"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;a.download="merach_session_"+new Date().toISOString().replace(/[:.]/g,"-")+".csv";
 a.click();URL.revokeObjectURL(url);
 log("üíæ CSV exportado");
};
</script>
</body>
</html>

