<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard v1.7</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f172a;color:#f8fafc;font-family:'Inter',system-ui,sans-serif}
.card{background:#1e293b;border-radius:1rem;padding:1rem;margin-bottom:1rem}
.btn{padding:.65rem 1rem;border-radius:.75rem;font-weight:700;transition:.2s all}
.btn:hover{filter:brightness(1.08)}
.metric-main{font-size:2.5rem;font-weight:800;line-height:1}
.metric-label{font-size:.8rem;color:#94a3b8;margin-top:.25rem}
.log-box{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem;background:#0b1222;padding:.6rem;border-radius:.6rem;max-height:200px;overflow:auto;white-space:pre-wrap}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-top:.8rem}
</style>
</head>
<body class="min-h-screen flex flex-col items-center px-3 py-4">

<header class="text-center mb-4">
  <h1 class="text-2xl font-extrabold text-blue-400">MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard</h1>
  <p class="text-gray-400 text-sm mt-1">v1.7 ¬∑ FTMS auto + HR BLE</p>
</header>

<!-- CONTROLES -->
<div class="card w-full max-w-5xl text-center">
  <div class="flex flex-wrap justify-center gap-2 mb-2">
    <button id="btnConnectFTMS" class="btn bg-blue-600 text-white">Conectar Rower</button>
    <button id="btnDisconnectFTMS" class="btn bg-gray-600 text-white" disabled>Desconectar</button>
    <button id="wakeLockBtn" class="btn bg-indigo-600 text-white">Mantener pantalla activa</button>
    <button id="exportCSV" class="btn bg-sky-600 text-white">Exportar CSV</button>
  </div>
  <p id="status" class="text-sm text-gray-300">Estado FTMS: Desconectado</p>
</div>

<!-- SENSOR HR -->
<div class="card w-full max-w-5xl text-center">
  <h2 class="text-lg font-semibold mb-2">Sensor Card√≠aco BLE</h2>
  <div class="flex flex-wrap justify-center gap-2">
    <button id="connectHRBtn" class="btn bg-red-600 text-white">‚ù§Ô∏è Conectar HR</button>
    <button id="disconnectHRBtn" class="btn bg-gray-700 text-white" disabled>üîå Desconectar</button>
  </div>
  <p id="hrStatus" class="text-sm text-gray-300 mt-2">Estado: Desconectado</p>
  <div id="hrDisplay" class="metric-main text-red-400 mt-1">0 bpm</div>
</div>

<!-- HUD M√âTRICAS -->
<div class="card w-full max-w-5xl text-center">
  <div class="grid3">
    <div><div id="mainSPM" class="metric-main text-blue-400">0</div><div class="metric-label">SPM</div></div>
    <div><div id="mainHR" class="metric-main text-rose-400">0</div><div class="metric-label">BPM</div></div>
    <div><div id="mainStrokes" class="metric-main text-amber-400">0</div><div class="metric-label">STROKES</div></div>
  </div>
  <div class="grid2">
    <div><div id="mainDist" class="metric-main text-emerald-400">0.000</div><div class="metric-label">KM</div></div>
    <div><div id="mainPace" class="metric-main text-cyan-400">0:00</div><div class="metric-label">PACE (500m)</div></div>
  </div>
</div>

<!-- M√âTRICAS DETALLADAS -->
<div class="card w-full max-w-5xl">
  <h3 class="text-lg font-semibold mb-2">M√©tricas en vivo</h3>
  <table class="w-full text-sm">
    <thead><tr><th class="text-left">Par√°metro</th><th class="text-right">Valor</th><th class="text-right">Detalle</th></tr></thead>
    <tbody id="metricsBody"></tbody>
  </table>
</div>

<!-- REGISTRO -->
<div class="card w-full max-w-5xl">
  <h3 class="text-lg font-semibold mb-2">Registro</h3>
  <div id="log" class="log-box"></div>
</div>

<script>
let deviceFTMS,charFTMS,deviceHR,charHR,wakeLock;
let dataLog=[],metrics={},lastVals={power:0,spm:0,pace:0,strokes:0,dist:0,avg:0,hr:0};
const metricsBody=document.getElementById('metricsBody'),logBox=document.getElementById('log');
function log(msg){const t=new Date().toLocaleTimeString();logBox.textContent+=`[${t}] ${msg}\n`;logBox.scrollTop=logBox.scrollHeight;}
function formatPace(val){if(!val)return"0:00";const m=Math.floor(val/60);const s=(val%60).toFixed(1).padStart(4,"0");return`${m}:${s}/500m`;}

// UI refresco
function updateUI(){
  mainSPM.textContent=metrics.strokeRate??lastVals.spm;
  mainHR.textContent=metrics.heartRate??lastVals.hr;
  mainStrokes.textContent=metrics.strokeCount??lastVals.strokes;
  mainDist.textContent=(metrics.totalDistance??lastVals.dist).toFixed(3);
  mainPace.textContent=formatPace(metrics.pace??lastVals.pace);
  metricsBody.innerHTML="";
  const rows=[
    ["Total Distance",metrics.totalDistance?.toFixed(3)||"0","Distancia"],
    ["Heart Rate",metrics.heartRate||0,"Sensor BLE"],
    ["Stroke Count",metrics.strokeCount||0,"Total remadas"],
    ["Avg Stroke Rate",metrics.avgStrokeRate||0,"Promedio"],
    ["Instant Power",metrics.instantPower||0,"W"],
    ["Stroke Rate",metrics.strokeRate||0,"Brazadas/min"],
    ["Pace",metrics.pace?formatPace(metrics.pace):"0:00","s/500 m"]
  ];
  for(const [p,v,d]of rows)
    metricsBody.innerHTML+=`<tr><td>${p}</td><td class="text-right font-semibold">${v}</td><td class="text-right text-gray-400">${d}</td></tr>`;
}

// ---- FTMS ----
async function connectFTMSDevice(){
  const btn=document.getElementById("btnConnectFTMS");btn.disabled=true;
  try{
    deviceFTMS=await navigator.bluetooth.requestDevice({filters:[{services:[0x1826]}],optionalServices:[0x1826,0xF8C0,0xFFF0,0x180A]});
    const server=await deviceFTMS.gatt.connect();
    const svcs=await server.getPrimaryServices();
    let svc=svcs.find(s=>s.uuid.includes("1826"))||svcs.find(s=>s.uuid.includes("f8c0"))||svcs.find(s=>s.uuid.includes("fff0"));
    if(!svc)throw new Error("No se encontr√≥ servicio v√°lido");
    const chars=await svc.getCharacteristics();
    charFTMS=chars.find(c=>c.uuid.includes("2ad1"))||chars.find(c=>c.uuid.includes("2ad2"))||chars[0];
    await charFTMS.startNotifications();
    charFTMS.addEventListener("characteristicvaluechanged",handleFTMS);
    document.getElementById("status").textContent="Estado FTMS: Conectado";
    document.getElementById("btnDisconnectFTMS").disabled=false;
    log(`‚úÖ FTMS conectado (${svc.uuid}) ‚Üí Char ${charFTMS.uuid}`);
  }catch(e){log("‚ùå Error FTMS: "+e);}
  finally{btn.disabled=false;}
}

// parser corregido (flags de 4 bytes)
function handleFTMS(e){
  const dv=e.target.value;
  if(dv.byteLength<6)return;
  const flags=dv.getUint32(0,true);
  let i=4;
  lastVals={...lastVals,...metrics};
  if(flags&0x0001){metrics.instantPower=dv.getUint16(i,true);i+=2;}else metrics.instantPower=lastVals.power;
  if(flags&0x0002){metrics.strokeRate=dv.getUint8(i++);}else metrics.strokeRate=lastVals.spm;
  if(flags&0x0004){metrics.strokeCount=dv.getUint16(i,true);i+=2;}else metrics.strokeCount=lastVals.strokes;
  if(flags&0x0008){metrics.totalDistance=dv.getUint32(i,true)/1000;i+=4;}else metrics.totalDistance=lastVals.dist;
  if(flags&0x0010){metrics.pace=dv.getUint16(i,true)/10;i+=2;}else metrics.pace=lastVals.pace;
  if(flags&0x0020){metrics.avgStrokeRate=dv.getUint8(i++);}else metrics.avgStrokeRate=lastVals.avg;
  updateUI();
  dataLog.push({...metrics,t:Date.now()});
}

// ---- HR ----
async function connectHR(){
  try{
    deviceHR=await navigator.bluetooth.requestDevice({filters:[{services:[0x180D]}]});
    const server=await deviceHR.gatt.connect();
    const svc=await server.getPrimaryService(0x180D);
    charHR=await svc.getCharacteristic(0x2A37);
    await charHR.startNotifications();
    charHR.addEventListener("characteristicvaluechanged",e=>{
      const v=e.target.value;const hr=v.getUint8(1);
      metrics.heartRate=hr;lastVals.hr=hr;
      hrDisplay.textContent=hr+" bpm";updateUI();
    });
    hrStatus.textContent="Estado: Conectado";
    disconnectHRBtn.disabled=false;
    log("‚ù§Ô∏è Sensor HR conectado");
  }catch(e){log("‚ùå Error HR: "+e);}
}

// ---- BOTONES ----
document.getElementById("btnConnectFTMS").onclick=connectFTMSDevice;
document.getElementById("btnDisconnectFTMS").onclick=()=>{if(deviceFTMS)deviceFTMS.gatt.disconnect();status.textContent="Estado FTMS: Desconectado";};
document.getElementById("connectHRBtn").onclick=connectHR;
document.getElementById("disconnectHRBtn").onclick=()=>{if(deviceHR)deviceHR.gatt.disconnect();hrStatus.textContent="Estado: Desconectado";hrDisplay.textContent="0 bpm";};
document.getElementById("wakeLockBtn").onclick=async()=>{try{wakeLock=await navigator.wakeLock.request("screen");wakeLockBtn.textContent="Pantalla activa ‚úÖ";}catch(e){alert("No soportado.");}};
document.getElementById("exportCSV").onclick=()=>{
  let csv="time,SPM,W,HR,Dist,Count,Pace\n";
  dataLog.forEach(d=>{csv+=`${d.t},${d.strokeRate||0},${d.instantPower||0},${d.heartRate||0},${d.totalDistance||0},${d.strokeCount||0},${d.pace||0}\n`;});
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));a.download="merach_q1s.csv";a.click();
};
</script>
</body>
</html>
