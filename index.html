<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Panel Remo - Cockpit UX</title>
  <style>
    :root{
      --bg-color:#000000; 
      --card-color:#1c1c1e; 
      --text-color:#ffffff;
      --primary-color:#00e5ff; 
      --secondary-color:#b388ff; 
      --accent-color:#ff5252;
      --interval-bg:#121212; 
      --guide-fast:#ff1744; 
      --guide-slow:#2979ff; 
      --guide-good:#00e676;
    }
    
    html,body{height:100%; margin:0; padding:0; overflow:hidden;}
    body{
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      display:flex;
      flex-direction:column;
      align-items:center;
      -webkit-tap-highlight-color: transparent;
    }

    /* === HEADER & FULLSCREEN === */
    header {
        width: 100%; display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px; box-sizing: border-box; position: absolute; top: 0; left: 0; z-index: 50;
    }
    h1 { font-size: 1rem; margin: 0; opacity: 0.7; font-weight: 400; letter-spacing: 1px; }
    #fullscreen-btn {
        background: none; border: 1px solid #333; color: white; border-radius: 4px; 
        padding: 5px 10px; cursor: pointer; font-size: 1.2rem;
    }

    /* === CONTENEDOR PRINCIPAL === */
    .container {
      width: 100%; height: 100%; 
      display: flex; flex-direction: column; 
      position: relative; 
      padding-top: 50px; /* Espacio header */
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    /* === STATUS BAR === */
    .status-bar{
        display:flex; justify-content:center; gap: 20px;
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
        margin-bottom: 5px; opacity: 0.8; flex-shrink: 0;
    }
    .connected{color:var(--primary-color); text-shadow: 0 0 5px var(--primary-color);} 
    .disconnected{color:#555;}

    /* === DASHBOARD INTERVALOS (EL COCKPIT) === */
    #interval-dashboard {
        display: none; /* Se activa con JS */
        flex: 1;
        background: var(--interval-bg);
        position: relative;
        overflow: hidden; 
        width: 100%;
        box-sizing: border-box;
        border-bottom: 1px solid #333;
    }
    
    /* Layout interno del Cockpit */
    .cockpit-layout {
        display: grid;
        grid-template-columns: 1fr 140px; /* Gr√°fico | Datos Tiempo/Objetivo */
        grid-template-rows: 1fr auto;
        height: 100%;
        padding: 10px;
        box-sizing: border-box;
    }

    /* Columna Izquierda: Visualizaci√≥n */
    .viz-col {
        position: relative; display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
    }
    canvas#rower-canvas {
        width: 100%; height: auto; max-height: 60vh;
        filter: drop-shadow(0 0 8px rgba(0,229,255,0.2));
    }
    
    /* Indicador Barra Inferior */
    .linear-gauge-container { width: 100%; height: 8px; display: flex; gap: 2px; margin-top: 10px; }
    .gauge-segment { flex: 1; background: #222; border-radius: 2px; transition: background 0.1s; }
    .gauge-segment.active { box-shadow: 0 0 8px currentColor; }

    /* Columna Derecha: Datos Cr√≠ticos */
    .data-col {
        display: flex; flex-direction: column; align-items: flex-end; text-align: right;
        justify-content: flex-start; padding-top: 10px; gap: 5px;
    }

    .phase-label { font-size: 0.9rem; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 5px;}
    
    /* CRON√ìMETRO */
    .timer-val { 
        font-size: 3.5rem; font-weight: 700; color: white; line-height: 0.9; 
        font-family: 'Courier New', Courier, monospace; 
        letter-spacing: -2px;
    }
    
    /* OBJETIVO (Justo debajo del timer) */
    .target-group { 
        display: flex; flex-direction: column; align-items: flex-end; 
        margin-top: 5px; padding-right: 2px;
    }
    .target-val { 
        font-size: 2.5rem; font-weight: 800; color: var(--accent-color); 
        line-height: 0.9; 
    }
    .target-lbl { 
        font-size: 0.6rem; color: #888; text-transform: uppercase; letter-spacing: 2px; 
    }
    
    /* ACTUAL SPM (Flotante o abajo) */
    .current-spm-group {
        position: absolute; bottom: 20px; right: 20px;
        text-align: right;
    }
    .current-spm-val { font-size: 4rem; font-weight: 900; line-height: 1; color: white; }
    .current-spm-lbl { display: block; font-size: 0.7rem; color: var(--primary-color); font-weight: bold;}

    /* Feedback Visual (Flechita) */
    .feedback-overlay {
        position: absolute; top: 10px; left: 10px;
        display: flex; align-items: center; gap: 8px;
        background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px;
    }
    .fb-arrow { font-size: 1.5rem; font-weight: bold; }
    .fb-text { font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }

    /* Barra de Progreso Intervalo */
    .int-progress-bar { height: 4px; background: #333; width: 100%; position: absolute; bottom: 0; left: 0;}
    .int-progress-fill { height: 100%; background: var(--secondary-color); width: 100%; transition: width 1s linear; }

    /* Colores Din√°micos */
    .state-slow { color: var(--guide-slow); } .border-slow { border-color: var(--guide-slow); }
    .state-fast { color: var(--guide-fast); } .border-fast { border-color: var(--guide-fast); }
    .state-good { color: var(--guide-good); } .border-good { border-color: var(--guide-good); }

    /* === DATA GRID INFERIOR (M√©tricas) === */
    .dashboard {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px;
        background: #333; width: 100%; height: auto; flex-shrink: 0;
    }
    .metric-card {
        background: var(--card-color); padding: 15px 5px; text-align: center;
        display: flex; flex-direction: column; justify-content: center;
    }
    .metric-card .label{font-size:0.6rem; color:#888; text-transform: uppercase; margin-bottom: 2px;}
    .metric-card .value{font-size:1.1rem; font-weight:bold; color:var(--text-color);}
    .metric-card .unit{font-size:0.6rem; color:#666; margin-left: 2px;}
    
    /* === BOTONES DE CONTROL (BARRA INFERIOR) === */
    .controls-container {
        padding: 15px; width: 100%; box-sizing: border-box;
        background: rgba(0,0,0,0.8);
        position: absolute; bottom: 0; left: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        z-index: 100;
        display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
    }
    /* Clase para ocultar controles */
    .controls-hidden {
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }

    button {
        padding: 12px 20px; font-size: 14px; border: none; border-radius: 8px; 
        cursor: pointer; background: #333; color: white; 
        font-weight: 600; flex: 1; min-width: 90px; max-width: 150px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    button:active { transform: scale(0.98); }
    #connect-rower-btn { background: var(--interval-bg); border: 1px solid var(--primary-color); color: var(--primary-color); }
    #connect-hr-btn { background: var(--interval-bg); border: 1px solid var(--accent-color); color: var(--accent-color); }
    #routine-btn { background: var(--secondary-color); color: black; }
    #end-session-btn { background: var(--guide-fast); color: white; }
    
    /* UTILS OCULTOS */
    #power-card .power-controls { display: none; }
    
    /* MODALES & PANTALLAS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a1e; width: 90%; max-width: 500px; border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;}
    .modal-header { padding: 15px; background: #222; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;}
    .modal-body { padding: 15px; overflow-y: auto; }
    
    .interval-row { display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 8px; margin-bottom: 8px; background: #111; padding: 8px; border-radius: 6px;}
    .interval-row input, .interval-row select { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box;}
    
    #results-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:3000; display:none; flex-direction:column; align-items:center; justify-content:center; }
    .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0; width: 90%; max-width: 400px; }
    .res-item { background: #1c1c1e; padding: 15px; border-radius: 8px; text-align: center; }
    .res-val { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); display: block;}
    
    #err-banner { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #b00020; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}

    /* Landscape Adjustments */
    @media (orientation: landscape) {
        .container { flex-direction: row; padding-top: 0; }
        header { display: none; } /* Ocultar header en landscape, usar bot√≥n flotante si se quiere */
        .status-bar { position: absolute; top: 10px; left: 20px; flex-direction: column; align-items: flex-start; gap: 5px; z-index: 10; }
        
        #interval-dashboard { height: 100vh; width: 65%; border-bottom: none; border-right: 1px solid #333; }
        .cockpit-layout { grid-template-columns: 1fr 180px; padding: 20px; }
        .dashboard { display: grid; width: 35%; height: 100vh; grid-template-columns: 1fr 1fr; align-content: center; gap: 1px;}
        .metric-card { height: 100%; border-bottom: 1px solid #222; }
        
        .timer-val { font-size: 5rem; }
        .target-val { font-size: 3.5rem; }
        .current-spm-val { font-size: 5rem; }
        
        /* Bot√≥n Fullscreen flotante en landscape */
        #fullscreen-btn-float {
            position: absolute; top: 10px; right: 10px; z-index: 200;
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; padding: 5px; border-radius: 4px;
        }
    }
  </style>
</head>
<body>

  <div id="err-banner"></div>

  <!-- Header Vertical -->
  <header>
    <h1>PANEL REMO</h1>
    <button id="fullscreen-btn">‚õ∂</button>
  </header>
  
  <!-- Bot√≥n flotante para landscape -->
  <button id="fullscreen-btn-float" style="display:none;">‚õ∂</button>

  <div class="container" id="main-screen">
    
    <!-- Secci√≥n Visual (Intervalos) -->
    <div id="interval-dashboard">
      <div class="int-progress-bar"><div class="int-progress-fill" id="int-progress-fill"></div></div>
      
      <div class="cockpit-layout">
        <!-- Izquierda: Visual -->
        <div class="viz-col">
            <div class="feedback-overlay">
                <span class="fb-arrow" id="fb-arrow">‚óè</span>
                <span class="fb-text" id="fb-msg">LISTO</span>
            </div>
            
            <div class="status-bar">
                <div id="rower-status" class="status disconnected">REMO OFF</div>
                <div id="hr-status" class="status disconnected">HR --</div>
            </div>

            <canvas id="rower-canvas" width="450" height="220"></canvas>
            <div class="linear-gauge-container" id="gauge-bar"></div>
            
            <div class="current-spm-group">
                 <span class="current-spm-val" id="int-current-spm">0</span>
                 <span class="current-spm-lbl">ACTUAL SPM</span>
            </div>
        </div>

        <!-- Derecha: Datos Objetivo -->
        <div class="data-col">
            <div class="phase-label" id="int-phase-name">CALENTAMIENTO</div>
            
            <!-- CRON√ìMETRO -->
            <div class="timer-val" id="int-timer">00:00</div>
            
            <!-- OBJETIVO DEBAJO DEL TIEMPO -->
            <div class="target-group">
                <span class="target-val" id="int-target-spm">20</span>
                <span class="target-lbl">OBJETIVO SPM</span>
            </div>

            <div style="margin-top:auto; opacity: 0.5; font-size: 0.7rem;">
                <div id="int-step-count">1 / 4</div>
                <div id="next-interval-preview" style="margin-top:5px; color:#aaa"></div>
            </div>
        </div>
      </div>
    </div>

    <!-- Data Grid (Siempre visible, pero menos prominente) -->
    <div class="dashboard">
        <div class="metric-card"><span class="label">Ritmo</span><span class="value" id="stroke-rate">0</span><span class="unit">SPM</span></div>
        <div class="metric-card" id="hr-card"><span class="label">Pulso</span><span class="value" id="heart-rate">--</span><span class="unit">BPM</span></div>
        <div class="metric-card"><span class="label">Paladas</span><span class="value" id="total-strokes">0</span></div>
        <div class="metric-card"><span class="label">Dist.</span><div><span class="value" id="distance">0.00</span><span class="unit">km</span></div></div>
        
        <div class="metric-card" id="power-card">
            <span class="label">Watts</span><span class="value" id="power">0</span>
            <!-- Controles ocultos de potencia -->
            <div class="power-controls"><select id="power-mode"><option value="equiv">Eq</option></select><input id="corr-factor" value="7.2"></div>
        </div>
        <div class="metric-card"><span class="label">Tiempo</span><span class="value" id="duration">00:00</span></div>
        <div class="metric-card"><span class="label">Cal</span><span class="value" id="calories">0</span></div>
        <div class="metric-card"><span class="label">Pace</span><span class="value" id="pace">--:--</span></div>
    </div>

    <!-- BOTONES DE CONTROL (Se ocultan al iniciar) -->
    <div class="controls-container" id="controls-bar">
      <button id="connect-rower-btn">üîó Remo</button>
      <button id="connect-hr-btn">‚ù§Ô∏è HR</button>
      <button id="routine-btn">‚ö° Rutina</button>
      <button id="end-session-btn">‚èπ Finalizar</button>
      <button id="export-btn" disabled>‚¨á CSV</button>
    </div>

  </div>

  <!-- PANTALLA RESULTADOS -->
  <div id="results-screen">
    <h2 style="color:white; letter-spacing:2px;">RESUMEN SESI√ìN</h2>
    <div class="res-grid">
      <div class="res-item"><span class="label">TIEMPO</span><span class="res-val" id="res-duration">00:00</span></div>
      <div class="res-item"><span class="label">DISTANCIA</span><span class="res-val" id="res-distance">0.00 km</span></div>
      <div class="res-item"><span class="label">CALOR√çAS</span><span class="res-val" id="res-calories">0 kcal</span></div>
      <div class="res-item"><span class="label">RITMO MED</span><span class="res-val" id="res-avg-spm">0 SPM</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="download-report-btn" disabled style="background:var(--secondary-color); color:black">Guardar Datos</button>
        <button id="new-session-btn" style="background:#444">Nueva Sesi√≥n</button>
    </div>
  </div>

  <!-- MODAL RUTINA -->
  <div class="modal-overlay" id="routine-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 style="color:white;margin:0">Editor Rutina</h3><span id="close-modal" style="cursor:pointer;color:#888;font-size:24px">&times;</span></div>
      <div class="modal-body">
        <div style="margin-bottom:15px"><label style="color:#aaa;font-size:11px">NOMBRE</label><input type="text" id="routine-name" style="background:#333;border:none;color:white;padding:10px;border-radius:6px;width:100%;box-sizing:border-box" placeholder="Ej: Tabata"></div>
        <div style="margin-bottom:10px; display:flex; justify-content:space-between;"><label style="color:#aaa;font-size:11px">INTERVALOS (Seg / SPM / Tipo)</label></div>
        <div id="intervals-container"></div>
        <button id="add-interval-btn" style="width:100%;background:#333;color:var(--primary-color);padding:10px;border:1px dashed #555;margin-top:10px">+ Agregar Intervalo</button>
      </div>
      <div style="padding:15px;border-top:1px solid #333;display:flex;justify-content:space-between">
        <button id="cancel-routine-btn" style="background:transparent;border:1px solid #555;color:#aaa">Cancelar</button>
        <button id="start-routine-btn" style="background:var(--guide-good);color:black;font-weight:bold;">INICIAR RUTINA</button>
      </div>
    </div>
  </div>

  <script>
    /* ----------------- L√≥gica de Interfaz y Utilidades ----------------- */
    const dom = {
      main: document.getElementById('main-screen'),
      controls: document.getElementById('controls-bar'),
      dashboard: document.getElementById('interval-dashboard'),
      fullScreenBtn: document.getElementById('fullscreen-btn'),
      fullScreenFloat: document.getElementById('fullscreen-btn-float'),
      // Text Elements
      timer: document.getElementById('int-timer'),
      targetSpm: document.getElementById('int-target-spm'),
      currentSpm: document.getElementById('int-current-spm'),
      phaseName: document.getElementById('int-phase-name'),
      stepCount: document.getElementById('int-step-count'),
      nextPrev: document.getElementById('next-interval-preview'),
      fbArrow: document.getElementById('fb-arrow'),
      fbMsg: document.getElementById('fb-msg'),
      progressFill: document.getElementById('int-progress-fill'),
      gauge: document.getElementById('gauge-bar'),
      // Buttons
      btnConnectRower: document.getElementById('connect-rower-btn'),
      btnConnectHr: document.getElementById('connect-hr-btn'),
      btnRoutine: document.getElementById('routine-btn'),
      btnEnd: document.getElementById('end-session-btn'),
      btnExport: document.getElementById('export-btn'),
      // Metric fields
      mRate: document.getElementById('stroke-rate'),
      mHr: document.getElementById('heart-rate'),
      mDist: document.getElementById('distance'),
      mTime: document.getElementById('duration'),
      mCal: document.getElementById('calories'),
      mPace: document.getElementById('pace'),
      mStr: document.getElementById('total-strokes'),
      mPow: document.getElementById('power'),
      // Modals
      modal: document.getElementById('routine-modal'),
      resScreen: document.getElementById('results-screen')
    };

    const formatMMSS = s => {const m=Math.floor(s/60),sec=Math.round(s%60); return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`};
    const updateText = (id,t) => { const el=document.getElementById(id); if(el) el.textContent=t; };
    const showError = m => { const b=document.getElementById('err-banner'); b.innerText=m; b.style.display='block'; setTimeout(()=>b.style.display='none',4000); };

    /* --- PANTALLA COMPLETA --- */
    function toggleFullScreen() {
        if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e=>console.log(e)); } 
        else { if(document.exitFullscreen) document.exitFullscreen(); }
    }
    dom.fullScreenBtn.onclick = toggleFullScreen;
    dom.fullScreenFloat.onclick = toggleFullScreen;
    
    // Mostrar bot√≥n flotante solo en landscape si es necesario
    window.addEventListener('resize', ()=>{
        dom.fullScreenFloat.style.display = (window.innerWidth > window.innerHeight) ? 'block' : 'none';
    });

    /* --- GESTI√ìN DE CONTROLES (OCULTAR/MOSTRAR) --- */
    let controlsTimeout;
    
    function hideControls() {
        if(!sessionActive) return; // No ocultar si no estamos entrenando
        dom.controls.classList.add('controls-hidden');
    }

    function showControls() {
        dom.controls.classList.remove('controls-hidden');
        if(controlsTimeout) clearTimeout(controlsTimeout);
        if(sessionActive) {
            controlsTimeout = setTimeout(hideControls, 4000); // Volver a ocultar tras 4s
        }
    }

    // Tocar la pantalla para mostrar controles
    document.addEventListener('click', (e) => {
        // Evitar que clicks en los botones mismos los oculten inmediatamente
        if(e.target.closest('button') || e.target.closest('.modal-content')) return;
        showControls();
    });

    /* ----------------- Bluetooth & Wake Lock (CR√çTICO: NO TOCAR L√ìGICA) ----------------- */
    let wakeLock = null;
    let connectedRower = false, connectedHr = false;
    let sessionActive = false, inIntervalMode = false;
    
    async function syncWakeLock() {
        if(document.visibilityState !== 'visible') return;
        try {
            if((connectedRower || connectedHr || sessionActive) && !wakeLock) {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', ()=> wakeLock=null);
            } else if (!connectedRower && !connectedHr && !sessionActive && wakeLock) {
                await wakeLock.release(); wakeLock=null;
            }
        } catch(e){ console.warn("WL Err", e); }
    }
    document.addEventListener('visibilitychange', syncWakeLock);

    /* ----------------- L√≥gica de Entrenamiento ----------------- */
    let sessionTimer = null, elapsedSeconds = 0;
    let activeRoutine = null, currentStepIdx = 0, stepTimeLeft = 0;
    let rawEvents = [], lastPace = 0, lastPow = 0;
    let currentSpm = 0, isRowing = false, rowingTimer = null;

    // --- REMO BT ---
    dom.btnConnectRower.onclick = async () => {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters:[{services:[0x1826]}], optionalServices:[0x1826]});
            const srv = await (await dev.gatt.connect()).getPrimaryService(0x1826);
            const char = await srv.getCharacteristic(0x2AD1);
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', handleRowerData);
            connectedRower = true; updateText('rower-status', 'REMO ON'); 
            document.getElementById('rower-status').className = 'status connected';
            syncWakeLock();
        } catch(e) { showError(e.message); }
    };

    function handleRowerData(e) {
        if(!sessionActive && !sessionTimer) startSession(); // Auto-start
        const v = e.target.value;
        const flags = v.getUint16(0, true);
        let offset = 2;
        
        const spm = Math.round(v.getUint8(offset) / 2); offset += 1;
        const strokes = v.getUint16(offset, true); offset += 2;
        
        currentSpm = spm;
        updateText('stroke-rate', spm); updateText('int-current-spm', spm); updateText('total-strokes', strokes);
        checkRowing(spm);
        
        if(flags & 0x0002) offset += 1; // Avg Speed ignored
        if(flags & 0x0004) { // Dist
            const dist = v.getUint32(offset, true) & 0xFFFFFF; offset += 3;
            updateText('distance', (dist/1000).toFixed(2));
            rawEvents.push({t:elapsedSeconds, s:spm, d:dist, str:strokes});
        }
        if(flags & 0x0008) { // Pace
            const p = v.getUint16(offset, true); offset += 2;
            updateText('pace', formatMMSS(p));
        }
        if(flags & 0x0020) { // Power
             // Saltamos flags intermedios si existen, l√≥gica simplificada para ejemplo
             offset += 2; // Inst Power Int16
             const w = v.getInt16(offset, true);
             updateText('power', w);
        }
        if(flags & 0x0100) { // Cals
            // Saltamos energy/h etc si existen, vamos al final normalmente
             // Implementaci√≥n simplificada, depende del flag exacto
        }
    }

    function checkRowing(spm) {
        if(spm > 0) {
            isRowing = true;
            if(rowingTimer) clearTimeout(rowingTimer);
            rowingTimer = setTimeout(()=>{ isRowing=false; updateGauge(0); drawRower(0);}, 3500);
        }
    }

    // --- HR BT ---
    dom.btnConnectHr.onclick = async () => {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters:[{services:[0x180D]}]});
            const char = await (await (await dev.gatt.connect()).getPrimaryService(0x180D)).getCharacteristic(0x2A37);
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', e => {
                const v = e.target.value;
                const val = (v.getUint8(0) & 1) ? v.getUint16(1, true) : v.getUint8(1);
                updateText('heart-rate', val);
                document.getElementById('hr-status').innerText = "HR " + val;
                document.getElementById('hr-status').className = 'status connected';
            });
            connectedHr = true; syncWakeLock();
        } catch(e) { showError(e.message); }
    };

    /* --- SESI√ìN & INTERVALOS --- */
    function startSession(routine = null) {
        if(sessionActive) return;
        sessionActive = true; 
        elapsedSeconds = 0; rawEvents = [];
        updateText('duration', '00:00');
        
        // UI Start
        dom.dashboard.style.display = 'block'; // Mostrar Cockpit
        hideControls(); // Ocultar botones
        dom.btnExport.disabled = false;
        
        sessionTimer = setInterval(() => {
            if(isRowing || inIntervalMode) {
                elapsedSeconds++;
                updateText('duration', formatMMSS(elapsedSeconds));
                if(inIntervalMode) processIntervalLogic();
            }
        }, 1000);
        
        if(routine) {
            activeRoutine = routine; inIntervalMode = true;
            currentStepIdx = -1; nextInterval();
            startVisualLoop();
        }
        syncWakeLock();
    }

    function processIntervalLogic() {
        stepTimeLeft--;
        updateText('int-timer', formatMMSS(stepTimeLeft));
        const total = activeRoutine.steps[currentStepIdx].sec;
        dom.progressFill.style.width = ((total - stepTimeLeft) / total * 100) + '%';
        
        // Guidance Colors
        const target = activeRoutine.steps[currentStepIdx].spm;
        const diff = currentSpm - target;
        let color = '#00e676'; let msg = "BIEN"; let arrow = "‚óè";
        
        if(currentSpm === 0) { color = '#555'; msg = "REMA"; arrow = "‚àí"; }
        else if(diff < -2) { color = '#2979ff'; msg = "SUBE"; arrow = "‚ñ≤"; } // Muy lento
        else if(diff > 2) { color = '#ff1744'; msg = "BAJA"; arrow = "‚ñº"; } // Muy r√°pido
        
        dom.targetSpm.style.color = color;
        dom.fbArrow.innerText = arrow; dom.fbArrow.style.color = color;
        dom.fbMsg.innerText = msg;

        if(stepTimeLeft <= 0) nextInterval();
    }

    function nextInterval() {
        currentStepIdx++;
        if(currentStepIdx >= activeRoutine.steps.length) {
            finishSession(); return;
        }
        const step = activeRoutine.steps[currentStepIdx];
        stepTimeLeft = step.sec;
        updateText('int-phase-name', step.type);
        updateText('int-target-spm', step.spm);
        updateText('int-step-count', `${currentStepIdx+1} / ${activeRoutine.steps.length}`);
        
        const next = activeRoutine.steps[currentStepIdx+1];
        if(next) updateText('next-interval-preview', `LUEGO: ${next.type} @ ${next.spm}`);
        else updateText('next-interval-preview', 'FINAL');
    }

    dom.btnEnd.onclick = finishSession;
    
    function finishSession() {
        if(!sessionActive) return;
        clearInterval(sessionTimer); 
        sessionActive = false; inIntervalMode = false;
        showControls(); // Mostrar botones
        
        dom.main.style.display = 'none';
        dom.resScreen.style.display = 'flex';
        
        updateText('res-duration', formatMMSS(elapsedSeconds));
        updateText('res-distance', dom.mDist.textContent + " km");
        updateText('res-calories', dom.mCal.textContent + " kcal");
        const spms = rawEvents.map(e=>e.s).filter(x=>x>0);
        const avg = spms.length ? Math.round(spms.reduce((a,b)=>a+b,0)/spms.length) : 0;
        updateText('res-avg-spm', avg + " SPM");
        document.getElementById('download-report-btn').disabled = false;
        syncWakeLock();
    }

    /* --- RUTINAS (MODAL) --- */
    dom.btnRoutine.onclick = () => { dom.modal.style.display = 'flex'; loadRoutineUI(); };
    document.getElementById('close-modal').onclick = () => dom.modal.style.display = 'none';
    document.getElementById('cancel-routine-btn').onclick = () => dom.modal.style.display = 'none';
    
    function addIntervalInput(d={s:60, r:20, t:'Trabajo'}) {
        const div = document.createElement('div'); div.className='interval-row';
        div.innerHTML = `
            <input type="number" class="i-sec" value="${d.s}" placeholder="Seg">
            <input type="number" class="i-spm" value="${d.r}" placeholder="SPM">
            <select class="i-type"><option ${d.t=='Calentamiento'?'selected':''}>Calentamiento</option><option ${d.t=='Trabajo'?'selected':''}>Trabajo</option><option ${d.t=='Descanso'?'selected':''}>Descanso</option></select>
            <button onclick="this.parentElement.remove()" style="background:#b00020; min-width:30px; padding:5px;">&times;</button>
        `;
        document.getElementById('intervals-container').appendChild(div);
    }
    
    document.getElementById('add-interval-btn').onclick = () => addIntervalInput();
    
    function loadRoutineUI() {
        const c = document.getElementById('intervals-container'); c.innerHTML='';
        const last = JSON.parse(localStorage.getItem('myRoutine'));
        if(last) {
            document.getElementById('routine-name').value = last.name;
            last.steps.forEach(s => addIntervalInput(s));
        } else {
            addIntervalInput({s:300, r:18, t:'Calentamiento'});
            addIntervalInput({s:60, r:24, t:'Trabajo'});
        }
    }
    
    document.getElementById('start-routine-btn').onclick = () => {
        const rows = document.querySelectorAll('.interval-row');
        const steps = Array.from(rows).map(r => ({
            sec: parseInt(r.querySelector('.i-sec').value),
            spm: parseInt(r.querySelector('.i-spm').value),
            type: r.querySelector('.i-type').value
        }));
        const name = document.getElementById('routine-name').value;
        localStorage.setItem('myRoutine', JSON.stringify({name, steps}));
        dom.modal.style.display = 'none';
        startSession({name, steps});
    };

    /* --- VISUALES (CANVAS & GAUGE) --- */
    const ctx = document.getElementById('rower-canvas').getContext('2d');
    const gauge = dom.gauge;
    // Crear segmentos del gauge
    for(let i=0; i<20; i++) {
        const s = document.createElement('div'); s.className = 'gauge-segment';
        s.style.background = (i<6)?'#2979ff':(i<14)?'#00e676':'#ff1744'; // Azul -> Verde -> Rojo
        s.style.opacity = '0.2';
        gauge.appendChild(s);
    }
    
    function updateGauge(phase) { // Phase 0 to 1
        const max = 20; const active = Math.floor(phase * max);
        Array.from(gauge.children).forEach((s, i) => {
            s.style.opacity = (i <= active) ? '1' : '0.2';
            s.style.boxShadow = (i <= active) ? '0 0 5px currentColor' : 'none';
        });
    }

    let animFrame;
    function startVisualLoop() {
        if(animFrame) cancelAnimationFrame(animFrame);
        const loop = () => {
            if(!sessionActive || !inIntervalMode) return;
            const target = activeRoutine.steps[currentStepIdx].spm;
            // Metr√≥nomo visual basado en tiempo
            const msPerStroke = (60/target) * 1000;
            const now = Date.now();
            const progress = (now % msPerStroke) / msPerStroke; // 0 a 1 c√≠clico
            
            // Simular fase de remada (Drive ~35%, Recovery ~65%)
            let visualPhase = 0;
            if(progress < 0.4) visualPhase = progress / 0.4; // Drive 0->1
            else visualPhase = 1 - ((progress - 0.4) / 0.6); // Recovery 1->0
            
            if(isRowing) {
                drawRower(Math.max(0, visualPhase));
                updateGauge(progress); // Gauge llena el ciclo completo
            }
            animFrame = requestAnimationFrame(loop);
        };
        loop();
    }

    function drawRower(pos) { // pos 0 (catch) to 1 (finish)
        const w = ctx.canvas.width, h = ctx.canvas.height;
        ctx.clearRect(0,0,w,h);
        
        // Colores
        const color = isRowing ? '#00e676' : '#555';
        ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 10; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        
        const scale = 0.8;
        const cx = w/2, cy = h*0.8;
        const slide = 150 * scale;
        
        // Puntos b√°sicos
        const foot = {x: cx - 100*scale, y: cy};
        const seat = {x: foot.x + (50*scale) + (slide*pos), y: cy - 10};
        const knee = {x: (foot.x + seat.x)/2, y: cy - (40*scale)*(1-pos)};
        
        // Cuerpo (se inclina atr√°s al final)
        const lean = -0.2 + (pos * 0.5); // Radianes
        const torsoLen = 90 * scale;
        const shoulder = {x: seat.x + Math.sin(lean)*torsoLen, y: seat.y - Math.cos(lean)*torsoLen};
        const head = {x: shoulder.x + Math.sin(lean)*20, y: shoulder.y - Math.cos(lean)*20};
        
        // Brazos
        let armExt = 1; if(pos > 0.6) armExt = 1 - ((pos-0.6)*2.5); // Se doblan al final
        const hand = {x: shoulder.x - (100*scale*armExt), y: shoulder.y + 30*scale};
        
        // Dibujo
        ctx.beginPath(); ctx.moveTo(cx-140*scale, cy+10); ctx.lineTo(cx+140*scale, cy+10); ctx.strokeStyle='#333'; ctx.lineWidth=6; ctx.stroke(); // Riel
        
        ctx.strokeStyle = color; ctx.lineWidth=12;
        ctx.beginPath();
        ctx.moveTo(foot.x, foot.y); ctx.lineTo(knee.x, knee.y); ctx.lineTo(seat.x, seat.y); // Piernas
        ctx.moveTo(seat.x, seat.y); ctx.lineTo(shoulder.x, shoulder.y); // Torso
        ctx.stroke();
        
        ctx.beginPath(); ctx.arc(head.x, head.y, 12*scale, 0, Math.PI*2); ctx.fill(); // Cabeza
        
        ctx.lineWidth=10; ctx.beginPath(); ctx.moveTo(shoulder.x, shoulder.y); ctx.lineTo(hand.x, hand.y); ctx.stroke(); // Brazos
        
        // Mango remo
        ctx.lineWidth=4; ctx.strokeStyle='#aaa'; ctx.beginPath(); ctx.moveTo(hand.x, hand.y); ctx.lineTo(cx-150*scale, hand.y); ctx.stroke();
    }
    
    /* --- EXPORT CSV --- */
    dom.btnExport.onclick = () => {
        let csv = "Time,SPM,Dist,Strokes\n" + rawEvents.map(e=>`${e.t},${e.s},${e.d},${e.str}`).join("\n");
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv])); a.download = 'remo.csv'; a.click();
    };
    document.getElementById('download-report-btn').onclick = dom.btnExport.onclick;
    document.getElementById('new-session-btn').onclick = () => { dom.resScreen.style.display='none'; dom.main.style.display='flex'; updateText('duration','00:00'); };

    // Init
    drawRower(0);
  </script>
</body>
</html>
