<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Remo</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #03dac6;
            --secondary-color: #bb86fc;
            --accent-color: #cf6679;
            --success-color: #4caf50; /* Color para el estado activo */
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; overflow-y: auto; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; }
        header { text-align: center; padding: 10px 0; }
        h1 { font-size: 1.5rem; margin: 0; }
        .buttons { display: flex; justify-content: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        button {
            padding: 10px 20px; font-size: 14px; border: none; border-radius: 8px; cursor: pointer;
            background-color: var(--primary-color); color: var(--bg-color); font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #33fff0; }
        button#end-session-btn { background-color: var(--accent-color); }
        .status-bar {
            display: flex; justify-content: space-around; background-color: var(--card-color);
            padding: 8px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; text-align: center;
        }
        .connected { color: var(--primary-color); }
        .disconnected { color: var(--accent-color); }
        /* NUEVO: Estilo para el estado del Wake Lock dentro de la barra de estado */
        #wakelock-status { font-size: 12px; text-align: center; margin-bottom: 10px; }
        #wakelock-status.active { color: var(--success-color); font-weight: bold; }
        .dashboard { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .metrics-row { display: flex; gap: 10px; justify-content: center; }
        .metric-card {
            background-color: var(--card-color); padding: 15px 10px; border-radius: 12px;
            text-align: center; display: flex; flex-direction: column; justify-content: center; flex: 1;
        }
        .metric-card .label { font-size: 0.9rem; margin-bottom: 5px; color: var(--secondary-color); }
        .metric-card .value { font-size: 2.6rem; font-weight: bold; color: var(--primary-color); line-height: 1.1; }
        .metric-card .unit { font-size: 0.9rem; margin-left: 5px; }
        #results-screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--bg-color); padding: 20px; box-sizing: border-box;
            width: 100%; min-height: 100vh; position: absolute; top: 0; left: 0;
        }
        #results-screen h2 { margin-top: 0; color: var(--primary-color); }
        .results-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;
            max-width: 400px; margin-bottom: 30px;
        }
        .result-item { text-align: center; }
        .result-item .label { font-size: 1rem; color: var(--secondary-color); }
        .result-item .value { font-size: 1.8rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container" id="main-screen">
        <header><h1>Panel de Control de Remo</h1></header>
        <div class="buttons">
            <button id="connect-rower-btn">Conectar al Remo</button>
            <button id="connect-hr-btn">Conectar Pulsómetro</button>
            <button id="end-session-btn">Finalizar Sesión</button>
        </div>
        <div class="status-bar">
            <div id="rower-status" class="status disconnected">Remo: Desconectado</div>
            <div id="hr-status" class="status disconnected">Pulsómetro: Desconectado</div>
        </div>
        
        <!-- NUEVO: Indicador de estado del Wake Lock (sin botón) -->
        <div id="wakelock-status">Pantalla: se apagará automáticamente</div>

        <div class="dashboard">
            <!-- ... (resto del dashboard sin cambios) ... -->
        </div>
    </div>
    
    <div id="results-screen">
        <!-- ... (código de resultados sin cambios) ... -->
    </div>

    <!-- Video de respaldo para mantener la pantalla activa (sin cambios) -->
    <video id="wake-lock-video" loop playsinline muted style="display:none;">
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNU05WAAACAE1TTlYAAAOUbW9vdgAAAGxtdmhkAAAAAIAE/4EAAPUAAAWsAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAQAAAAAAQAE/gQAA8QAAQAcubWRpYQAAACBtZGhkAAAAAIAE/4EAAPUAALXEAAAAAAA1aGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAAAAAAGtaWRlbyBtZWRpYSBoYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEsc3RibAAAAPhzdHNkAAAAAAAAAAEAAAB+YXZjMQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQABAEMjMSAAAAAAEgAAABgAAAAAAAA/4//gABhZ2F2Y0MBQsA/gAP/4QAeZ2NmY2CUZqxwP/H8/wMAAgADAAgAPFgCAAEsWcH//4QAEHFzcHMIAAUGbAKC/wAAAwAEAAj//4QANXBwc0gACFAAAAMAAgAAAA+gAAAAJHN0dHMAAAAAAAAAAQAAAAEAAQAAAAA5c3RzcwAAAAAAAAABAAAAAQAAABRzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAAYc3RzegAAAAAAAAABAAAAEQAAABRzdGNvAAAAAAAAAAEAAAAsAAAAVG1kYXQ=" type="video/mp4">
    </video>

    <script>
        const FTMS_SERVICE_UUID = 0x1826;
        const ROWER_DATA_CHARACTERISTIC_UUID = 0x2AD1;
        const HEART_RATE_SERVICE_UUID = 'heart_rate';
        const HEART_RATE_MEASUREMENT_CHARACTERISTIC_UUID = 'heart_rate_measurement';

        const dom = {
            connectRowerBtn: document.getElementById('connect-rower-btn'),
            connectHrBtn: document.getElementById('connect-hr-btn'),
            endSessionBtn: document.getElementById('end-session-btn'),
            newSessionBtn: document.getElementById('new-session-btn'),
            rowerStatus: document.getElementById('rower-status'),
            hrStatus: document.getElementById('hr-status'),
            mainScreen: document.getElementById('main-screen'),
            resultsScreen: document.getElementById('results-screen'),
            wakeLockStatus: document.getElementById('wakelock-status'),
            wakeLockVideo: document.getElementById('wake-lock-video'),
        };

        let sessionTimer = null;
        let elapsedSeconds = 0;
        let sessionData = {};
        let screenWakeLock = null;

        function initSessionData() {
            sessionData = { totalSPM: 0, spmReadings: 0 };
        }
        initSessionData();
        
        dom.connectRowerBtn.addEventListener('click', async () => {
            // NUEVO: Solicitar el Wake Lock INMEDIATAMENTE después del clic.
            // Esto maximiza la probabilidad de que el navegador lo apruebe.
            await requestWakeLock();

            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [FTMS_SERVICE_UUID] }] });
                device.addEventListener('gattserverdisconnected', onRowerDisconnected);
                const server = await device.gatt.connect();
                updateRowerStatus(true, device.name);
                const service = await server.getPrimaryService(FTMS_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(ROWER_DATA_CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleRowerData);
            } catch (error) {
                console.error('Error al conectar con el remo:', error);
                alert(`No se pudo conectar al remo: ${error.message}`);
                // Si la conexión falla, liberamos el wakelock que solicitamos
                await releaseWakeLock();
                updateRowerStatus(false);
            }
        });

        dom.connectHrBtn.addEventListener('click', async () => { 
             try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [HEART_RATE_SERVICE_UUID] }] });
                device.addEventListener('gattserverdisconnected', onHrDisconnected);
                const server = await device.gatt.connect();
                updateHrStatus(true, device.name);
                const service = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(HEART_RATE_MEASUREMENT_CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
            } catch (error) {
                console.error('Error al conectar con el pulsómetro:', error);
                alert(`No se pudo conectar al pulsómetro: ${error.message}`);
                updateHrStatus(false);
            }
        });

        function handleRowerData(event) {
            if (!sessionTimer) startTimer();
            parseRowerData(event.target.value);
        }

        // --- GESTIÓN DE PANTALLA ENCENDIDA (VERSIÓN FINAL) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    screenWakeLock = await navigator.wakeLock.request('screen');
                    updateWakeLockStatus(true);
                    screenWakeLock.addEventListener('release', () => {
                        updateWakeLockStatus(false, " (liberado por el sistema)");
                        screenWakeLock = null;
                    });
                } catch (err) {
                    console.error(`Wake Lock falló: ${err.name}, ${err.message}`);
                    updateWakeLockStatus(false, ` (API denegada, usando video)`);
                }
            } else {
                console.warn('Wake Lock API no soportada.');
                updateWakeLockStatus(false, " (API no soportada, usando video)");
            }
        }

        async function releaseWakeLock() {
            if (screenWakeLock) {
                await screenWakeLock.release();
                screenWakeLock = null;
                updateWakeLockStatus(false);
            }
        }

        function updateWakeLockStatus(isActive, message = "") {
            if (isActive) {
                dom.wakeLockStatus.textContent = 'Pantalla: Se mantendrá encendida';
                dom.wakeLockStatus.classList.add('active');
            } else {
                dom.wakeLockStatus.textContent = `Pantalla: se apagará automáticamente${message}`;
                dom.wakeLockStatus.classList.remove('active');
            }
        }

        function startTimer() {
            if (sessionTimer) return;
            // El video hack ahora es solo un respaldo silencioso
            dom.wakeLockVideo.play().catch(e => console.log("Video no pudo iniciar."));
            sessionTimer = setInterval(() => {
                elapsedSeconds++;
                document.getElementById('duration').textContent = formatTime(elapsedSeconds);
            }, 1000);
        }

        function stopTimer() { 
            clearInterval(sessionTimer); 
            sessionTimer = null; 
            dom.wakeLockVideo.pause();
        }

        // --- Limpieza de recursos al finalizar o desconectar ---
        dom.endSessionBtn.addEventListener('click', () => {
            if (!sessionTimer) { alert("No hay una sesión activa."); return; }
            stopTimer();
            releaseWakeLock(); // Liberar API
            // ... mostrar resultados ...
        });
        
        function onRowerDisconnected() {
            updateRowerStatus(false);
            stopTimer();
            releaseWakeLock(); // Liberar API
            alert("El remo se ha desconectado.");
            resetUI();
            initSessionData();
        }
        
        function resetUI() {
            stopTimer();
            releaseWakeLock(); // Liberar API
            elapsedSeconds = 0;
            // ... resetear valores del DOM ...
        }

        // ... (resto de funciones: parseRowerData, handleHeartRateData, formatTime, etc., sin cambios) ...
    </script>
</body>
</html>
