<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Panel Remo PRO - V7.4 Standard WakeLock</title>
  <style>
    :root{
      --bg-color:#121212; --card-color:#1e1e1e; --text-color:#e0e0e0;
      --primary-color:#03dac6; --secondary-color:#bb86fc; --accent-color:#cf6679;
      --interval-bg:#1a2639; --interval-text:#ffffff; 
      --guide-fast:#f44336; --guide-slow:#2196f3; --guide-good:#4caf50;
      --target-color: #00e676;
      /* Colores Zonas HR */
      --hr-z1: #29b6f6; --hr-z2: #66bb6a; --hr-z3: #ffee58; --hr-z4: #ffa726; --hr-z5: #ef5350;
    }
    
    html,body{height:100%; margin:0; padding:0; overflow:hidden;}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      display:flex;
      flex-direction:column;
      align-items:center;
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.3s;
    }

    /* === ESTRUCTURA PRINCIPAL === */
    .container {
      width: 100%; height: 100%; 
      display: flex; flex-direction: column; 
      position: relative; 
      padding: 10px;
      overflow-y: auto;
    }
    
    header{
        text-align:center; padding:5px 10px; flex-shrink: 0; 
        display: flex; justify-content: space-between; align-items: center;
        position: relative; height: 40px;
    }
    h1{font-size:1.2rem; margin:0; opacity: 0.8; flex-grow: 1; text-align: center;}
    
    #fs-toggle {
        background: none; border: none; color: var(--text-color);
        font-size: 1.5rem; cursor: pointer; padding: 5px;
        opacity: 0.7; z-index: 10;
    }

    /* Status Bar */
    .status-bar{
        display:flex; justify-content:space-between; 
        background:var(--card-color); padding:6px 12px; 
        border-radius:6px; margin-bottom:10px; 
        font-size:10px; text-align:center; gap: 5px; flex-shrink: 0;
    }
    .connected{color:var(--primary-color); font-weight: bold;} .disconnected{color:var(--accent-color);}

    /* === DASHBOARD DE INTERVALOS (HUMANOIDE) === */
    #interval-dashboard {
        display: none; 
        background: var(--interval-bg);
        border: 2px solid #444;
        border-radius: 12px;
        padding: 10px 15px;
        flex-direction: column;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden; 
        transition: border-color 0.3s ease;
        flex-shrink: 0;
    }
    
    .dash-slow { border-color: var(--guide-slow) !important; box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.2); }
    .dash-fast { border-color: var(--guide-fast) !important; box-shadow: inset 0 0 20px rgba(244, 67, 54, 0.2); }
    .dash-good { border-color: var(--guide-good) !important; box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.2); }

    .int-header { 
        display: flex; justify-content: space-between; align-items: flex-start; 
        margin-bottom: 5px; z-index: 5; position: relative;
    }
    .int-phase-info { display: flex; flex-direction: column; max-width: 50%; }
    .int-phase-name { font-size: 1.1rem; font-weight: 900; color: white; font-style: italic; text-transform: uppercase; line-height: 1.1; text-shadow: 0 2px 4px rgba(0,0,0,0.5);}
    .int-step-count { background: #0f1724; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; color: #aaa; font-weight: bold; margin-top: 4px; width: fit-content; }
    
    .int-motivation {
        font-size: 0.85rem; font-weight: 800; 
        margin-top: 5px; letter-spacing: 0.5px;
        text-shadow: 0 1px 2px black;
        min-height: 1.2em;
        transition: color 0.3s;
    }
    
    .int-right-block { 
        display: flex; flex-direction: column; align-items: flex-end; 
        background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px;
    }
    .int-timer-big { font-size: 2.2rem; font-weight: bold; color: white; line-height: 0.9; font-family: monospace; letter-spacing: -1px;}
    
    .int-target-wrapper {
        display: flex; align-items: baseline; gap: 4px; margin-top: 2px;
    }
    .int-target-val { font-size: 1.4rem; font-weight: 900; color: var(--target-color); line-height: 1; }
    .int-target-lbl { font-size: 0.6rem; color: #aaa; text-transform: uppercase; font-weight: bold; }

    .int-total-remain {
        font-size: 0.75rem; color: #bbb; margin-top: 4px; 
        font-family: monospace; background: rgba(0,0,0,0.3);
        padding: 1px 5px; border-radius: 4px;
    }

    .int-main-visual { 
        display: grid; grid-template-columns: 1fr; gap: 5px;
        align-items: center; position: relative; z-index: 2;
    }

    .center-viz-container { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
    .rower-container { position: relative; width: 100%; display: flex; justify-content: center; align-items: flex-end; }
    
    canvas#rower-canvas {
        width: 100% !important; height: auto !important;
        max-width: 400px; aspect-ratio: 450/220;
    }

    .int-guidance { 
        position: relative; text-align: center; display: flex; flex-direction: row; 
        align-items: center; justify-content: center; gap: 10px;
        background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 20px; 
        width: fit-content; margin: 0 auto 5px auto;
    }
    .int-arrow { font-size: 1.5rem; line-height: 1; transition: all 0.3s ease; }
    .int-guidance-text { font-weight: 900; font-size: 0.9rem; letter-spacing: 1px;}

    .int-actual-row { 
        display: flex; justify-content: center; align-items: baseline; gap: 5px; 
        margin-top: 0px; position: absolute; bottom: 10px; right: 10px;
    }
    .int-actual-num { font-size: 1.5rem; font-weight: bold; color: white; line-height: 1; }
    .int-actual-lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; }
    
    .next-interval-box { 
        position: absolute; bottom: 10px; left: 10px;
        background: rgba(255,255,255,0.1); padding: 4px 8px; 
        border-radius: 4px; border-left: 3px solid #555; text-align: left; 
    }
    .next-lbl { font-size: 0.5rem; color: #aaa; text-transform: uppercase; display: block;}
    .next-val { font-size: 0.75rem; color: white; font-weight: bold;}

    /* VISUALES MEJORADOS (Gauge y Progreso) */
    .linear-gauge-container { 
        width: 95%; height: 22px; display: flex; gap: 2px; margin-top: 5px; 
    }
    .gauge-segment { 
        flex: 1; background: #333; border-radius: 2px; 
        transition: background 0.1s, box-shadow 0.1s, transform 0.1s; 
    }
    .gauge-segment.active { opacity: 1; box-shadow: 0 0 8px currentColor; }
    
    @keyframes pulse-limit {
        0% { transform: scale(1); filter: brightness(1.2); }
        50% { transform: scale(1.3); filter: brightness(1.8); z-index: 10; }
        100% { transform: scale(1); filter: brightness(1.2); }
    }
    .gauge-segment.limit-active {
        animation: pulse-limit 0.25s ease-out forwards;
        box-shadow: 0 0 15px currentColor !important;
    }

    .int-progress-container { 
        width: 100%; height: 14px; background: #0f1724; border-radius: 7px; margin-top: 5px;
        overflow: hidden;
    }
    .int-progress-bar { 
        height: 100%; 
        background: linear-gradient(90deg, #2196f3 0%, #ff9800 100%);
        width: 100%; transition: width 1s linear; 
        box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
    }

    .guide-up { color: var(--guide-slow); } .guide-down { color: var(--guide-fast); } .guide-ok { color: var(--guide-good); } 

    /* === M√âTRICAS (DATA GRID) === */
    .dashboard { display:flex; flex-direction:column; gap:8px; width:100%; flex: 1; }
    .metrics-row { display:flex; gap:8px; justify-content:center; flex-wrap: wrap; }
    .metric-card {
        background:var(--card-color); padding:8px; border-radius:8px; text-align:center;
        display:flex; flex-direction:column; justify-content:center;
        flex: 1 1 30%; min-width: 80px; 
    }
    .metric-card .label{font-size:.6rem; color:var(--secondary-color); text-transform: uppercase;}
    .metric-card .value{font-size:1.3rem; font-weight:bold; color:var(--primary-color);}
    .metric-card .unit{font-size:.6rem; color: #888;}
    
    .hr-z1 { color: var(--hr-z1) !important; } .hr-z2 { color: var(--hr-z2) !important; }
    .hr-z3 { color: var(--hr-z3) !important; } .hr-z4 { color: var(--hr-z4) !important; }
    .hr-z5 { color: var(--hr-z5) !important; }

    .card-pulse { animation: pulse-card 1s infinite; }
    @keyframes pulse-card { 0% { box-shadow: 0 0 0 0 rgba(255,255,255, 0.1); } 70% { box-shadow: 0 0 0 6px rgba(255,255,255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255, 0); } }

    /* === CONTROLES === */
    .buttons-container {
        display:flex; justify-content:center; gap:8px; margin:5px 0 10px 0; 
        flex-wrap:wrap; flex-shrink: 0; width: 100%;
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .buttons-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); height: 0; margin: 0; overflow: hidden; }

    button{
        padding:12px 14px; font-size:13px; border:none; border-radius:8px; 
        cursor:pointer; background:var(--primary-color); color:var(--bg-color); 
        font-weight:bold; transition:all .2s; flex: 1 1 auto; min-width: 80px;
        touch-action: manipulation; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    button:active{transform:scale(0.96);}
    button:disabled{background:#444; color:#888;}
    #end-session-btn{background:var(--accent-color); color: white;}
    #export-btn{background:var(--secondary-color);}
    #download-report-btn{background:#2aa7ff;}
    #routine-btn{background:#3f51b5; color:white;}

    #toggle-ui-fab {
        position: fixed; bottom: 20px; right: 20px;
        width: 50px; height: 50px; border-radius: 50%;
        background: rgba(255,255,255,0.15); backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.2);
        color: white; font-size: 24px; display: none;
        justify-content: center; align-items: center;
        z-index: 999; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    /* === LANDSCAPE === */
    @media (orientation: landscape) {
        body { padding: 0; overflow: hidden; }
        .container { flex-direction: row; padding: 5px; gap: 10px; height: 100vh; }
        header, h1 { display: none; } 
        #fs-toggle { position: absolute; top: 10px; right: 10px; z-index: 100; opacity: 0.5; background: rgba(0,0,0,0.5); border-radius: 4px; }
        .status-bar { position: absolute; top: 0; left: 0; right: 50px; background: rgba(0,0,0,0.5); padding: 2px 10px; z-index: 90; margin: 0; border-radius: 0; justify-content: center; gap: 20px; font-size: 9px; }
        
        #interval-dashboard { display: flex !important; width: 60%; height: 100%; margin: 0; border: none; background: #151515; justify-content: center; }
        .int-header { position: absolute; top: 25px; left: 15px; right: 15px; width: auto; }
        .int-right-block { align-items: flex-end; }
        .int-timer-big { font-size: 3.5rem; }
        .int-target-val { font-size: 2rem; }
        .int-phase-name { font-size: 1.8rem; }
        .int-motivation { font-size: 1.2rem; margin-top: 10px; }
        .int-total-remain { font-size: 1rem; margin-top: 10px; }

        .int-main-visual { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        canvas#rower-canvas { max-width: 100%; max-height: 60vh; width: auto !important; height: auto !important; }
        
        .dashboard { display: grid !important; width: 40%; height: 100%; gap: 5px; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(5, 1fr); align-content: center; overflow-y: auto; padding-top: 25px; }
        .metrics-row { display: contents; } 
        .metric-card { width: 100%; height: 100%; min-height: 0; padding: 5px; border: 1px solid #333; }
        .metric-card .value { font-size: 1.8rem; }
        .buttons-container { display: none; } 
        #toggle-ui-fab { display: flex; } 
        
        .int-actual-row { bottom: 30px; right: 30px; }
        .int-actual-num { font-size: 3rem; }
        .next-interval-box { bottom: 30px; left: 30px; }
        .int-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 12px; border-radius: 0; }
    }

    #power-card .label, #power-card .power-controls, #power-source { display: none !important; }
    
    /* Modales */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a2e; width: 95%; max-width: 500px; max-height: 95vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #444;}
    .modal-header { padding: 10px 15px; background: #16213e; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
    .interval-row { display: grid; grid-template-columns: 0.8fr 0.8fr 2fr 30px; gap: 5px; align-items: center; background: #222; padding: 8px; border-radius: 4px; margin-bottom: 5px;}
    .interval-row input, .interval-row select { width: 100%; background: #333; border: none; color: white; padding: 8px; border-radius: 4px; font-family: inherit; box-sizing: border-box;}

    #results-screen{display:none; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-color); width:100%; min-height:100vh; position:absolute; top:0; left:0; z-index:200}
    .results-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; max-width:400px; margin-bottom:20px}
    .result-item{text-align:center; background: var(--card-color); padding: 10px; border-radius: 8px;}
    
    #err-banner{position:fixed; left:10px; right:10px; bottom:20px; background:#332020; color:#ffd1d1; border:1px solid #7a2c2c; padding:10px; border-radius:8px; display:none; z-index:9999; font-size:12px; text-align: center;}
  </style>
</head>
<body>
  <div id="err-banner"></div>
  <div id="toggle-ui-fab">‚ò∞</div>

  <datalist id="preset-labels">
      <option value="Calentar">
      <option value="Trabajo">
      <option value="Sprint">
      <option value="Descanso">
      <option value="Enfriamiento">
  </datalist>

  <div class="container" id="main-screen">
    <header>
        <div style="width:24px"></div> <h1>Panel Remo PRO</h1>
        <button id="fs-toggle" title="Pantalla Completa">‚õ∂</button>
    </header>

    <div class="status-bar">
      <div id="rower-status" class="status disconnected">Remo: Desconectado</div>
      <div id="hr-status" class="status disconnected">HR: --</div>
    </div>

    <div id="interval-dashboard">
      <div class="int-header">
        <div class="int-phase-info">
          <div class="int-phase-name" id="int-phase-name">CALENTAMIENTO</div>
          <span class="int-step-count" id="int-step-count">1 / 4</span>
          <div class="int-motivation" id="int-motivation">¬°PREP√ÅRATE!</div>
        </div>
        <div class="int-right-block">
          <div class="int-timer-big" id="int-timer">00:00</div>
          <div class="int-target-wrapper">
             <span class="int-target-val" id="int-target-spm">20</span>
             <span class="int-target-lbl">SPM OBJ</span>
          </div>
          <div class="int-total-remain">
              TOTAL: <span id="total-session-time">00:00</span>
          </div>
        </div>
      </div>

      <div class="int-main-visual">
        <div class="center-viz-container">
            <div class="rower-container"><canvas id="rower-canvas" width="450" height="220"></canvas></div>
             <div class="linear-gauge-container" id="gauge-bar"></div>
        </div>
        
        <div class="int-guidance">
          <span class="int-arrow" id="int-arrow">‚àí</span>
          <div class="int-guidance-text" id="int-msg">REMA</div>
        </div>

        <div class="int-actual-row">
            <span class="int-actual-num" id="int-current-spm">0</span>
            <span class="int-actual-lbl">ACTUAL</span>
        </div>
        
        <div class="next-interval-box" id="next-interval-box" style="display:none;">
            <span class="next-lbl">LUEGO:</span>
            <span class="next-val" id="next-interval-val">--</span>
        </div>
      </div>

      <div class="int-progress-container">
        <div class="int-progress-bar" id="int-progress-bar" style="width: 100%"></div>
      </div>
    </div>

    <div class="dashboard">
      <div class="metrics-row">
        <div class="metric-card"><div class="label">Ritmo</div><div><span class="value" id="stroke-rate">0</span><span class="unit">SPM</span></div></div>
        <div class="metric-card" id="hr-card"><div class="label">Pulso</div><div><span class="value" id="heart-rate">--</span><span class="unit">BPM</span></div></div>
      </div>
      <div class="metrics-row">
        <div class="metric-card"><div class="label">Paladas</div><div class="value" id="total-strokes">0</div></div>
        <div class="metric-card"><div class="label">Distancia</div><div><span class="value" id="distance">0.00</span><span class="unit">km</span></div></div>
      </div>
      <div class="metrics-row">
        <div class="metric-card" id="power-card">
          <div class="label" style="display:block!important">Potencia</div>
          <div><span class="value" id="power">0</span><span class="unit">W</span></div>
          <div class="power-controls" style="display:none!important">
            <select id="power-mode"><option value="equiv">Equiv</option><option value="ble">BLE</option><option value="corr">Corr</option></select>
            <input id="corr-factor" type="number" step="0.1" value="7.2">
          </div>
          <div class="subtle" id="power-source">Fuente: Equiv</div>
        </div>
        <div class="metric-card"><div class="label">Tiempo</div><div class="value" id="duration">00:00</div></div>
      </div>
      <div class="metrics-row">
          <div class="metric-card"><div class="label">Calor√≠as</div><div><span class="value" id="calories">0</span><span class="unit">kcal</span></div></div>
          <div class="metric-card"><div class="label">Pace/500</div><div class="value" id="pace">--:--</div></div>
      </div>
    </div>

    <div class="buttons-container" id="main-controls">
      <button id="connect-rower-btn">üîó Remo</button>
      <button id="connect-hr-btn">‚ù§Ô∏è HR</button>
      <button id="routine-btn">‚ö° Rutina</button>
      <button id="end-session-btn">‚èπ Final</button>
      <button id="export-btn" disabled>‚¨á CSV</button>
    </div>
  </div>

  <div id="results-screen">
    <h2>Resumen Sesi√≥n</h2>
    <div class="results-grid">
      <div class="result-item"><div class="label">Tiempo</div><div class="value" id="res-duration">00:00</div></div>
      <div class="result-item"><div class="label">Distancia</div><div class="value" id="res-distance">0.00 km</div></div>
      <div class="result-item"><div class="label">Calor√≠as</div><div class="value" id="res-calories">0 kcal</div></div>
      <div class="result-item"><div class="label">Paladas</div><div class="value" id="res-strokes">0</div></div>
      <div class="result-item"><div class="label">Ritmo Med</div><div class="value" id="res-avg-spm">0 SPM</div></div>
    </div>
    <div class="buttons-container">
      <button id="download-report-btn" disabled>Guardar Datos (HTML)</button>
      <button id="new-session-btn">Nueva Sesi√≥n</button>
    </div>
  </div>

  <div class="modal-overlay" id="routine-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 style="color:white;margin:0">Editor Rutina</h3><span class="close-modal" id="close-modal" style="cursor:pointer;color:#888;font-size:24px">&times;</span></div>
      <div class="modal-body">
        <div style="margin-bottom:15px"><label style="color:#aaa;font-size:11px">NOMBRE</label><input type="text" id="routine-name" style="width:100%;box-sizing:border-box;background:#333;border:none;color:white;padding:10px;border-radius:6px" placeholder="Ej: Tabata"></div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:15px;">
            <input type="file" id="import-file" accept=".json" style="display:none" />
            <button id="btn-import-json" style="background:#555; border:1px solid #777; color:#fff; font-size:11px; padding:8px; flex:1; border-radius:4px; cursor:pointer;">üìÇ Importar JSON</button>
            <button id="btn-export-json" style="background:#555; border:1px solid #777; color:#fff; font-size:11px; padding:8px; flex:1; border-radius:4px; cursor:pointer;">üíæ Exportar JSON</button>
        </div>

        <div style="margin-bottom:10px"><label style="color:#aaa;font-size:11px">INTERVALOS</label><div id="intervals-container" style="display:flex;flex-direction:column;gap:5px;margin-top:5px"></div></div>
        <button id="add-interval-btn" style="width:100%;background:#3498db;color:white;padding:12px;border:none;border-radius:6px;cursor:pointer">+ Agregar</button>
      </div>
      <div style="padding:15px;border-top:1px solid #333;display:flex;justify-content:space-between"><button id="cancel-routine-btn" style="background:transparent;border:1px solid #555;color:#aaa">Cancelar</button><button id="start-routine-btn" style="background:#2ecc71;color:white">INICIAR</button></div>
    </div>
  </div>

  <script>
    const showError=(msg)=>{const b=document.getElementById('err-banner'); if(b){b.innerText=msg; b.style.display='block'; setTimeout(()=>b.style.display='none',5000);}};
    const formatMMSS=(s)=>{const m=Math.floor(s/60),sec=Math.max(0,Math.round(s%60));return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}
    const nowTs=()=>{const d=new Date();return `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;}
    function updateText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }

    const dom = {
      rowerStatus: document.getElementById('rower-status'), hrStatus: document.getElementById('hr-status'),
      hrCard: document.getElementById('hr-card'), connectRowerBtn: document.getElementById('connect-rower-btn'), 
      connectHrBtn: document.getElementById('connect-hr-btn'), endSessionBtn: document.getElementById('end-session-btn'), 
      routineBtn: document.getElementById('routine-btn'), exportBtn: document.getElementById('export-btn'),
      intervalDashboard: document.getElementById('interval-dashboard'), intPhaseName: document.getElementById('int-phase-name'), 
      intStepCount: document.getElementById('int-step-count'), intTimer: document.getElementById('int-timer'), 
      intArrow: document.getElementById('int-arrow'), intMsg: document.getElementById('int-msg'), 
      intTargetSpm: document.getElementById('int-target-spm'), intCurrentSpm: document.getElementById('int-current-spm'), 
      intProgressBar: document.getElementById('int-progress-bar'), nextBox: document.getElementById('next-interval-box'), 
      nextVal: document.getElementById('next-interval-val'), spmVal: document.getElementById('stroke-rate'), 
      powerVal: document.getElementById('power'), hrVal: document.getElementById('heart-rate'), 
      powerMode: document.getElementById('power-mode'), corrFactor: document.getElementById('corr-factor'), 
      mainScreen: document.getElementById('main-screen'), resultsScreen: document.getElementById('results-screen'), 
      modal: document.getElementById('routine-modal'), closeModal: document.getElementById('close-modal'), 
      addIntervalBtn: document.getElementById('add-interval-btn'), intervalsContainer: document.getElementById('intervals-container'), 
      startRoutineBtn: document.getElementById('start-routine-btn'), cancelRoutineBtn: document.getElementById('cancel-routine-btn'), 
      canvas: document.getElementById('rower-canvas'), gaugeBar: document.getElementById('gauge-bar'),
      mainControls: document.getElementById('main-controls'), fab: document.getElementById('toggle-ui-fab'),
      fsToggle: document.getElementById('fs-toggle'),
      intMotivation: document.getElementById('int-motivation'),
      totalSessionTime: document.getElementById('total-session-time')
    };

    let sessionTimer=null, elapsedSeconds=0, currentSpm=0;
    let isRowing=false, rowingTimeout=null;
    let activeRoutine=null, currentStepIndex=0, stepTimeRemaining=0, inIntervalMode=false;
    let lastPaceSeconds=null, lastPowerBle=null;
    let rawEvents = [];
    let uiHidden = false;
    let currentHeartRate = 0;
    let currentDistanceMeters = 0; 
    
    // =========================================================
    // === WAKE LOCK CLEAN (STANDARD API - DESDE APP EJEMPLO) ===
    // =========================================================
    
    let wakeLock = null;

    // Funci√≥n de solicitud basada en la app de ejemplo
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock active');
            } catch(e) {
                console.warn("Wake Lock failed:", e);
            }
        }
    }

    // Re-adquirir Wake Lock al volver a la app (Listener de App Ejemplo)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && 'wakeLock' in navigator) {
        requestWakeLock();
      }
    });

    // =========================================================

    // --- FULLSCREEN & UI ---
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
            dom.fsToggle.textContent = '‚úñ'; 
        } else {
            if (document.exitFullscreen) { document.exitFullscreen(); dom.fsToggle.textContent = '‚õ∂'; }
        }
        requestWakeLock(); // Solicitar al cambiar pantalla
    }
    dom.fsToggle.addEventListener('click', toggleFullscreen);

    function setUIFocusMode(active) {
        uiHidden = active;
        if (active) { dom.mainControls.classList.add('buttons-hidden'); dom.fab.style.display = 'flex'; } 
        else { dom.mainControls.classList.remove('buttons-hidden'); dom.fab.style.display = 'none'; }
    }
    dom.fab.addEventListener('click', () => {
        if(dom.mainControls.classList.contains('buttons-hidden')) dom.mainControls.classList.remove('buttons-hidden');
        else dom.mainControls.classList.add('buttons-hidden');
        requestWakeLock();
    });

    // --- VISUALS ---
    const SEGMENT_COUNT = 20;
    function initGauge() {
        if(!dom.gaugeBar) return; dom.gaugeBar.innerHTML = '';
        for (let i = 0; i < SEGMENT_COUNT; i++) {
            const seg = document.createElement('div'); seg.className = 'gauge-segment inactive';
            let color = '#4caf50'; 
            if (i >= 5) color = '#ffeb3b'; if (i >= 10) color = '#ff9800'; if (i >= 15) color = '#f44336'; 
            seg.dataset.color = color; dom.gaugeBar.appendChild(seg);
        }
    }
    function updateGauge(phase, isDrive) {
        if(!dom.gaugeBar) return;
        const segments = dom.gaugeBar.children;
        const activeCount = Math.floor(phase * SEGMENT_COUNT);
        for (let i = 0; i < SEGMENT_COUNT; i++) {
            const seg = segments[i];
            const isActive = (isDrive && i <= activeCount) || (!isDrive && i <= activeCount);
            seg.className = isActive ? 'gauge-segment active' : 'gauge-segment inactive';
            seg.style.background = isActive ? seg.dataset.color : '';
            if (isActive) {
                if (i === 0 && activeCount <= 1) seg.classList.add('limit-active');
                else if (i === SEGMENT_COUNT - 1) seg.classList.add('limit-active');
            }
        }
    }

    const ctx = dom.canvas.getContext('2d'); let animFrame = null; let lastBeepTime = 0;
    let secondBeepPlayed = false;

    function lerpColor(a, b, amount) {
        const ar = a >> 16, ag = a >> 8 & 0xff, ab = a & 0xff;
        const br = b >> 16, bg = b >> 8 & 0xff, bb = b & 0xff;
        return '#' + ((1 << 24) + ((ar + amount * (br - ar)) << 16) + ((ag + amount * (bg - ag)) << 8) + ((ab + amount * (bb - ab)) | 0)).toString(16).slice(1);
    }
    function drawRower(phase, isDrive = true) {
        if(!ctx) return;
        const dpr = window.devicePixelRatio || 1; const rect = dom.canvas.getBoundingClientRect();
        if(dom.canvas.width !== Math.floor(rect.width * dpr) || dom.canvas.height !== Math.floor(rect.height * dpr)){
             dom.canvas.width = rect.width * dpr; dom.canvas.height = rect.height * dpr;
             ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
        }
        ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
        ctx.save();
        const globalScale = Math.min(dom.canvas.width / 450, dom.canvas.height / 220);
        const offsetX = (dom.canvas.width - (450 * globalScale)) / 2; const offsetY = (dom.canvas.height - (220 * globalScale)) / 2;
        ctx.translate(offsetX, offsetY); ctx.scale(globalScale, globalScale);
        const colorHex = lerpColor(0x4caf50, 0xf44336, phase);
        ctx.strokeStyle = colorHex; ctx.fillStyle = colorHex;
        const cx = 225, cy = 180, scale = 0.9; 
        const ankle = { x: cx - 140 * scale, y: cy - 20 * scale }; const slideLen = 180 * scale; 
        const seatX = (ankle.x + (50 * scale)) + (slideLen * phase); const hip = { x: seatX, y: cy - 30 * scale };
        const knee = { x: (hip.x + ankle.x) / 2, y: hip.y - (60 * scale) * (1 - phase) };
        const swingAngle = -25 + (phase * 50); const rad = swingAngle * Math.PI / 180;
        const shoulder = { x: hip.x + Math.sin(rad) * 120 * scale, y: hip.y - Math.cos(rad) * 120 * scale };
        const head = { x: shoulder.x + Math.sin(rad) * 25 * scale, y: shoulder.y - Math.cos(rad) * 25 * scale };
        let armExtension = 1; if (phase > 0.5) armExtension = 1 - ((phase - 0.5) * 2 * 0.9);
        const hand = { x: shoulder.x - (125 * scale * armExtension), y: shoulder.y + 40 * scale };
        ctx.beginPath(); ctx.lineWidth = 8; ctx.strokeStyle = '#333'; ctx.moveTo(cx - 180 * scale, cy); ctx.lineTo(cx + 180 * scale, cy); ctx.stroke(); 
        ctx.strokeStyle = colorHex; ctx.lineWidth = 16;
        ctx.beginPath(); ctx.moveTo(ankle.x, ankle.y); ctx.lineTo(knee.x, knee.y); ctx.lineTo(hip.x, hip.y); ctx.stroke(); 
        ctx.beginPath(); ctx.moveTo(hip.x, hip.y); ctx.lineTo(shoulder.x, shoulder.y); ctx.stroke(); 
        ctx.beginPath(); ctx.arc(head.x, head.y, 15 * scale, 0, Math.PI * 2); ctx.fill(); 
        ctx.beginPath(); ctx.lineWidth = 14; ctx.moveTo(shoulder.x, shoulder.y); ctx.lineTo(hand.x, hand.y); ctx.stroke(); 
        ctx.beginPath(); ctx.lineWidth = 5; ctx.strokeStyle = '#e0e0e0'; ctx.moveTo(hand.x, hand.y); ctx.lineTo(cx - 200 * scale, hand.y); ctx.stroke();
        ctx.restore();
    }
    
    function startMetronomeLoop() {
      if(animFrame) cancelAnimationFrame(animFrame);
      const loop = () => {
        if(!inIntervalMode || !activeRoutine) return;
        if(isRowing) {
            const step = activeRoutine.steps[currentStepIndex];
            const targetSpm = step.spm > 0 ? step.spm : 20; 
            const cycleMs = (60 / targetSpm) * 1000;
            const now = Date.now();
            
            if(now - lastBeepTime > cycleMs) { 
                lastBeepTime = now; 
                playBeep(880, 0.15); 
                secondBeepPlayed = false; 
            }
            
            const progress = (now - lastBeepTime) / cycleMs; 
            
            if (!secondBeepPlayed && progress >= 0.45) {
                playBeep(440, 0.15); 
                secondBeepPlayed = true;
            }

            let drivePhase = 0; let isDrive = true;
            if (progress < 0.35) { drivePhase = progress / 0.35; isDrive = true; } 
            else { const recovProgress = (progress - 0.35) / 0.65; drivePhase = 1.0 - recovProgress; isDrive = false; }
            drawRower(Math.min(1, Math.max(0, drivePhase)), isDrive); updateGauge(Math.min(1, Math.max(0, drivePhase)), isDrive);
        } else { drawRower(0, true); updateGauge(0, true); }
        animFrame = requestAnimationFrame(loop);
      };
      animFrame = requestAnimationFrame(loop);
    }

    let audioCtx = null;
    function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playBeep(freq=880, dur=0.1) {
      if(!audioCtx) return; if(audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); 
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur); osc.stop(audioCtx.currentTime + dur);
    }

    dom.routineBtn.addEventListener('click', () => { dom.modal.style.display = 'flex'; loadRoutineForm(); });
    dom.closeModal.addEventListener('click', () => dom.modal.style.display = 'none');
    dom.cancelRoutineBtn.addEventListener('click', () => dom.modal.style.display = 'none');
    dom.addIntervalBtn.addEventListener('click', () => addIntervalRow());

    function addIntervalRow(data = {sec: 60, spm: 20, label: 'Trabajo'}) {
      const div = document.createElement('div'); div.className = 'interval-row';
      div.innerHTML = `
        <input type="number" class="int-dur" value="${data.sec}">
        <input type="number" class="int-spm" value="${data.spm}">
        <input type="text" class="int-lbl" list="preset-labels" value="${data.label}" placeholder="Etiqueta">
        <button class="del-row-btn" style="background:#ff4545;color:white;border:none;border-radius:4px">&times;</button>
      `;
      div.querySelector('.del-row-btn').onclick = () => div.remove(); dom.intervalsContainer.appendChild(div);
    }

    const btnImport = document.getElementById('btn-import-json');
    const btnExport = document.getElementById('btn-export-json');
    const fileInput = document.getElementById('import-file');

    btnExport.addEventListener('click', () => {
        const name = document.getElementById('routine-name').value || 'Rutina_Remo';
        const rows = Array.from(document.querySelectorAll('.interval-row'));
        if(!rows.length) return alert("Agrega intervalos primero.");

        const steps = rows.map(r => ({
            sec: parseInt(r.querySelector('.int-dur').value)||60,
            spm: parseInt(r.querySelector('.int-spm').value)||20,
            label: r.querySelector('.int-lbl').value || 'Trabajo' 
        }));

        const data = { name, description:"Generada con Panel Remo PRO", steps };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name.replace(/\s+/g, '_') + '.json'; a.click();
        URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const json = JSON.parse(ev.target.result);
                if(!json.steps || !Array.isArray(json.steps)) throw new Error("Formato inv√°lido: falta 'steps'");
                document.getElementById('routine-name').value = json.name || "Rutina Importada";
                dom.intervalsContainer.innerHTML = ''; 
                json.steps.forEach(s => addIntervalRow(s));
                alert("Rutina importada correctamente.");
            } catch(err) { alert("Error: " + err.message); }
        };
        reader.readAsText(file); fileInput.value = '';
    });

    function loadRoutineForm() {
      dom.intervalsContainer.innerHTML = ''; const saved = localStorage.getItem('lastRoutine');
      if (saved) { const r = JSON.parse(saved); document.getElementById('routine-name').value = r.name; r.steps.forEach(s => addIntervalRow(s)); }
      else { addIntervalRow({sec: 300, spm: 18, label: 'Calentar'}); addIntervalRow({sec: 60, spm: 24, label: 'Trabajo'}); addIntervalRow({sec: 60, spm: 20, label: 'Descanso'}); }
    }

    dom.startRoutineBtn.addEventListener('click', () => {
      initAudio(); const name = document.getElementById('routine-name').value || 'Rutina';
      const rows = Array.from(document.querySelectorAll('.interval-row')); if(!rows.length) return;
      const steps = rows.map(r => ({ sec: parseInt(r.querySelector('.int-dur').value)||60, spm: parseInt(r.querySelector('.int-spm').value)||20, label: r.querySelector('.int-lbl').value }));
      localStorage.setItem('lastRoutine', JSON.stringify({ name, steps }));
      startIntervalSession({ name, steps }); dom.modal.style.display = 'none';
      requestWakeLock(); // Solicitar al iniciar rutina
    });

    function startIntervalSession(routine) {
      if(sessionActive) stopTimer(); resetUI();
      activeRoutine = routine; currentStepIndex = 0; inIntervalMode = true; isRowing = false;
      dom.intervalDashboard.style.display = 'flex'; 
      loadStep(0); startTimer(); startMetronomeLoop();
      setUIFocusMode(true); 
      requestWakeLock(); 
    }

    function loadStep(idx) {
      if (idx >= activeRoutine.steps.length) { finishRoutine(); return; }
      currentStepIndex = idx; const step = activeRoutine.steps[idx]; stepTimeRemaining = step.sec;
      updateText('int-phase-name', step.label); updateText('int-step-count', `${idx + 1} / ${activeRoutine.steps.length}`);
      updateText('int-target-spm', step.spm);
      const nextStep = activeRoutine.steps[idx+1];
      if(nextStep && dom.nextBox) { dom.nextBox.style.display = 'block'; updateText('next-interval-val', `${nextStep.label} @ ${nextStep.spm}`); } 
      else if(dom.nextBox) { dom.nextBox.style.display = 'none'; }
      updateIntervalUI();
    }

    function calculateTotalRemaining() {
        if (!activeRoutine) return 0;
        let total = stepTimeRemaining; 
        for (let i = currentStepIndex + 1; i < activeRoutine.steps.length; i++) {
            total += activeRoutine.steps[i].sec;
        }
        return total;
    }

    function updateIntervalUI() {
      if(!activeRoutine) return;
      const step = activeRoutine.steps[currentStepIndex];
      updateText('int-timer', formatMMSS(stepTimeRemaining));
      updateText('total-session-time', formatMMSS(calculateTotalRemaining()));
      
      if(dom.intProgressBar) dom.intProgressBar.style.width = `${((step.sec - stepTimeRemaining) / step.sec) * 100}%`;
      updateText('int-current-spm', currentSpm);
      
      const dash = dom.intervalDashboard; const arrow = dom.intArrow; 
      if(dash) dash.className = ''; if(arrow) arrow.className = 'int-arrow';
      
      const motEl = dom.intMotivation;

      if (!isRowing) { 
          updateText('int-arrow', "‚àí"); updateText('int-msg', "REMA"); 
          if(arrow) arrow.style.color = "#888"; if(dash) dash.style.borderColor = "#444"; 
          if(motEl) { motEl.textContent = "¬°EMPIEZA!"; motEl.style.color = "#aaa"; }
      }
      else {
        const diff = currentSpm - step.spm;
        if (diff < -2) { 
            updateText('int-arrow', "‚ñ≤"); updateText('int-msg', "SUBE"); 
            arrow.classList.add('guide-up'); dash.classList.add('dash-slow'); 
            if(motEl) { motEl.textContent = "¬°ACELERA! ‚ö°"; motEl.style.color = "var(--guide-slow)"; }
        }
        else if (diff > 2) { 
            updateText('int-arrow', "‚ñº"); updateText('int-msg', "BAJA"); 
            arrow.classList.add('guide-down'); dash.classList.add('dash-fast'); 
            if(motEl) { motEl.textContent = "¬°CONTROLA! üê¢"; motEl.style.color = "var(--guide-fast)"; }
        }
        else { 
            updateText('int-arrow', "‚óè"); updateText('int-msg', "BIEN"); 
            arrow.classList.add('guide-ok'); dash.classList.add('dash-good'); 
            if(motEl) { motEl.textContent = "¬°EXCELENTE! üî•"; motEl.style.color = "var(--guide-good)"; }
        }
      }
    }

    function checkRowingStatus(spm) {
        if (spm > 0) {
            isRowing = true; 
            if(rowingTimeout) clearTimeout(rowingTimeout);
            rowingTimeout = setTimeout(() => { 
                isRowing = false; updateIntervalUI(); drawRower(0, true); updateGauge(0, true); 
            }, 4000);
        }
    }

    const FTMS_UUID=0x1826; const ROWER_CHAR_UUID=0x2AD1; const HR_SERVICE_UUID=0x180D; const HR_CHAR_UUID=0x2A37;
    
    // Conexi√≥n Remo
    dom.connectRowerBtn.addEventListener('click', async ()=>{
      try{ if(!navigator.bluetooth) throw new Error("Bluetooth API Off"); 
        const dev = await navigator.bluetooth.requestDevice({filters:[{services:[FTMS_UUID]}], optionalServices:[FTMS_UUID]});
        dev.addEventListener('gattserverdisconnected', onRowerDisconnected);
        const server = await dev.gatt.connect(); 
        
        updateText('rower-status', dev.name); if(dom.rowerStatus) dom.rowerStatus.className='status connected';
        const svc = await server.getPrimaryService(FTMS_UUID); const ch = await svc.getCharacteristic(ROWER_CHAR_UUID);
        await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', handleRowerData); 
        requestWakeLock(); // Solicitar al conectar
      }catch(e){ showError("Err Remo: " + e.message); }
    });

    function onRowerDisconnected() {
        updateText('rower-status', 'Remo: Desconectado');
        if(dom.rowerStatus) dom.rowerStatus.className = 'status disconnected';
        alert("El remo se ha desconectado."); stopTimer(); 
    }

    // Conexi√≥n HR
    const USER_AGE = 33; const MAX_HR = 220 - USER_AGE;
    dom.connectHrBtn.addEventListener('click', async ()=>{
      try{ if(!navigator.bluetooth) throw new Error("Bluetooth Off");
        const dev = await navigator.bluetooth.requestDevice({ filters:[{services:[HR_SERVICE_UUID]}], optionalServices:[HR_SERVICE_UUID] });
        dev.addEventListener('gattserverdisconnected', onHrDisconnected);
        const server = await dev.gatt.connect(); 
        
        updateText('hr-status', dev.name); if(dom.hrStatus) dom.hrStatus.className='status connected';
        const svc = await server.getPrimaryService(HR_SERVICE_UUID); const ch = await svc.getCharacteristic(HR_CHAR_UUID);
        await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', handleHrData); 
        requestWakeLock(); // Solicitar al conectar
      }catch(e){ showError("Err HR: " + e.message); }
    });

    function handleHrData(e) {
        const v = e.target.value; const val = (v.getUint8(0) & 1) ? v.getUint16(1, true) : v.getUint8(1);
        updateText('heart-rate', val); const hrEl = document.getElementById('heart-rate');
        currentHeartRate = val;
        const pct = val / MAX_HR; hrEl.className = 'value';
        if (pct < 0.6) hrEl.classList.add('hr-z1'); else if (pct < 0.7) hrEl.classList.add('hr-z2');
        else if (pct < 0.8) hrEl.classList.add('hr-z3'); else if (pct < 0.9) hrEl.classList.add('hr-z4');
        else hrEl.classList.add('hr-z5');
        if(dom.hrCard) { dom.hrCard.classList.remove('card-pulse'); void dom.hrCard.offsetWidth; dom.hrCard.classList.add('card-pulse'); }
    }
    function onHrDisconnected() {
        updateText('hr-status', 'HR: --'); if(dom.hrStatus) dom.hrStatus.className = 'status disconnected';
        updateText('heart-rate', '--'); currentHeartRate = 0; 
    }

    function handleRowerData(e){ if(!sessionTimer && !inIntervalMode) startTimer(); parseRowerData(e.target.value); }
    
    function parseRowerData(data){
      const flags=data.getUint16(0,true); let offset=2; const parsed={};
      const sr=data.getUint8(offset)/2.0; offset+=1; currentSpm = Math.round(sr); 
      updateText('stroke-rate', currentSpm); parsed.spm = currentSpm; checkRowingStatus(currentSpm); if(inIntervalMode) updateIntervalUI();
      const strokes=data.getUint16(offset,true); offset+=2; updateText('total-strokes', strokes); parsed.strokes=strokes;
      if(flags&0x0002) offset+=1; 
      
      // FIXED: Persistencia de Distancia
      if(flags&0x0004){ 
        const dist=(data.getUint32(offset,true)&0x00FFFFFF); 
        offset+=3; 
        currentDistanceMeters = dist; // Guardamos en variable global
        updateText('distance', (dist/1000).toFixed(2)); 
      }
      parsed.dist_m = currentDistanceMeters; // Asignamos siempre la distancia actual al evento

      if(flags&0x0008){ const pace=data.getUint16(offset,true); offset+=2; lastPaceSeconds = pace; updateText('pace', formatMMSS(pace)); parsed.pace_s=pace; }
      if(flags&0x0010) offset+=2; 
      if(flags&0x0020){ const p=data.getInt16(offset,true); offset+=2; lastPowerBle = p; parsed.power_ble=p; }
      if(flags&0x0080) offset+=2; 
      if(flags&0x0100){ const kcal=data.getUint16(offset,true); offset+=5; updateText('calories', kcal); parsed.kcal=kcal; }
      parsed.power_display = applyPowerDisplay();
      parsed.hr = currentHeartRate;
      if(sessionActive && isRowing){ rawEvents.push({ts:nowTs(), parsed}); }
    }
    
    function applyPowerDisplay(){
      const mode=dom.powerMode.value, fact=dom.corrFactor.value;
      const pC2 = (lastPaceSeconds>0) ? 2.8/Math.pow(lastPaceSeconds/500,3) : 0; const pCorr=Math.max(0, (lastPowerBle||0)*fact);
      let val=0; if(mode==='equiv'){ val=pC2||pCorr||lastPowerBle||0; } else if(mode==='ble'){ val=lastPowerBle||0; } else { val=pCorr||pC2||0; }
      updateText('power', Math.round(val)); return Math.round(val);
    }
    dom.powerMode.addEventListener('change', applyPowerDisplay); dom.corrFactor.addEventListener('input', applyPowerDisplay);

    function startTimer(){ 
        if(sessionTimer) return; 
        sessionActive = true; 
        requestWakeLock(); // Solicitar al iniciar tiempo
        dom.exportBtn.disabled=false; 
        sessionTimer = setInterval(()=>{ 
            if(isRowing) { elapsedSeconds++; updateText('duration', formatMMSS(elapsedSeconds)); 
                if(inIntervalMode) { 
                    stepTimeRemaining--; 
                    updateIntervalUI(); 
                    if(stepTimeRemaining <= 0) loadStep(currentStepIndex + 1); 
                } 
            } 
        }, 1000); 
    }
    function stopTimer(){ 
        clearInterval(sessionTimer); if(animFrame) cancelAnimationFrame(animFrame); 
        sessionTimer = null; sessionActive = false; inIntervalMode = false; isRowing = false; 
        dom.intervalDashboard.style.display = 'none'; 
        setUIFocusMode(false); 
    }
    function finishRoutine() { inIntervalMode = false; activeRoutine = null; alert("¬°Rutina completada!"); dom.endSessionBtn.click(); }
    
    dom.endSessionBtn.addEventListener('click', ()=>{ 
        if(!rawEvents.length && !sessionActive && elapsedSeconds === 0) return alert("Sin datos"); 
        stopTimer(); dom.mainScreen.style.display='none'; dom.resultsScreen.style.display='flex'; 
        updateText('res-duration', formatMMSS(elapsedSeconds)); updateText('res-distance', document.getElementById('distance').textContent + " km"); 
        updateText('res-calories', document.getElementById('calories').textContent + " kcal"); updateText('res-strokes', document.getElementById('total-strokes').textContent); 
        const spms = rawEvents.map(e=>e.parsed.spm).filter(x=>x>0); updateText('res-avg-spm', (spms.length ? Math.round(spms.reduce((a,b)=>a+b,0)/spms.length) : 0) + " SPM");
        document.getElementById('download-report-btn').disabled = false;
        requestWakeLock();
    });

    document.getElementById('new-session-btn').addEventListener('click', ()=>{ dom.resultsScreen.style.display='none'; dom.mainScreen.style.display='flex'; resetUI(); requestWakeLock(); });

    function resetUI(){ 
        elapsedSeconds=0; rawEvents=[]; ['duration','distance','calories','total-strokes','stroke-rate','power','heart-rate'].forEach(id=>updateText(id, id==='heart-rate'?'--':'0')); updateText('pace', '--:--'); dom.exportBtn.disabled=true; lastPaceSeconds=null; lastPowerBle=null; 
        document.getElementById('download-report-btn').disabled = true;
        currentHeartRate = 0;
        currentDistanceMeters = 0; // Reset distancia
    }
    
    const exportData = () => {
        if(!rawEvents.length) return alert("Sin datos");
        let csv = "Timestamp,SPM,Watts,Pace,Strokes,Dist,HeartRate\n";
        rawEvents.forEach(e => { csv += `${e.ts},${e.parsed.spm},${e.parsed.power_display},${e.parsed.pace_s||0},${e.parsed.strokes},${e.parsed.dist_m||0},${e.parsed.hr||0}\n`; });
        const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `remo_sesion_${Date.now()}.csv`; a.click();
    };
    dom.exportBtn.addEventListener('click', exportData);
    
    // --- GENERACI√ìN DE INFORME HTML ---
    document.getElementById('download-report-btn').addEventListener('click', () => {
        buildAndDownloadReport(rawEvents, elapsedSeconds);
    });

    const isNum=(x)=> typeof x==='number' && !Number.isNaN(x);
    const mmss=(sec)=>{if(!isNum(sec)) return '--:--'; sec=Math.round(sec); const m=Math.floor(sec/60),s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};
    const avg=(arr)=>{if(!arr||!arr.length) return null; const v=arr.filter(isNum); return v.length? v.reduce((a,b)=>a+b,0)/v.length : null;};
    const maxVal=(arr)=>{const v=arr.filter(isNum);return v.length? Math.max(...v):null;};
    
    // L√≥gica para graficar con Eje X
    function lineChartSVG(t,y,label,color='#03dac6'){
      const w=900,h=220,pad=30; 
      const tValid=t.filter((_,i)=>isNum(y[i]));
      const yValid=y.filter(isNum);
      const tMin=tValid.length? Math.min(...tValid):0, tMax=tValid.length? Math.max(...tValid):1;
      const yMin=yValid.length? Math.min(...yValid):0, yMax=yValid.length? Math.max(...yValid):1;
      
      const sx=(x)=> pad + ((x - tMin) / (tMax - tMin || 1)) * (w-2*pad);
      const sy=(v)=> (h-pad) - ((v - yMin) / (yMax - yMin || 1)) * (h-2*pad);
      
      let d=""; for(let i=0;i<t.length;i++){ if(!isNum(y[i])) continue; const X=sx(t[i]),Y=sy(y[i]); d+=(d?" L":"M")+`${X.toFixed(1)} ${Y.toFixed(1)}`; }
      
      const yGrid=[]; for(let k=0;k<5;k++){ yGrid.push(yMin+(yMax-yMin)*k/4); }
      const gridLinesY=yGrid.map(v=>`<line x1="${pad}" y1="${sy(v).toFixed(1)}" x2="${(w-pad)}" y2="${sy(v).toFixed(1)}" stroke="#222" stroke-width="1"/>`).join('');
      const yLabels=yGrid.map(v=>`<text x="${pad-6}" y="${sy(v)+4}" fill="#888" font-size="10" text-anchor="end">${Math.round(v)}</text>`).join('');

      const xGrid = [];
      const totalDuration = tMax - tMin;
      let step = totalDuration / 6;
      if (step < 60) step = 30;           
      else if (step < 120) step = 60;     
      else if (step < 300) step = 120;   
      else if (step < 600) step = 300;   
      else step = 600;                    

      for(let v = tMin; v <= tMax; v += step) { xGrid.push(v); }
      
      const gridLinesX = xGrid.map(v => `<line x1="${sx(v).toFixed(1)}" y1="${pad}" x2="${sx(v).toFixed(1)}" y2="${h-pad}" stroke="#222" stroke-width="1"/>`).join('');
      const xLabels = xGrid.map(v => `<text x="${sx(v).toFixed(1)}" y="${h-10}" fill="#888" font-size="10" text-anchor="middle">${mmss(v)}</text>`).join('');

      return `<svg viewBox="0 0 ${w} ${h}" role="img" aria-label="${label}">
        <rect x="0" y="0" width="${w}" height="${h}" fill="#0f0f0f" rx="10"></rect>
        ${gridLinesY}
        ${gridLinesX}
        <path d="${d}" fill="none" stroke="${color}" stroke-width="2.2" />
        <text x="${pad}" y="18" fill="#bbb" font-size="12">${label}</text>
        ${yLabels}
        ${xLabels}
      </svg>`;
    }
    
    function smooth(arr,w=5){const out=[]; for(let i=0;i<arr.length;i++){ let s=0,c=0; for(let k=i-Math.floor(w/2);k<=i+Math.floor(w/2);k++){ if(k>=0&&k<arr.length&&isNum(arr[k])){s+=arr[k];c++;}} out.push(c? s/c : null); } return out; }

    function buildAndDownloadReport(events, totalSec) {
        if(!events || !events.length) return alert('No hay datos suficientes.');
        
        const parseTS=(s)=>{const [h,m,rest]=s.split(':'),[sec,ms]=rest.split('.'); const d=new Date(); d.setHours(+h,+m,+sec,+ms||0); return d;};
        
        const t0 = parseTS(events[0].ts);
        const rows = events.map(e => {
            const date = parseTS(e.ts);
            return {
                t_sec: (date - t0) / 1000,
                spm: e.parsed.spm,
                watts: e.parsed.power_display,
                hr: e.parsed.hr,
                pace: e.parsed.pace_s,
                strokes: e.parsed.strokes,
                dist: e.parsed.dist_m // Ahora siempre deber√≠a tener valor
            };
        });

        // Safe check for distance
        const lastRow = rows[rows.length-1];
        const totalDist = (lastRow && isNum(lastRow.dist)) ? lastRow.dist / 1000 : 0;
        
        const totalStrokes = lastRow ? lastRow.strokes : 0;
        const avgSpm = avg(rows.map(r=>r.spm));
        const avgWatts = avg(rows.map(r=>r.watts));
        const maxWatts = maxVal(rows.map(r=>r.watts));
        
        const hrValid = rows.filter(r => r.hr > 0).map(r => r.hr);
        const avgHr = avg(hrValid);
        const maxHr = maxVal(hrValid);

        const t = rows.map(r => r.t_sec);
        const pSmooth = smooth(rows.map(r => r.watts));
        const hrSmooth = smooth(rows.map(r => r.hr > 0 ? r.hr : null));
        const paceData = rows.map(r => r.pace > 0 && r.pace < 300 ? r.pace : null);

        const powerSvg = lineChartSVG(t, pSmooth, 'Potencia (W)', '#03dac6');
        const hrSvg = lineChartSVG(t, hrSmooth, 'Frecuencia Card√≠aca (BPM)', '#ff4545');
        const paceSvg = lineChartSVG(t, paceData, 'Ritmo (s/500m)', '#2196f3');

        const html = `
<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Informe de Sesi√≥n</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#111;color:#eee;margin:0;padding:20px;max-width:900px;margin:auto}
h1,h2{color:#03dac6;margin-bottom:10px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px}
.card{background:#1e1e1e;border-radius:12px;padding:15px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
.label{font-size:12px;opacity:0.7;text-transform:uppercase;margin-bottom:5px}
.value{font-size:24px;font-weight:bold;color:#fff}
.unit{font-size:14px;color:#888;font-weight:normal}
svg{width:100%;height:auto;background:#0f0f0f;border-radius:8px;margin-top:10px}
.section{background:#1e1e1e;padding:20px;border-radius:12px;margin-bottom:20px}
</style></head><body>
<h1>Informe de Entrenamiento</h1>
<div class="kpi-grid">
  <div class="card"><div class="label">Tiempo</div><div class="value">${mmss(totalSec)}</div></div>
  <div class="card"><div class="label">Distancia</div><div class="value">${totalDist.toFixed(2)}<span class="unit"> km</span></div></div>
  <div class="card"><div class="label">Paladas</div><div class="value">${totalStrokes}</div></div>
  <div class="card"><div class="label">SPM Media</div><div class="value">${Math.round(avgSpm||0)}</div></div>
  <div class="card"><div class="label">Potencia Media</div><div class="value">${Math.round(avgWatts||0)}<span class="unit"> W</span></div></div>
  <div class="card"><div class="label">HR Medio</div><div class="value" style="color:#ff4545">${Math.round(avgHr||0)}<span class="unit"> BPM</span></div></div>
</div>

<div class="section">
  <h2>Potencia</h2>
  <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;color:#aaa">
      <span>Promedio: <b>${Math.round(avgWatts||0)} W</b></span>
      <span>M√°ximo: <b>${Math.round(maxWatts||0)} W</b></span>
  </div>
  ${powerSvg}
</div>

<div class="section">
  <h2 style="color:#ff4545">Frecuencia Card√≠aca</h2>
  <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;color:#aaa">
      <span>Promedio: <b>${Math.round(avgHr||0)} BPM</b></span>
      <span>M√°ximo: <b>${Math.round(maxHr||0)} BPM</b></span>
  </div>
  ${hrSvg}
</div>

<div class="section">
  <h2 style="color:#2196f3">Ritmo (Pace)</h2>
  ${paceSvg}
</div>

</body></html>`;

        const blob = new Blob([html], {type: 'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `informe_remo_${Date.now()}.html`; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
    }
    
    drawRower(0, true); initGauge();
  </script>
</body>
</html>
