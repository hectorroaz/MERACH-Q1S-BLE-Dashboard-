<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Panel Remo - Clean Cockpit</title>
  <style>
    :root{
      --bg-color:#121212; --card-color:#1e1e1e; --text-color:#e0e0e0;
      --primary-color:#03dac6; --secondary-color:#bb86fc; --accent-color:#cf6679;
      --interval-bg:#151922; --interval-text:#ffffff; 
      --guide-fast:#f44336; --guide-slow:#2196f3; --guide-good:#4caf50;
    }
    
    html,body{height:100%; margin:0; padding:0; overflow:hidden; background:var(--bg-color);}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      color:var(--text-color);
      display:flex; flex-direction:column;
      -webkit-tap-highlight-color: transparent;
    }

    /* === CONTENEDOR PRINCIPAL === */
    .container {
      width: 100%; height: 100vh; 
      display: flex; flex-direction: column; 
      position: relative; 
      padding: 10px; box-sizing: border-box;
    }
    
    /* Encabezado (solo vertical) */
    header { text-align:center; padding:5px 0; flex-shrink: 0; }
    h1 { font-size:1.2rem; margin:0; opacity: 0.8; }
    
    /* === BOTONES FLOTANTES (FANTASMA) === */
    .buttons-container {
        display:flex; justify-content:center; gap:8px; 
        flex-wrap:wrap; z-index: 100;
        transition: opacity 0.5s ease, transform 0.5s ease;
        padding: 5px; background: rgba(0,0,0,0.6); border-radius: 12px;
    }
    
    /* Estado oculto */
    .buttons-hidden {
        opacity: 0; pointer-events: none; transform: translateY(20px);
    }

    button {
        padding:10px 14px; font-size:13px; border:none; border-radius:8px; 
        cursor:pointer; background:var(--primary-color); color:var(--bg-color); 
        font-weight:bold; min-width: 60px;
    }
    button:active{transform:scale(0.96);}
    button:disabled{background:#444; color:#888;}
    #end-session-btn{background:var(--accent-color); color: white;}
    #fullscreen-btn{background:#333; color: white; font-size: 1.2rem; padding: 5px 12px;}

    /* Status Bar */
    .status-bar{
        display:flex; justify-content:space-between; 
        background:var(--card-color); padding:4px 10px; 
        border-radius:6px; margin-bottom:5px; 
        font-size:10px; text-align:center; flex-shrink: 0;
    }
    .connected{color:var(--primary-color); font-weight: bold;} .disconnected{color:var(--accent-color);}

    /* === DASHBOARD IZQUIERDO (HUMANOIDE) === */
    #interval-dashboard {
        display: none; 
        background: var(--interval-bg);
        border: 2px solid #333;
        border-radius: 12px;
        flex-direction: column;
        position: relative;
        overflow: hidden; 
        transition: border-color 0.3s ease;
        flex-grow: 1; /* Ocupar espacio disponible */
    }
    
    .dash-slow { border-color: var(--guide-slow) !important; box-shadow: inset 0 0 30px rgba(33, 150, 243, 0.15); }
    .dash-fast { border-color: var(--guide-fast) !important; box-shadow: inset 0 0 30px rgba(244, 67, 54, 0.15); }
    .dash-good { border-color: var(--guide-good) !important; box-shadow: inset 0 0 30px rgba(76, 175, 80, 0.15); }

    /* Textos Superpuestos (HUD) */
    .hud-element { position: absolute; z-index: 10; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none;}
    
    /* Fase (Arriba Izquierda) */
    .hud-top-left { top: 15px; left: 15px; display: flex; flex-direction: column; align-items: flex-start; }
    .int-phase-name { font-size: 1.2rem; font-weight: 900; color: white; font-style: italic; text-transform: uppercase; line-height: 1; }
    .int-step-count { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #ccc; margin-top: 4px; }

    /* Timer (Arriba Derecha) */
    .hud-top-right { top: 10px; right: 15px; text-align: right; }
    .int-timer-big { font-size: 2.8rem; font-weight: bold; color: white; line-height: 1; font-family: monospace; letter-spacing: -1px;}
    .int-timer-status { font-size: 0.6rem; color: #ffd700; font-weight: bold; text-transform: uppercase;}

    /* Objetivo (Debajo del Timer - SIN SOLAPAR) */
    .hud-target { top: 80px; right: 15px; text-align: right; }
    .target-val { font-size: 1.6rem; font-weight: 900; color: var(--primary-color); line-height: 1; }
    .target-lbl { font-size: 0.55rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px;}

    /* Gu√≠a Visual (Flechas) */
    .hud-guidance { 
        bottom: 25px; left: 50%; transform: translateX(-50%); 
        display: flex; align-items: center; gap: 10px;
        background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px;
        transition: opacity 0.3s;
    }
    .int-arrow { font-size: 1.5rem; line-height: 1; }
    .int-msg { font-weight: 900; font-size: 0.9rem; }

    /* Canvas Humanoide */
    .viz-container { 
        width: 100%; height: 100%; 
        display: flex; align-items: center; justify-content: center;
        padding-bottom: 20px; /* Espacio para barra gauge */
    }
    canvas#rower-canvas {
        max-width: 100%; max-height: 100%;
        width: auto; height: auto;
    }

    /* Gauge Metr√≥nomo */
    .gauge-wrapper {
        position: absolute; bottom: 8px; left: 5%; width: 90%; height: 8px; 
        z-index: 5; display: flex; gap: 3px;
    }
    .gauge-segment { flex: 1; background: #333; border-radius: 2px; transition: background 0.1s; }
    .gauge-segment.active { box-shadow: 0 0 8px currentColor; }

    /* Barra de Progreso Intervalo */
    .progress-line { position: absolute; bottom: 0; left: 0; height: 4px; background: #2aa7ff; width: 100%; transition: width 1s linear; z-index: 6;}

    /* Colores Gu√≠a */
    .guide-up { color: var(--guide-slow); } .guide-down { color: var(--guide-fast); } .guide-ok { color: var(--guide-good); } 

    /* === DASHBOARD DERECHO (DATOS) === */
    .data-grid {
        display: flex; gap: 5px; flex-wrap: wrap; width: 100%; margin-top: 10px;
    }
    .metric-card {
        background:var(--card-color); padding:8px; border-radius:8px; text-align:center;
        display:flex; flex-direction:column; justify-content:center;
        flex: 1 1 30%; min-width: 70px; border: 1px solid #333;
    }
    .metric-card .value{font-size:1.4rem; font-weight:bold; color:var(--text-color);}
    .metric-card .label{font-size:.6rem; color:var(--secondary-color); text-transform: uppercase; margin-bottom: 2px;}
    .metric-card .unit{font-size:.6rem; color: #777;}
    .highlight-val { color: var(--primary-color) !important; }
    .card-pulse { animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0.4); } 100% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } }

    /* === LAYOUT RESPONSIVO (HORIZONTAL) === */
    @media (orientation: landscape) {
        body { padding: 0; }
        .container { flex-direction: row; padding: 0; gap: 0; }
        header, h1 { display: none; }

        /* Status bar flota arriba semitransparente */
        .status-bar {
            position: absolute; top: 0; left: 0; right: 0; z-index: 50;
            background: rgba(0,0,0,0.3); pointer-events: none; border-radius: 0; padding: 2px 10px;
        }

        /* Botones flotan abajo centro */
        .buttons-container {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            margin: 0; width: auto; 
        }
        /* Cuando se ocultan, bajan */
        .buttons-hidden { transform: translate(-50%, 50px); opacity: 0; }

        /* Panel Izquierdo (60%) */
        #interval-dashboard {
            width: 60%; height: 100vh; border: none; border-right: 1px solid #333; margin: 0; border-radius: 0;
            display: flex !important; /* Siempre visible para layout */
        }
        /* Ajuste de HUD en horizontal */
        .int-phase-name { font-size: 1.6rem; }
        .int-timer-big { font-size: 3.5rem; }
        .hud-top-right { top: 20px; right: 20px; }
        .hud-target { top: 100px; right: 20px; } /* M√°s abajo para no chocar */
        .hud-guidance { bottom: 30px; } /* Subir un poco para no tapar gauge */
        
        /* Panel Derecho (40%) */
        .data-grid {
            width: 40%; height: 100vh; margin: 0; padding: 30px 10px 10px 10px; /* Padding top para status bar */
            display: grid !important; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: repeat(4, 1fr);
            gap: 8px; align-content: center;
            background: #0e0e0e;
            overflow-y: auto;
        }
        .metric-card { width: 100%; height: 100%; flex: none; }
        .metric-card .value { font-size: 2rem; }
    }

    /* Modales y Utilidades */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a2e; width: 90%; max-width: 450px; border-radius: 12px; border: 1px solid #555; display: flex; flex-direction: column; max-height: 90vh;}
    .modal-header { padding: 15px; background: #16213e; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;}
    .modal-body { padding: 15px; overflow-y: auto; }
    .interval-row { display: grid; grid-template-columns: 0.8fr 0.8fr 2fr 30px; gap: 5px; margin-bottom: 8px; align-items: center;}
    .interval-row input, .interval-row select { background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box;}

    #results-screen{display:none; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-color); width:100%; height:100vh; position:fixed; top:0; left:0; z-index:3000;}
    .results-grid{display:grid; grid-template-columns:1fr 1fr; gap:15px; width:90%; max-width:400px; margin-bottom:20px}
    
    #err-banner{position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#500; color:#fff; padding:8px 15px; border-radius:20px; z-index:9999; display:none; font-size:12px;}
  </style>
</head>
<body>

  <div id="err-banner">Error</div>

  <div class="container" id="main-screen">
    <header><h1>Panel Remo Pro</h1></header>

    <div class="status-bar">
      <div id="rower-status" class="status disconnected">Remo: Desconectado</div>
      <div id="hr-status" class="status disconnected">HR: --</div>
    </div>

    <div id="interval-dashboard">
      <div class="hud-element hud-top-left">
        <div class="int-phase-name" id="int-phase-name">CALENTAR</div>
        <span class="int-step-count" id="int-step-count">1 / 4</span>
      </div>

      <div class="hud-element hud-top-right">
        <div class="int-timer-big" id="int-timer">00:00</div>
        <div class="int-timer-status" id="int-status">LISTO</div>
      </div>

      <div class="hud-element hud-target">
        <div class="target-val" id="int-target-spm">20</div>
        <div class="target-lbl">OBJETIVO SPM</div>
      </div>

      <div class="hud-element hud-guidance">
        <span class="int-arrow" id="int-arrow">‚àí</span>
        <span class="int-msg" id="int-msg">REMA</span>
      </div>

      <div class="viz-container">
        <canvas id="rower-canvas" width="450" height="220"></canvas>
      </div>

      <div class="gauge-wrapper" id="gauge-bar"></div>
      <div class="progress-line" id="int-progress-bar" style="width: 100%"></div>
    </div>

    <div class="data-grid">
        <div class="metric-card"><div class="label">Ritmo</div><div class="value highlight-val"><span id="stroke-rate">0</span> <span class="unit">SPM</span></div></div>
        <div class="metric-card" id="hr-card"><div class="label">Pulso</div><div class="value"><span id="heart-rate">--</span> <span class="unit">BPM</span></div></div>
        
        <div class="metric-card"><div class="label">Potencia</div><div class="value"><span id="power">0</span> <span class="unit">W</span></div>
           <div style="display:none"><select id="power-mode"><option value="equiv">Eq</option></select><input id="corr-factor" value="7.2"></div>
        </div>
        
        <div class="metric-card"><div class="label">Distancia</div><div class="value"><span id="distance">0.00</span> <span class="unit">km</span></div></div>
        
        <div class="metric-card"><div class="label">Tiempo Total</div><div class="value" id="duration">00:00</div></div>
        <div class="metric-card"><div class="label">Pace/500m</div><div class="value" id="pace">--:--</div></div>
        
        <div class="metric-card"><div class="label">Calor√≠as</div><div class="value"><span id="calories">0</span> <span class="unit">kcal</span></div></div>
        <div class="metric-card"><div class="label">Paladas</div><div class="value" id="total-strokes">0</div></div>
    </div>

    <div class="buttons-container" id="controls-bar">
      <button id="fullscreen-btn" title="Pantalla Completa">‚õ∂</button>
      <button id="connect-rower-btn">üîó Remo</button>
      <button id="connect-hr-btn">‚ù§Ô∏è HR</button>
      <button id="routine-btn">‚ö° Rutina</button>
      <button id="end-session-btn">‚èπ Finalizar</button>
      <button id="export-btn" disabled>‚¨á CSV</button>
    </div>

  </div>

  <div id="results-screen">
    <h2 style="color:white">Resumen Sesi√≥n</h2>
    <div class="results-grid">
      <div class="metric-card"><div class="label">Tiempo</div><div class="value" id="res-duration">00:00</div></div>
      <div class="metric-card"><div class="label">Distancia</div><div class="value" id="res-distance">0.00 km</div></div>
      <div class="metric-card"><div class="label">Calor√≠as</div><div class="value" id="res-calories">0 kcal</div></div>
      <div class="metric-card"><div class="label">Ritmo Med</div><div class="value" id="res-avg-spm">0 SPM</div></div>
    </div>
    <div style="display:flex; gap:10px">
      <button id="download-report-btn" disabled>Guardar Datos</button>
      <button id="new-session-btn">Nueva Sesi√≥n</button>
    </div>
  </div>

  <div class="modal-overlay" id="routine-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 style="color:white;margin:0">Editor Rutina</h3><span class="close-modal" id="close-modal" style="cursor:pointer;color:#888;font-size:24px">&times;</span></div>
      <div class="modal-body">
        <div style="margin-bottom:10px"><label style="color:#aaa;font-size:10px">NOMBRE</label><input type="text" id="routine-name" placeholder="Ej: Pir√°mide"></div>
        <div id="intervals-container"></div>
        <button id="add-interval-btn" style="width:100%;background:#3498db;color:white;padding:10px;border:none;border-radius:6px;margin-top:10px">+ Intervalo</button>
      </div>
      <div style="padding:15px; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:10px">
        <button id="cancel-routine-btn" style="background:transparent;border:1px solid #555">Cancelar</button>
        <button id="start-routine-btn" style="background:#2ecc71;color:white">INICIAR</button>
      </div>
    </div>
  </div>

  <script>
    /* ================= SYSTEM & WAKE LOCK ================= */
    const dom = {
       dashboard: document.getElementById('interval-dashboard'),
       controls: document.getElementById('controls-bar'),
       canvas: document.getElementById('rower-canvas'),
       gauge: document.getElementById('gauge-bar'),
       err: document.getElementById('err-banner')
    };
    
    const showError = (m) => { dom.err.textContent=m; dom.err.style.display='block'; setTimeout(()=>dom.err.style.display='none', 4000); };
    const updateText = (id, txt) => { const el=document.getElementById(id); if(el) el.textContent=txt; };
    const formatMMSS=(s)=>{const m=Math.floor(s/60),sec=Math.max(0,Math.round(s%60));return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}

    // WAKE LOCK LOGIC (VITAL)
    let wakeLock = null;
    const requestWakeLock = async () => {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => { console.log('WakeLock released'); });
                console.log('WakeLock Active');
            }
        } catch (err) { console.warn('WakeLock err:', err); }
    };
    
    document.addEventListener('visibilitychange', () => {
        if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
    });
    
    // FULLSCREEN & AUTO-HIDE BUTTONS
    document.getElementById('fullscreen-btn').addEventListener('click', () => {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>showError("Fullscr err"));
        else document.exitFullscreen();
    });

    let hideControlsTimeout;
    const showControls = () => {
        dom.controls.classList.remove('buttons-hidden');
        if(hideControlsTimeout) clearTimeout(hideControlsTimeout);
        if(sessionActive) hideControlsTimeout = setTimeout(() => dom.controls.classList.add('buttons-hidden'), 4000);
    };
    
    document.body.addEventListener('touchstart', showControls, {passive: true});
    document.body.addEventListener('click', showControls);

    /* ================= APP LOGIC ================= */
    let sessionTimer=null, elapsed=0, sessionActive=false, isRowing=false, rowingTimer=null;
    let currentSpm=0, activeRoutine=null, stepIdx=0, stepTime=0;
    let rawEvents=[];
    
    // GAUGE
    function initGauge(){
        dom.gauge.innerHTML='';
        for(let i=0; i<20; i++){
            let d=document.createElement('div'); d.className='gauge-segment';
            d.dataset.c = i<5?'#4caf50':(i<10?'#ffeb3b':(i<15?'#ff9800':'#f44336'));
            dom.gauge.appendChild(d);
        }
    }
    function updateGauge(phase, active){
        const segs = dom.gauge.children;
        const limit = Math.floor(phase * 20);
        for(let i=0; i<20; i++){
            segs[i].className = (active && i<=limit) ? 'gauge-segment active' : 'gauge-segment';
            segs[i].style.backgroundColor = (active && i<=limit) ? segs[i].dataset.c : '';
            segs[i].style.boxShadow = '';
            if(active && i<=limit) segs[i].style.boxShadow = `0 0 5px ${segs[i].dataset.c}`;
        }
    }

    // CANVAS HUMANOIDE
    const ctx = dom.canvas.getContext('2d');
    function drawRower(phase, isDrive) {
        // Resize din√°mico
        const dpr = window.devicePixelRatio || 1;
        const rect = dom.canvas.getBoundingClientRect();
        if(dom.canvas.width !== rect.width * dpr || dom.canvas.height !== rect.height * dpr){
             dom.canvas.width = rect.width * dpr; dom.canvas.height = rect.height * dpr;
        }
        
        ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
        ctx.save();
        
        // ESCALA REDUCIDA (0.85) PARA DAR AIRE
        const baseScale = Math.min(dom.canvas.width / 450, dom.canvas.height / 220);
        const finalScale = baseScale * 0.85; 
        
        const offsetX = (dom.canvas.width - (450 * finalScale)) / 2;
        const offsetY = (dom.canvas.height - (220 * finalScale)) / 2;
        
        ctx.translate(offsetX, offsetY); 
        ctx.scale(finalScale, finalScale);
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';

        // Interpolaci√≥n de color
        const r = Math.round(76 + (244 - 76) * phase);
        const g = Math.round(175 + (67 - 175) * phase);
        const b = Math.round(80 + (54 - 80) * phase);
        const color = `rgb(${r},${g},${b})`;
        
        ctx.strokeStyle = color; ctx.fillStyle = color;

        // Dibujo
        const cx=225, cy=180;
        const slide = 180 * phase;
        const seatX = (cx - 90) + slide;
        const kneeY = cy - 60 * (1 - phase);
        
        // Riel
        ctx.beginPath(); ctx.strokeStyle='#333'; ctx.lineWidth=8;
        ctx.moveTo(cx-180, cy); ctx.lineTo(cx+180, cy); ctx.stroke();
        
        // Cuerpo
        ctx.strokeStyle = color; ctx.lineWidth = 14;
        ctx.beginPath();
        ctx.moveTo(cx-140, cy-20); // Tobillo
        ctx.lineTo((seatX+(cx-140))/2, kneeY); // Rodilla
        ctx.lineTo(seatX, cy-30); // Cadera
        
        // Torso & Swing
        const angle = -20 + (phase * 45); // Swing -20 a +25 grados
        const rad = angle * Math.PI/180;
        const shoulderX = seatX + Math.sin(rad)*110;
        const shoulderY = (cy-30) - Math.cos(rad)*110;
        
        ctx.lineTo(shoulderX, shoulderY); 
        ctx.stroke();

        // Cabeza
        const headX = shoulderX + Math.sin(rad)*20;
        const headY = shoulderY - Math.cos(rad)*20;
        ctx.beginPath(); ctx.arc(headX, headY, 14, 0, Math.PI*2); ctx.fill();

        // Brazos
        let armExt = phase > 0.5 ? 1 - ((phase-0.5)*1.8) : 1;
        const handX = shoulderX - (110 * armExt);
        const handY = shoulderY + 35;
        
        ctx.beginPath(); ctx.moveTo(shoulderX, shoulderY); ctx.lineTo(handX, handY); ctx.stroke();
        
        // Remo (Handle)
        ctx.beginPath(); ctx.strokeStyle='#eee'; ctx.lineWidth=4;
        ctx.moveTo(handX, handY); ctx.lineTo(cx-200, handY); ctx.stroke();

        ctx.restore();
    }

    // ANIMATION LOOP
    let animId=null, lastBeep=0;
    let audioCtx=null;
    
    function startAnim() {
        if(animId) cancelAnimationFrame(animId);
        const loop = () => {
            if(activeRoutine && sessionActive) {
                const step = activeRoutine.steps[stepIdx];
                const target = step.spm || 20;
                const cycle = 60000 / target;
                const now = Date.now();
                
                if(now - lastBeep > cycle) {
                    lastBeep = now;
                    if(audioCtx) {
                       const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                       o.frequency.value = 880; o.connect(g); g.connect(audioCtx.destination);
                       o.start(); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.1);
                       o.stop(audioCtx.currentTime+0.1);
                    }
                }
                
                const p = (now - lastBeep) / cycle;
                let phase = p < 0.4 ? p/0.4 : 1 - ((p-0.4)/0.6); // 40% Drive, 60% Recovery
                phase = Math.max(0, Math.min(1, phase));
                
                if(isRowing) {
                    drawRower(phase, p < 0.4);
                    updateGauge(phase, p < 0.4);
                } else {
                    drawRower(0, true); updateGauge(0, false);
                }
            }
            animId = requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
    }

    // BLUETOOTH
    const connectDev = async (filters, type) => {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters, optionalServices: filters[0].services});
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(filters[0].services[0]);
            
            updateText(type === 'rower' ? 'rower-status' : 'hr-status', dev.name);
            document.getElementById(type === 'rower' ? 'rower-status' : 'hr-status').className = 'status connected';
            requestWakeLock();
            
            // Simulaci√≥n b√°sica de setup de caracter√≠sticas (simplificado para brevedad)
            const chars = await svc.getCharacteristics();
            for(let c of chars) {
                if(c.properties.notify) {
                    await c.startNotifications();
                    c.addEventListener('characteristicvaluechanged', (e) => handleData(e, type));
                }
            }
        } catch(e) { showError(e.message); }
    };

    document.getElementById('connect-rower-btn').onclick = () => connectDev([{services:[0x1826]}], 'rower');
    document.getElementById('connect-hr-btn').onclick = () => connectDev([{services:[0x180D]}], 'hr');

    function handleData(e, type) {
        const v = e.target.value;
        if(type === 'hr') {
            const hr = (v.getUint8(0) & 1) ? v.getUint16(1, true) : v.getUint8(1);
            updateText('heart-rate', hr);
        } else {
            // Remo FTMS simplificado
            if(!sessionActive && !activeRoutine) startSession();
            
            // Detectar stroke rate byte 
            // NOTA: Esto depende del flag byte exacto, asumiendo standard offset
            const spm = v.getUint8(3) / 2; // Ejemplo offset com√∫n
            if(spm > 0) {
                currentSpm = Math.round(spm);
                updateText('stroke-rate', currentSpm);
                isRowing = true;
                if(rowingTimer) clearTimeout(rowingTimer);
                rowingTimer = setTimeout(() => { isRowing=false; updateText('stroke-rate',0); }, 3000);
            }
            // Aqu√≠ ir√≠a el parsing completo de potencia/distancia como en tu c√≥digo original
        }
    }

    // SESSION CONTROL
    function startSession(routine = null) {
        if(sessionActive) return;
        sessionActive = true;
        elapsed = 0; rawEvents = [];
        requestWakeLock();
        dom.dashboard.style.display = 'flex';
        // Auto-hide buttons
        setTimeout(() => dom.controls.classList.add('buttons-hidden'), 2000);
        
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        activeRoutine = routine;
        if(routine) loadStep(0);
        
        sessionTimer = setInterval(() => {
            elapsed++;
            updateText('duration', formatMMSS(elapsed));
            if(activeRoutine) {
                stepTime--;
                document.getElementById('int-timer').textContent = formatMMSS(stepTime);
                document.getElementById('int-progress-bar').style.width = (stepTime / activeRoutine.steps[stepIdx].sec * 100) + '%';
                
                // Feedback visual flechas
                const diff = currentSpm - activeRoutine.steps[stepIdx].spm;
                const arrow = document.getElementById('int-arrow');
                const msg = document.getElementById('int-msg');
                const dash = dom.dashboard;
                
                if(!isRowing) { 
                    arrow.textContent='‚àí'; msg.textContent='REMA'; dash.className=''; 
                } else if(diff < -2) {
                    arrow.textContent='‚ñ≤'; msg.textContent='SUBE'; dash.className='dash-slow'; arrow.className='int-arrow guide-up';
                } else if(diff > 2) {
                    arrow.textContent='‚ñº'; msg.textContent='BAJA'; dash.className='dash-fast'; arrow.className='int-arrow guide-down';
                } else {
                    arrow.textContent='‚óè'; msg.textContent='BIEN'; dash.className='dash-good'; arrow.className='int-arrow guide-ok';
                }

                if(stepTime <= 0) loadStep(stepIdx + 1);
            }
        }, 1000);
        
        startAnim();
    }

    function loadStep(i) {
        if(i >= activeRoutine.steps.length) return endSession();
        stepIdx = i;
        const s = activeRoutine.steps[i];
        stepTime = s.sec;
        updateText('int-phase-name', s.label);
        updateText('int-step-count', `${i+1} / ${activeRoutine.steps.length}`);
        updateText('int-target-spm', s.spm);
    }

    function endSession() {
        clearInterval(sessionTimer);
        cancelAnimationFrame(animId);
        sessionActive = false;
        sessionTimer = null;
        dom.controls.classList.remove('buttons-hidden');
        document.getElementById('main-screen').style.display='none';
        document.getElementById('results-screen').style.display='flex';
        updateText('res-duration', formatMMSS(elapsed));
    }

    document.getElementById('end-session-btn').onclick = endSession;
    document.getElementById('new-session-btn').onclick = () => location.reload();

    // RUTINA MODAL (L√≥gica b√°sica de formulario)
    const modal = document.getElementById('routine-modal');
    document.getElementById('routine-btn').onclick = () => { modal.style.display='flex'; loadRoutineUI(); };
    document.getElementById('close-modal').onclick = () => modal.style.display='none';
    document.getElementById('cancel-routine-btn').onclick = () => modal.style.display='none';
    
    function loadRoutineUI() {
        const c = document.getElementById('intervals-container'); c.innerHTML='';
        addIntRow(300, 18, 'Calentar'); addIntRow(60, 24, 'Fuerza');
    }
    function addIntRow(s, r, l) {
        const c = document.getElementById('intervals-container');
        const d = document.createElement('div'); d.className='interval-row';
        d.innerHTML = `<input type="number" value="${s}"><input type="number" value="${r}"><input type="text" value="${l}"><button onclick="this.parentElement.remove()" style="background:#522">&times;</button>`;
        c.appendChild(d);
    }
    document.getElementById('add-interval-btn').onclick = () => addIntRow(60, 20, 'Intervalo');
    
    document.getElementById('start-routine-btn').onclick = () => {
        const rows = document.querySelectorAll('.interval-row');
        const steps = Array.from(rows).map(r => {
            const i = r.querySelectorAll('input');
            return { sec: parseInt(i[0].value), spm: parseInt(i[1].value), label: i[2].value };
        });
        modal.style.display='none';
        startSession({ steps });
    };

    // INIT
    initGauge();
    drawRower(0, true);
  </script>
</body>
</html>
