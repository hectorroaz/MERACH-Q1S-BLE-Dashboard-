<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Panel Remo - V4 Stable</title>
  <style>
    :root{
      --bg-color:#000000; 
      --card-bg:#141414; 
      --text-main:#ffffff;
      --text-muted:#888888;
      --accent:#03dac6; 
      --alert:#cf6679;
      --guide-slow:#2196f3; --guide-fast:#f44336; --guide-good:#4caf50;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    html,body{height:100%; margin:0; padding:0; overflow:hidden; background:var(--bg-color); font-family:'Segoe UI', sans-serif;}
    
    /* === LAYOUT PRINCIPAL === */
    .container {
      width: 100%; height: 100vh; 
      display: flex; flex-direction: column; 
      position: relative;
    }

    /* HEADER (Solo visible en vertical) */
    header { padding: 10px; text-align: center; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 2px;}

    /* === DASHBOARD SUPERIOR / IZQUIERDO (VISUAL) === */
    #visual-panel {
      position: relative;
      flex: 1; /* Ocupa el espacio sobrante */
      display: flex;
      flex-direction: column;
      background: #080a10;
      overflow: hidden;
      border-bottom: 1px solid #333;
    }

    /* HUD Elements (Texto sobre el canvas) */
    .hud { position: absolute; z-index: 10; pointer-events: none; }
    .hud-tl { top: 15px; left: 15px; } /* Fase */
    .hud-tr { top: 15px; right: 15px; text-align: right; } /* Timer */
    .hud-mid-r { top: 70px; right: 15px; text-align: right; } /* Objetivo */
    
    .hud-title { font-size: 1.4rem; font-weight: 900; font-style: italic; color: #fff; text-transform: uppercase; margin:0; line-height: 1;}
    .hud-sub { font-size: 0.75rem; color: #666; background: #1a1a1a; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px;}
    .hud-time { font-size: 3.5rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; line-height: 0.9; letter-spacing: -2px;}
    .hud-status { color: #ffca28; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}
    
    .hud-target-val { font-size: 2rem; font-weight: 900; color: var(--accent); line-height: 1; }
    .hud-target-lbl { font-size: 0.6rem; color: #666; font-weight: bold; letter-spacing: 1px; }

    /* Feedback Visual (Flechas) */
    .hud-feedback {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        display: flex; align-items: center; gap: 8px;
        background: rgba(20,20,20,0.8); padding: 8px 16px; border-radius: 30px;
        border: 1px solid #333; z-index: 10;
        transition: all 0.2s;
    }
    .fb-arrow { font-size: 1.5rem; line-height: 0.8; }
    .fb-text { font-weight: 800; font-size: 0.9rem; letter-spacing: 1px; color: #fff; }

    /* Canvas Container */
    #canvas-wrapper {
        flex: 1; /* Crece para llenar el panel visual */
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    canvas { width: 100%; height: 100%; display: block; }

    /* Metr√≥nomo (Barra inferior del visual) */
    .metronome-bar {
        height: 6px; width: 100%; display: flex; gap: 2px;
        background: #000; padding: 0 10px 10px 10px; box-sizing: border-box;
        flex-shrink: 0; z-index: 20;
    }
    .metro-seg { flex: 1; background: #222; border-radius: 2px; transition: background 0.1s; }
    .metro-seg.active { box-shadow: 0 0 8px currentColor; opacity: 1; }

    /* Barra de progreso de intervalo (Fina linea azul abajo) */
    .interval-progress { height: 3px; background: #000; width: 100%; flex-shrink: 0; }
    .ip-fill { height: 100%; background: #2979ff; width: 0%; transition: width 1s linear; }

    /* === DATA GRID (DATOS NUM√âRICOS) === */
    #data-panel {
        padding: 10px;
        background: #000;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        flex-shrink: 0; /* No encoger */
    }

    .card {
        background: var(--card-bg); border-radius: 8px; padding: 10px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid #222; min-height: 70px;
    }
    .card-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px;}
    .card-val { font-size: 1.5rem; font-weight: 700; color: #fff; }
    .card-unit { font-size: 0.7rem; color: #555; margin-left: 2px; font-weight: normal;}
    .val-highlight { color: var(--accent); }

    /* === CONTROLES FLOTANTES === */
    .controls {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(10,10,10,0.9); padding: 5px; border-radius: 12px;
        display: flex; gap: 8px; z-index: 100;
        border: 1px solid #333;
        transition: opacity 0.5s, transform 0.5s;
    }
    .controls.hidden { opacity: 0; transform: translate(-50%, 50px); pointer-events: none; }
    
    button {
        background: #333; color: #fff; border: none; padding: 10px 14px;
        border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer;
    }
    button.primary { background: var(--accent); color: #000; }
    button.danger { background: var(--alert); color: #fff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* === MODOS RESPONSIVOS === */
    /* MODO HORIZONTAL (COCKPIT) */
    @media (orientation: landscape) {
        .container { flex-direction: row; }
        header { display: none; }
        
        #visual-panel { 
            width: 60%; height: 100%; 
            border-bottom: none; border-right: 1px solid #333;
        }
        
        /* Ajustar HUD en horizontal */
        .hud-time { font-size: 4.5rem; }
        .hud-mid-r { top: 90px; } /* Bajar objetivo para no chocar con timer */

        #data-panel {
            width: 40%; height: 100%;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
            overflow-y: auto;
            padding-bottom: 60px; /* Espacio para botones */
        }
        
        /* Botones un poco m√°s compactos en horizontal */
        .controls { bottom: 10px; }
    }

    /* Clases de utilidad */
    .color-up { color: var(--guide-slow); } 
    .color-down { color: var(--guide-fast); } 
    .color-good { color: var(--guide-good); }
    
    #err-msg { position: fixed; top: 10px; left: 50%; transform:translateX(-50%); background:#500; color:white; padding:5px 10px; border-radius:5px; font-size:12px; display:none; z-index:9999;}
    
    /* Modales */
    .modal-wrap { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; display:none; justify-content:center; align-items:center;}
    .modal-box { background:#1a1a1a; padding:20px; border-radius:10px; width:90%; max-width:400px; border:1px solid #444; }
    .res-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; color: #ccc;}
  </style>
</head>
<body>

  <div id="err-msg">Error</div>

  <div class="container">
    <header>PANEL REMO PRO V4</header>

    <div id="visual-panel">
        
        <div class="hud hud-tl">
            <h2 class="hud-title" id="lbl-phase">CALENTAR</h2>
            <span class="hud-sub" id="lbl-step">1 / 4</span>
        </div>

        <div class="hud hud-tr">
            <div class="hud-time" id="lbl-timer">00:00</div>
            <div class="hud-status" id="lbl-status">LISTO</div>
        </div>

        <div class="hud hud-mid-r">
            <div class="hud-target-val" id="lbl-target">20</div>
            <div class="hud-target-lbl">OBJETIVO</div>
        </div>

        <div class="hud-feedback" id="feedback-box" style="opacity:0">
            <span class="fb-arrow" id="fb-arrow">‚àí</span>
            <span class="fb-text" id="fb-msg">REMA</span>
        </div>

        <div id="canvas-wrapper">
            <canvas id="main-canvas"></canvas>
        </div>

        <div class="metronome-bar" id="gauge-container"></div>
        <div class="interval-progress"><div class="ip-fill" id="progress-fill"></div></div>
    </div>

    <div id="data-panel">
        <div class="card">
            <div class="card-lbl">Ritmo</div>
            <div class="card-val val-highlight"><span id="val-spm">0</span><span class="card-unit">SPM</span></div>
        </div>
        <div class="card">
            <div class="card-lbl">Potencia</div>
            <div class="card-val"><span id="val-watts">0</span><span class="card-unit">W</span></div>
        </div>
        <div class="card">
            <div class="card-lbl">Pulso</div>
            <div class="card-val"><span id="val-hr">--</span><span class="card-unit">BPM</span></div>
        </div>
        <div class="card">
            <div class="card-lbl">Distancia</div>
            <div class="card-val"><span id="val-dist">0.00</span><span class="card-unit">km</span></div>
        </div>
        <div class="card">
            <div class="card-lbl">Tiempo Total</div>
            <div class="card-val" id="val-total-time">00:00</div>
        </div>
        <div class="card">
            <div class="card-lbl">Pace/500m</div>
            <div class="card-val" id="val-pace">--:--</div>
        </div>
        <div class="card">
            <div class="card-lbl">Calor√≠as</div>
            <div class="card-val" id="val-cal">0</div>
        </div>
        <div class="card">
            <div class="card-lbl">Paladas</div>
            <div class="card-val" id="val-strokes">0</div>
        </div>
    </div>

    <div class="controls" id="controls">
        <button onclick="toggleFullScreen()">‚õ∂</button>
        <button id="btn-conn-rower">üîó Remo</button>
        <button id="btn-conn-hr">‚ù§Ô∏è HR</button>
        <button id="btn-routine" class="primary">‚ö° Rutina</button>
        <button id="btn-end" class="danger">‚èπ Fin</button>
        <button id="btn-csv" disabled>‚¨á CSV</button>
    </div>
  </div>

  <div class="modal-wrap" id="modal-results">
      <div class="modal-box">
          <h2 style="color:white; margin-top:0">Resumen Sesi√≥n</h2>
          <div class="res-row"><span>Tiempo</span><span id="res-time">00:00</span></div>
          <div class="res-row"><span>Distancia</span><span id="res-dist">0.00 km</span></div>
          <div class="res-row"><span>Calor√≠as</span><span id="res-cal">0</span></div>
          <div class="res-row"><span>Ritmo Medio</span><span id="res-spm">0 SPM</span></div>
          <div style="margin-top:20px; display:flex; gap:10px">
              <button class="primary" style="flex:1" onclick="downloadCSV()">Guardar</button>
              <button style="flex:1" onclick="location.reload()">Nuevo</button>
          </div>
      </div>
  </div>

  <div class="modal-wrap" id="modal-routine">
    <div class="modal-box">
        <h3 style="color:white; margin-top:0">Iniciar Rutina</h3>
        <p style="color:#aaa; font-size:12px">Rutina est√°ndar cargada: Calentamiento, Fuerza, Recuperaci√≥n.</p>
        <div style="margin-top:20px; display:flex; justify-content:space-between">
            <button onclick="document.getElementById('modal-routine').style.display='none'">Cancelar</button>
            <button class="primary" onclick="startRoutine()">INICIAR</button>
        </div>
    </div>
  </div>

  <script>
    /* =========================================
       1. GESTI√ìN DEL SISTEMA Y WAKE LOCK
       ========================================= */
    const dom = {
        canvas: document.getElementById('main-canvas'),
        ctx: document.getElementById('main-canvas').getContext('2d'),
        wrapper: document.getElementById('canvas-wrapper'),
        gauge: document.getElementById('gauge-container'),
        controls: document.getElementById('controls'),
        error: document.getElementById('err-msg')
    };

    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => console.log('WakeLock released'));
            }
        } catch(e) { console.log(e); }
    }
    document.addEventListener('visibilitychange', () => {
        if(document.visibilityState === 'visible' && session.active) requestWakeLock();
    });

    function toggleFullScreen() {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if(document.exitFullscreen) document.exitFullscreen();
    }

    // Auto-ocultar controles
    let controlsTimeout;
    function showControls() {
        dom.controls.classList.remove('hidden');
        if(controlsTimeout) clearTimeout(controlsTimeout);
        if(session.active) controlsTimeout = setTimeout(() => dom.controls.classList.add('hidden'), 3000);
    }
    document.body.addEventListener('touchstart', showControls, {passive:true});
    document.body.addEventListener('click', showControls);

    /* =========================================
       2. L√ìGICA DE SESI√ìN Y DATOS
       ========================================= */
    const session = {
        active: false,
        startTime: 0,
        elapsed: 0,
        timer: null,
        isRowing: false,
        lastStrokeTime: 0,
        events: []
    };

    const data = {
        spm: 0, dist: 0, watts: 0, cal: 0, pace: 0, strokes: 0, hr: 0
    };

    const routine = {
        active: false,
        steps: [
            { sec: 300, spm: 18, label: 'Calentar' },
            { sec: 60, spm: 24, label: 'Fuerza' },
            { sec: 120, spm: 20, label: 'Recuperar' },
            { sec: 60, spm: 26, label: 'Sprint' }
        ],
        idx: 0,
        timeLeft: 0
    };

    function updateDisplay() {
        document.getElementById('val-spm').textContent = data.spm;
        document.getElementById('val-watts').textContent = data.watts;
        document.getElementById('val-hr').textContent = data.hr > 0 ? data.hr : '--';
        document.getElementById('val-dist').textContent = (data.dist/1000).toFixed(2);
        document.getElementById('val-cal').textContent = data.cal;
        document.getElementById('val-strokes').textContent = data.strokes;
        document.getElementById('val-total-time').textContent = formatTime(session.elapsed);
        document.getElementById('val-pace').textContent = formatTime(data.pace);
    }

    function formatTime(s) {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    /* =========================================
       3. PARSING BLUETOOTH (CORE CORREGIDO)
       ========================================= */
    document.getElementById('btn-conn-rower').onclick = async () => {
        try {
            const dev = await navigator.bluetooth.requestDevice({
                filters: [{services: [0x1826]}], // FTMS
                optionalServices: [0x1826]
            });
            const server = await dev.gatt.connect();
            const service = await server.getPrimaryService(0x1826);
            const char = await service.getCharacteristic(0x2AD1); // Rower Data
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', parseRowerData);
            document.getElementById('btn-conn-rower').style.color = '#03dac6';
            requestWakeLock();
        } catch(e) { showError('Error BT: ' + e.message); }
    };

    document.getElementById('btn-conn-hr').onclick = async () => {
        try {
            const dev = await navigator.bluetooth.requestDevice({
                filters: [{services: [0x180D]}] 
            });
            const server = await dev.gatt.connect();
            const service = await server.getPrimaryService(0x180D);
            const char = await service.getCharacteristic(0x2A37);
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', e => {
                const v = e.target.value;
                data.hr = (v.getUint8(0) & 1) ? v.getUint16(1, true) : v.getUint8(1);
            });
            document.getElementById('btn-conn-hr').style.color = '#03dac6';
        } catch(e) { showError('Error HR'); }
    };

    function parseRowerData(e) {
        const v = e.target.value;
        const flags = v.getUint16(0, true);
        let offset = 2;

        if(!session.active && !routine.active) startSession();

        // 1. Stroke Rate (Siempre presente o casi siempre)
        // Algunos remos env√≠an uint8, otros uint16. Asumimos standard byte.
        const spmRaw = v.getUint8(offset); 
        data.spm = Math.round(spmRaw / 2); // Standard FTMS suele ser rate * 2
        offset += 1;

        // Detectar si estamos remando
        if(data.spm > 0) {
            session.isRowing = true;
            session.lastStrokeTime = Date.now();
            document.getElementById('lbl-status').textContent = "REMANDO";
            document.getElementById('lbl-status').style.color = "#4caf50";
        }

        // 2. Stroke Count
        data.strokes = v.getUint16(offset, true);
        offset += 2;

        // 3. Average Speed (Saltamos si existe)
        if(flags & 0x0001) offset += 2;

        // 4. Total Distance (Uint24)
        if(flags & 0x0002) {
            data.dist = v.getUint16(offset, true) | (v.getUint8(offset+2) << 16);
            offset += 3;
        }

        // 5. Instantaneous Pace (Uint16)
        if(flags & 0x0004) {
            data.pace = v.getUint16(offset, true);
            offset += 2;
        }

        // 6. Average Power (Saltar)
        if(flags & 0x0008) offset += 2;

        // 7. Instantaneous Power (Sint16)
        if(flags & 0x0010) {
            data.watts = v.getInt16(offset, true);
            offset += 2;
        }

        // 8. Energy (Total/PerHour)
        if(flags & 0x0020) offset += 5; // Energy Total + Per Hour
        
        // 9. Energy Per Minute (Calorias actuales a veces aqui)
        // ... simplificado, usamos el Total Energy field standard:
        if(flags & 0x0100) { // Flag espec√≠fico de Expended Energy
             data.cal = v.getUint16(offset, true);
             // offset += ...
        }

        // Guardar evento
        if(session.active) {
            session.events.push({
                t: session.elapsed,
                spm: data.spm, w: data.watts, hr: data.hr
            });
        }
    }

    /* =========================================
       4. ANIMACI√ìN Y CANVAS (CORREGIDO)
       ========================================= */
    // Resize Observer para el Canvas: CRUCIAL para evitar pantalla negra
    const resizeObserver = new ResizeObserver(entries => {
        for(let entry of entries) {
            const {width, height} = entry.contentRect;
            const dpr = window.devicePixelRatio || 1;
            dom.canvas.width = width * dpr;
            dom.canvas.height = height * dpr;
            // No dibujamos aqu√≠, el loop se encarga
        }
    });
    resizeObserver.observe(dom.wrapper);

    // Inicializar Metr√≥nomo
    function initGauge() {
        dom.gauge.innerHTML = '';
        for(let i=0; i<20; i++) {
            let d = document.createElement('div');
            d.className = 'metro-seg';
            // Colores por √≠ndice
            if(i<5) d.style.color = 'var(--guide-good)'; 
            else if(i<10) d.style.color = '#ffeb3b';
            else if(i<15) d.style.color = '#ff9800';
            else d.style.color = 'var(--guide-fast)';
            dom.gauge.appendChild(d);
        }
    }
    initGauge();

    function drawRower(phase) {
        const ctx = dom.ctx;
        const w = dom.canvas.width;
        const h = dom.canvas.height;
        
        ctx.clearRect(0, 0, w, h);
        
        // Configurar escala para mantener proporciones
        // Usamos un tama√±o virtual de 500x300
        const scale = Math.min(w / 500, h / 300) * 0.9; 
        const offsetX = (w - (500*scale)) / 2;
        const offsetY = (h - (300*scale)) / 2;

        ctx.save();
        ctx.translate(offsetX, offsetY);
        ctx.scale(scale, scale);

        // Interpolaci√≥n de color (Verde -> Rojo segun fase de fuerza)
        // Drive es 0.0 a 0.4 aprox.
        let r=76, g=175, b=80; // Verde base
        if(phase < 0.5) { // Fase de fuerza (Drive)
            const stress = phase / 0.5; // 0 a 1
            r = 76 + (244-76)*stress;
            g = 175 + (67-175)*stress;
            b = 80 + (54-80)*stress;
        }
        
        const color = `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Dibujo Stickman
        const cx = 250, cy = 220;
        const slideLen = 160;
        
        // Fase aplicada a la posici√≥n
        const seatSlide = slideLen * phase;
        const seatX = (cx - 80) + seatSlide;
        
        // Riel
        ctx.beginPath(); ctx.strokeStyle='#333'; ctx.lineWidth=10;
        ctx.moveTo(cx-180, cy+20); ctx.lineTo(cx+180, cy+20); ctx.stroke();

        // Piernas
        ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=18;
        const ankleX = cx - 140; const ankleY = cy;
        const kneeX = (ankleX + seatX) / 2;
        const kneeY = cy - 60 * (1-phase); // Sube las rodillas en la recuperaci√≥n
        ctx.moveTo(ankleX, ankleY); ctx.lineTo(kneeX, kneeY); ctx.lineTo(seatX, cy-10); ctx.stroke();

        // Torso
        const swing = -20 + (phase * 40); // Angulo espalda
        const rad = swing * Math.PI / 180;
        const shoulderX = seatX + Math.sin(rad)*110;
        const shoulderY = (cy-10) - Math.cos(rad)*110;
        
        ctx.beginPath(); ctx.moveTo(seatX, cy-10); ctx.lineTo(shoulderX, shoulderY); ctx.stroke();

        // Cabeza
        const headX = shoulderX + Math.sin(rad)*25;
        const headY = shoulderY - Math.cos(rad)*25;
        ctx.beginPath(); ctx.arc(headX, headY, 18, 0, Math.PI*2); ctx.fill();

        // Brazos
        let armExt = 0;
        // Fase 0 (Catch) -> Brazos estirados (1.0)
        // Fase 0.5 (Finish) -> Brazos flexionados (0.0)
        if(phase < 0.5) armExt = 1; 
        else {
             // Recuperaci√≥n: estirar brazos r√°pido
             armExt = (phase - 0.5) * 2; 
        }
        
        // Simplificaci√≥n visual: Brazos estirados al inicio, encogidos al final
        const armLen = 100;
        // Logic fix: Handle position relative to shoulder
        const handX = shoulderX - (armLen * (phase > 0.4 && phase < 0.6 ? 0.2 : 0.9)); // Simplificado
        const handY = shoulderY + 40;

        ctx.beginPath(); ctx.lineWidth=14;
        ctx.moveTo(shoulderX, shoulderY); ctx.lineTo(handX, handY); ctx.stroke();

        // Mango remo
        ctx.beginPath(); ctx.strokeStyle='#eee'; ctx.lineWidth=6;
        ctx.moveTo(handX, handY); ctx.lineTo(cx-200, handY); ctx.stroke();

        ctx.restore();
    }

    // Animation Loop (Render Loop)
    let lastTime = 0;
    function animate(timestamp) {
        if (!lastTime) lastTime = timestamp;
        
        // Calcular fase del ciclo basada en SPM objetivo
        let phase = 0;
        if(routine.active) {
            const step = routine.steps[routine.idx];
            const targetSPM = step.spm;
            const cycleDuration = 60000 / targetSPM;
            const cycleOffset = timestamp % cycleDuration;
            
            // 0.0 -> 1.0 (Catch -> Finish -> Recovery -> Catch)
            // Asumimos Drive ratio 1:2 aprox
            let rawPhase = cycleOffset / cycleDuration;
            
            // Mapeamos para que la animaci√≥n se vea natural
            // 0.0 - 0.4: Drive (Fuerza)
            // 0.4 - 1.0: Recovery (Recuperaci√≥n)
            if(rawPhase < 0.4) {
                phase = rawPhase / 0.4; // 0 a 1 rapido
            } else {
                phase = 1 - ((rawPhase - 0.4) / 0.6); // 1 a 0 lento
            }
        }

        drawRower(phase);
        updateMetronome(phase);
        updateDisplay();

        // Reset estado si no remamos
        if(Date.now() - session.lastStrokeTime > 4000 && session.isRowing) {
            session.isRowing = false;
            document.getElementById('lbl-status').textContent = "PAUSA";
            document.getElementById('lbl-status').style.color = "#ffd700";
        }

        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    function updateMetronome(phase) {
        const segs = dom.gauge.children;
        // phase va de 0 a 1. Mapeamos a 20 segmentos.
        const activeIdx = Math.floor(phase * 20);
        
        for(let i=0; i<20; i++) {
            if(i <= activeIdx) {
                segs[i].classList.add('active');
                segs[i].style.backgroundColor = segs[i].style.color; // Usar color guardado
            } else {
                segs[i].classList.remove('active');
                segs[i].style.backgroundColor = '#222';
            }
        }
    }

    /* =========================================
       5. RUTINA & FEEDBACK
       ========================================= */
    document.getElementById('btn-routine').onclick = () => {
        document.getElementById('modal-routine').style.display = 'flex';
    };

    window.startRoutine = function() {
        document.getElementById('modal-routine').style.display = 'none';
        startSession(true);
    };

    function startSession(isRoutine = false) {
        if(session.active) return;
        session.active = true;
        session.startTime = Date.now();
        document.getElementById('btn-csv').disabled = false;
        showControls(); // Trigger auto hide

        if(isRoutine) {
            routine.active = true;
            routine.idx = 0;
            loadStep(0);
        }

        session.timer = setInterval(() => {
            session.elapsed++;
            
            if(routine.active) {
                routine.timeLeft--;
                document.getElementById('lbl-timer').textContent = formatTime(routine.timeLeft);
                
                // Barra progreso intervalo
                const stepTotal = routine.steps[routine.idx].sec;
                const pct = ((stepTotal - routine.timeLeft) / stepTotal) * 100;
                document.getElementById('progress-fill').style.width = pct + "%";

                // Feedback
                const target = routine.steps[routine.idx].spm;
                const diff = data.spm - target;
                const box = document.getElementById('feedback-box');
                const arrow = document.getElementById('fb-arrow');
                const msg = document.getElementById('fb-msg');

                box.style.opacity = session.isRowing ? 1 : 0;
                
                if(diff < -2) { // Muy lento
                    box.className = 'hud-feedback color-up';
                    arrow.textContent = '‚ñ≤'; msg.textContent = 'SUBE';
                } else if (diff > 2) { // Muy rapido
                    box.className = 'hud-feedback color-down';
                    arrow.textContent = '‚ñº'; msg.textContent = 'BAJA';
                } else {
                    box.className = 'hud-feedback color-good';
                    arrow.textContent = '‚óè'; msg.textContent = 'BIEN';
                }

                if(routine.timeLeft <= 0) {
                    routine.idx++;
                    if(routine.idx >= routine.steps.length) finishSession();
                    else loadStep(routine.idx);
                }
            }
        }, 1000);
    }

    function loadStep(i) {
        const s = routine.steps[i];
        routine.timeLeft = s.sec;
        document.getElementById('lbl-phase').textContent = s.label;
        document.getElementById('lbl-step').textContent = `${i+1} / ${routine.steps.length}`;
        document.getElementById('lbl-target').textContent = s.spm;
    }

    function finishSession() {
        clearInterval(session.timer);
        session.active = false;
        routine.active = false;
        
        document.getElementById('res-time').textContent = formatTime(session.elapsed);
        document.getElementById('res-dist').textContent = (data.dist/1000).toFixed(2) + " km";
        document.getElementById('res-cal').textContent = data.cal;
        
        // Calculo SPM medio simple
        const sum = session.events.reduce((acc, e) => acc + e.spm, 0);
        const avg = session.events.length ? Math.round(sum / session.events.length) : 0;
        document.getElementById('res-spm').textContent = avg + " SPM";

        document.getElementById('modal-results').style.display = 'flex';
    }
    
    document.getElementById('btn-end').onclick = finishSession;

    /* =========================================
       6. UTILIDADES CSV & ERROR
       ========================================= */
    function showError(msg) {
        dom.error.textContent = msg;
        dom.error.style.display = 'block';
        setTimeout(() => dom.error.style.display = 'none', 4000);
    }

    window.downloadCSV = function() {
        let csv = "Time,SPM,Watts,HR\n";
        session.events.forEach(e => {
            csv += `${e.t},${e.spm},${e.w},${e.hr}\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'remo_session.csv';
        a.click();
    };

  </script>
</body>
</html>
