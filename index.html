<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard v2.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f172a;color:#f8fafc;font-family:'Inter',system-ui,Roboto,sans-serif}
.card{background:#1e293b;border-radius:1rem;padding:1rem;margin-bottom:1rem}
.btn{padding:.65rem 1rem;border-radius:.75rem;font-weight:700;transition:.2s all}
.btn:hover{filter:brightness(1.08)}
.metric-main{font-size:2.4rem;font-weight:800;line-height:1}
.metric-label{font-size:.8rem;color:#94a3b8;margin-top:.25rem}
.log-box{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem;background:#0b1222;padding:.6rem;border-radius:.6rem;max-height:200px;overflow:auto;white-space:pre-wrap}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;margin-top:.8rem}
</style>
</head>
<body class="min-h-screen flex flex-col items-center px-3 py-4">

<header class="text-center mb-4">
  <h1 class="text-2xl font-extrabold text-blue-400">MERACH Q1S ‚Äì FTMS + HR Dashboard</h1>
  <p class="text-gray-400 text-sm mt-1">v2.0 ¬∑ Correcci√≥n distancia + interfaz limpia</p>
</header>

<!-- Controles -->
<div class="card w-full max-w-5xl text-center">
  <div class="flex flex-wrap justify-center gap-2 mb-2">
    <button id="btnConnectFTMS" class="btn bg-blue-600 text-white">Conectar Rower</button>
    <button id="btnDisconnectFTMS" class="btn bg-gray-600 text-white" disabled>Desconectar</button>
    <button id="wakeLockBtn" class="btn bg-indigo-600 text-white">Mantener pantalla activa</button>
    <button id="exportCSV" class="btn bg-sky-600 text-white">Exportar CSV</button>
  </div>
  <p id="status" class="text-sm text-gray-300">Estado FTMS: Desconectado</p>
</div>

<!-- HR -->
<div class="card w-full max-w-5xl text-center">
  <h2 class="text-lg font-semibold mb-2">Sensor Card√≠aco BLE</h2>
  <div class="flex flex-wrap justify-center gap-2">
    <button id="connectHRBtn" class="btn bg-red-600 text-white">‚ù§Ô∏è Conectar HR</button>
    <button id="disconnectHRBtn" class="btn bg-gray-700 text-white" disabled>üîå Desconectar</button>
  </div>
  <p id="hrStatus" class="text-sm text-gray-300 mt-2">Estado: Desconectado</p>
  <div id="hrDisplay" class="metric-main text-red-400 mt-1">0 bpm</div>
</div>

<!-- M√©tricas principales -->
<div class="card w-full max-w-5xl text-center">
  <div class="grid3">
    <div><div id="mainSPM" class="metric-main text-blue-400">0</div><div class="metric-label">SPM</div></div>
    <div><div id="mainHR" class="metric-main text-rose-400">0</div><div class="metric-label">BPM</div></div>
    <div><div id="mainStrokes" class="metric-main text-amber-400">0</div><div class="metric-label">STROKES</div></div>
  </div>
  <div class="grid2">
    <div><div id="mainDist" class="metric-main text-emerald-400">0.00</div><div class="metric-label">KM</div></div>
    <div><div id="mainPower" class="metric-main text-cyan-400">0</div><div class="metric-label">W</div></div>
  </div>
</div>

<!-- M√©tricas en vivo -->
<div class="card w-full max-w-5xl">
  <h3 class="text-lg font-semibold mb-2">M√©tricas en vivo</h3>
  <table class="w-full text-sm">
    <thead><tr><th class="text-left">Par√°metro</th><th class="text-right">Valor</th><th class="text-right">Detalle</th></tr></thead>
    <tbody id="metricsBody"></tbody>
  </table>
</div>

<!-- Log -->
<div class="card w-full max-w-5xl">
  <h3 class="text-lg font-semibold mb-2">Registro</h3>
  <div id="log" class="log-box"></div>
</div>

<script>
let deviceFTMS,charFTMS,deviceHR,charHR,wakeLock;
let dataLog=[],metrics={};
const logBox=document.getElementById('log');
function log(m){const t=new Date().toLocaleTimeString();logBox.textContent+=`[${t}] ${m}\n`;logBox.scrollTop=logBox.scrollHeight;}

function updateUI(){
  mainSPM.textContent=metrics.strokeRate||0;
  mainHR.textContent=metrics.heartRate||0;
  mainStrokes.textContent=metrics.strokeCount||0;
  mainDist.textContent=(metrics.totalDistance||0).toFixed(2);
  mainPower.textContent=metrics.instantPower||0;

  const rows=[
    ["Total Distance",(metrics.totalDistance||0).toFixed(2),"Km"],
    ["Heart Rate",metrics.heartRate||0,"Sensor BLE"],
    ["Stroke Count",metrics.strokeCount||0,"Total remadas"],
    ["Stroke Rate",metrics.strokeRate||0,"Brazadas/min"],
    ["Instant Power",metrics.instantPower||0,"W"]
  ];
  document.getElementById('metricsBody').innerHTML=rows.map(r=>`<tr><td>${r[0]}</td><td class='text-right font-semibold'>${r[1]}</td><td class='text-right text-gray-400'>${r[2]}</td></tr>`).join("");
}

async function connectFTMSDevice(){
  const btn=document.getElementById("btnConnectFTMS");btn.disabled=true;
  try{
    deviceFTMS=await navigator.bluetooth.requestDevice({
      filters:[{services:[0x1826]}],
      optionalServices:[0x1826,0xF8C0,0xFFF0,0x180A]
    });
    const server=await deviceFTMS.gatt.connect();
    const services=await server.getPrimaryServices();
    let service=services.find(s=>s.uuid.includes("1826"))||services.find(s=>s.uuid.includes("f8c0"))||services.find(s=>s.uuid.includes("fff0"));
    const chars=await service.getCharacteristics();
    charFTMS=chars.find(c=>c.uuid.includes("2ad2"))||chars.find(c=>c.uuid.includes("2ad1"))||chars[0];
    await charFTMS.startNotifications();
    charFTMS.addEventListener("characteristicvaluechanged",handleFTMS);
    document.getElementById("status").textContent="Estado FTMS: Conectado";
    document.getElementById("btnDisconnectFTMS").disabled=false;
    log("‚úÖ FTMS conectado ("+service.uuid+") ‚Üí Char: "+charFTMS.uuid);
  }catch(e){log("‚ùå Error FTMS: "+e);}
  finally{btn.disabled=false;}
}

function handleFTMS(event){
  const dv=event.target.value;
  if(dv.byteLength<6)return;
  try{
    const flag=dv.getUint16(0,true);
    let idx=2;
    if(flag&0x1){metrics.instantPower=dv.getUint16(idx,true);idx+=2;}
    if(flag&0x2){metrics.strokeRate=dv.getUint8(idx++);}
    if(flag&0x4){metrics.strokeCount=dv.getUint16(idx,true);idx+=2;}
    if(flag&0x8){metrics.totalDistance=dv.getUint32(idx,true)/100;} // CORREGIDO: metros ‚Üí km
  }catch(e){log("‚ö†Ô∏è Parse error: "+e);}
  updateUI();
  dataLog.push({...metrics,t:Date.now()});
}

async function connectHR(){
  try{
    deviceHR=await navigator.bluetooth.requestDevice({filters:[{services:[0x180D]}]});
    const server=await deviceHR.gatt.connect();
    const svc=await server.getPrimaryService(0x180D);
    charHR=await svc.getCharacteristic(0x2A37);
    await charHR.startNotifications();
    charHR.addEventListener("characteristicvaluechanged",ev=>{
      const v=ev.target.value;metrics.heartRate=v.getUint8(1)||0;
      hrDisplay.textContent=metrics.heartRate+" bpm";updateUI();
    });
    hrStatus.textContent="Estado: Conectado";disconnectHRBtn.disabled=false;
    log("‚ù§Ô∏è Sensor HR conectado");
  }catch(e){log("‚ùå Error HR: "+e);}
}

document.getElementById("btnConnectFTMS").onclick=connectFTMSDevice;
document.getElementById("btnDisconnectFTMS").onclick=()=>{if(deviceFTMS)deviceFTMS.gatt.disconnect();status.textContent="Estado FTMS: Desconectado";};
document.getElementById("connectHRBtn").onclick=connectHR;
document.getElementById("disconnectHRBtn").onclick=()=>{if(deviceHR)deviceHR.gatt.disconnect();hrStatus.textContent="Estado: Desconectado";hrDisplay.textContent="0 bpm";};
document.getElementById("wakeLockBtn").onclick=async()=>{try{wakeLock=await navigator.wakeLock.request("screen");wakeLockBtn.textContent="Pantalla activa ‚úÖ";}catch{alert("No soportado.");}};
document.getElementById("exportCSV").onclick=()=>{
  let csv="time,SPM,HR,Strokes,Dist,Power\n";
  dataLog.forEach(d=>csv+=`${d.t},${d.strokeRate||0},${d.heartRate||0},${d.strokeCount||0},${d.totalDistance||0},${d.instantPower||0}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="merach_q1s.csv";a.click();
};
</script>
</body>
</html>
