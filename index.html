<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard v1.4</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{background:#0f172a;color:#f8fafc;font-family:'Inter',system-ui,Segoe UI,Roboto,sans-serif}
  .card{background:#1e293b;border-radius:1rem;padding:1rem;margin-bottom:1rem}
  .btn{padding:.65rem 1rem;border-radius:.75rem;font-weight:700;transition:.2s all}
  .btn:hover{filter:brightness(1.08)}
  .metric-main{font-size:3.2rem;font-weight:800;line-height:1}
  .metric-label{font-size:.9rem;color:#94a3b8;margin-top:.25rem}
  .log-box{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem;background:#0b1222;padding:.6rem;border-radius:.6rem;max-height:200px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body class="min-h-screen flex flex-col items-center px-3 py-4">

<header class="text-center mb-4">
  <h1 class="text-2xl font-extrabold text-blue-400">MERACH Q1S ‚Äì Web Bluetooth FTMS + HR Dashboard</h1>
  <p class="text-gray-400 text-sm mt-1">v1.4 ¬∑ FTMS + Heart Rate BLE</p>
</header>

<!-- CONTROLES FTMS -->
<div class="card w-full max-w-lg text-center">
  <div class="flex flex-wrap justify-center gap-2 mb-2">
    <button id="connectFTMS" class="btn bg-blue-600 text-white">Conectar Rower</button>
    <button id="disconnectFTMS" class="btn bg-gray-600 text-white" disabled>Desconectar</button>
    <button id="wakeLockBtn" class="btn bg-indigo-600 text-white">Mantener pantalla activa</button>
    <button id="exportCSV" class="btn bg-sky-600 text-white">Exportar CSV</button>
  </div>
  <p id="status" class="text-sm text-gray-300 mt-1">Estado FTMS: Desconectado</p>
</div>

<!-- SENSOR CARD√çACO -->
<div class="card w-full max-w-lg text-center">
  <h2 class="text-lg font-semibold mb-2">Sensor Card√≠aco BLE</h2>
  <div class="flex flex-wrap justify-center gap-2">
    <button id="connectHRBtn" class="btn bg-red-600 text-white">‚ù§Ô∏è Conectar HR</button>
    <button id="disconnectHRBtn" class="btn bg-gray-700 text-white" disabled>üîå Desconectar</button>
  </div>
  <p id="hrStatus" class="text-sm text-gray-300 mt-2">Estado: Desconectado</p>
  <div id="hrDisplay" class="metric-main text-red-400 mt-1">0 bpm</div>
</div>

<!-- HUD PRINCIPAL -->
<div class="card w-full max-w-lg text-center">
  <div class="grid grid-cols-3 gap-4">
    <div><div id="mainSPM" class="metric-main text-blue-400">0</div><div class="metric-label">SPM</div></div>
    <div><div id="mainW" class="metric-main text-amber-400">0</div><div class="metric-label">W</div></div>
    <div><div id="mainHR" class="metric-main text-rose-400">0</div><div class="metric-label">BPM</div></div>
  </div>
</div>

<!-- M√âTRICAS DETALLADAS -->
<div class="card w-full max-w-lg">
  <h3 class="text-lg font-semibold mb-2">M√©tricas en vivo</h3>
  <table class="w-full text-sm">
    <thead><tr><th class="text-left">Par√°metro</th><th class="text-right">Valor</th><th class="text-right">Detalle</th></tr></thead>
    <tbody id="metricsBody"></tbody>
  </table>
</div>

<!-- REGISTRO -->
<div class="card w-full max-w-lg">
  <h3 class="text-lg font-semibold mb-2">Registro</h3>
  <div id="log" class="log-box"></div>
</div>

<script>
let deviceFTMS,charFTMS,deviceHR,charHR,wakeLock;
let dataLog=[],metrics={},lastPower=0,lastSPM=0,lastPace=0,lastHR=0;
function log(msg){const t=new Date().toLocaleTimeString();logBox.textContent+=`[${t}] ${msg}\n`;logBox.scrollTop=logBox.scrollHeight;}
const metricsBody=document.getElementById('metricsBody');
const logBox=document.getElementById('log');
function updateUI(){
  mainSPM.textContent=metrics.strokeRate??lastSPM;
  mainW.textContent=metrics.instantPower??lastPower;
  mainHR.textContent=metrics.heartRate??lastHR;
  metricsBody.innerHTML="";
  const rows=[
    ["Total Distance",metrics.totalDistance?.toFixed(3)||"0","Distancia"],
    ["Heart Rate",metrics.heartRate||0,"Sensor BLE"],
    ["Stroke Count",metrics.strokeCount||0,"Total remadas"],
    ["Avg Stroke Rate",metrics.avgStrokeRate||0,"Promedio"],
    ["Instant Power",metrics.instantPower||0,"W"],
    ["Stroke Rate",metrics.strokeRate||0,"Brazadas/min"],
    ["Pace",metrics.pace?formatPace(metrics.pace):"0","s/500 m"]
  ];
  for(const [p,v,d]of rows){
    metricsBody.innerHTML+=`<tr><td>${p}</td><td class="text-right font-semibold">${v}</td><td class="text-right text-gray-400">${d}</td></tr>`;
  }
}
function formatPace(val){const min=Math.floor(val/60),sec=(val%60).toFixed(1).padStart(4,'0');return`${min}:${sec}/500m`;}
async function connectFTMS(){
  try{
    deviceFTMS=await navigator.bluetooth.requestDevice({
      filters:[{services:[0x1826]}],
      optionalServices:[0x1826,0x180A,0xF8C0,0xFFF0]
    });
    const server=await deviceFTMS.gatt.connect();
    const services=await server.getPrimaryServices();
    let service=services.find(s=>s.uuid.includes("1826"))||services.find(s=>s.uuid.includes("f8c0"))||services.find(s=>s.uuid.includes("fff0"));
    if(!service)throw new Error("No se encontr√≥ servicio FTMS/F8C0/FFF0");
    const chars=await service.getCharacteristics();
    charFTMS=chars.find(c=>c.uuid.includes("2ad2"))||chars.find(c=>c.uuid.includes("2ad1"))||chars[0];
    await charFTMS.startNotifications();
    charFTMS.addEventListener("characteristicvaluechanged",handleFTMS);
    status.textContent="Estado FTMS: Conectado";
    disconnectFTMS.disabled=false;
    log("‚úÖ FTMS conectado ("+charFTMS.uuid+")");
  }catch(e){log("‚ùå Error FTMS: "+e);}
}
function handleFTMS(event){
  const dv=event.target.value;
  // simulaci√≥n simplificada para mantener cero si no hay update
  lastSPM=metrics.strokeRate||0;lastPower=metrics.instantPower||0;lastPace=metrics.pace||0;
  // Decodifica datos (solo si contiene bytes)
  if(dv.byteLength>4){
    const flag=dv.getUint16(0,true);
    let idx=2;
    if(flag&0x1){metrics.instantPower=dv.getUint16(idx,true);idx+=2;}
    if(flag&0x2){metrics.strokeRate=dv.getUint8(idx++);}
    if(flag&0x4){metrics.strokeCount=dv.getUint16(idx,true);idx+=2;}
    if(flag&0x8){metrics.totalDistance=dv.getUint32(idx,true)/1000;idx+=4;}
    if(flag&0x10){metrics.pace=dv.getUint16(idx,true)/10;idx+=2;}
  }
  updateUI();
  dataLog.push({...metrics,t:Date.now()});
}
async function connectHR(){
  try{
    deviceHR=await navigator.bluetooth.requestDevice({filters:[{services:[0x180D]}]});
    const server=await deviceHR.gatt.connect();
    const service=await server.getPrimaryService(0x180D);
    charHR=await service.getCharacteristic(0x2A37);
    await charHR.startNotifications();
    charHR.addEventListener("characteristicvaluechanged",handleHR);
    hrStatus.textContent="Estado: Conectado";
    disconnectHRBtn.disabled=false;
    log("‚ù§Ô∏è Sensor HR conectado");
  }catch(e){log("‚ùå Error HR: "+e);}
}
function handleHR(e){
  const v=e.target.value;
  let hr=v.getUint8(1);
  metrics.heartRate=hr;lastHR=hr;
  hrDisplay.textContent=hr+" bpm";updateUI();
}
disconnectFTMS.onclick=()=>{if(deviceFTMS)deviceFTMS.gatt.disconnect();status.textContent="Estado FTMS: Desconectado";};
disconnectHRBtn.onclick=()=>{if(deviceHR)deviceHR.gatt.disconnect();hrStatus.textContent="Estado: Desconectado";hrDisplay.textContent="0 bpm";};
connectFTMS.onclick=connectFTMS;
connectHRBtn.onclick=connectHR;
wakeLockBtn.onclick=async()=>{try{wakeLock=await navigator.wakeLock.request("screen");wakeLockBtn.textContent="Pantalla activa ‚úÖ";}catch(e){alert("No soportado en este navegador.");}};
exportCSV.onclick=()=>{let csv="time,SPM,W,HR,Dist,Count,Pace\n";dataLog.forEach(d=>{csv+=`${d.t},${d.strokeRate||0},${d.instantPower||0},${d.heartRate||0},${d.totalDistance||0},${d.strokeCount||0},${d.pace||0}\n`});const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="merach_q1s.csv";a.click();};
</script>
</body>
</html>
