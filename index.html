<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- Viewport cr√≠tico para m√≥viles -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Panel Remo - Mobile Pro</title>
  <style>
    :root{
      --bg-color:#121212; --card-color:#1e1e1e; --text-color:#e0e0e0;
      --primary-color:#03dac6; --secondary-color:#bb86fc; --accent-color:#cf6679;
      --interval-bg:#1a2639; --interval-text:#ffffff; 
      --guide-fast:#f44336; --guide-slow:#2196f3; --guide-good:#4caf50;
    }
    
    html,body{height:100%; margin:0; padding:0; overflow-x:hidden; overflow-y:auto;}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:10px;
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* Contenedor principal */
    .container{width:100%; max-width:900px; display:flex; flex-direction:column; position:relative; padding-bottom: 60px;}
    
    header{text-align:center; padding:5px 0;}
    h1{font-size:1.2rem; margin:0; opacity: 0.8;}
    
    /* Botones */
    .buttons{display:flex; justify-content:center; gap:8px; margin:5px 0 10px 0; flex-wrap:wrap;}
    button{
        padding:10px 14px; font-size:13px; border:none; border-radius:8px; 
        cursor:pointer; background:var(--primary-color); color:var(--bg-color); 
        font-weight:bold; transition:all .2s; flex: 1 1 auto; min-width: 100px;
        touch-action: manipulation;
    }
    button:active{transform:scale(0.96);}
    button:disabled{background:#444; color:#888;}
    #end-session-btn{background:var(--accent-color); color: white;}
    #export-btn{background:var(--secondary-color);}
    #routine-btn{background:#3f51b5; color:white;}

    /* Status Bar */
    .status-bar{display:flex; justify-content:space-between; background:var(--card-color); padding:8px 12px; border-radius:6px; margin-bottom:10px; font-size:10px; text-align:center; gap: 5px;}
    .connected{color:var(--primary-color); font-weight: bold;} .disconnected{color:var(--accent-color);}

    /* === DASHBOARD DE INTERVALOS === */
    #interval-dashboard {
        display: none; 
        background: var(--interval-bg);
        border: 2px solid #444;
        border-radius: 12px;
        padding: 10px;
        flex-direction: column;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden; 
        transition: border-color 0.3s ease;
    }
    
    .dash-slow { border-color: var(--guide-slow) !important; box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.2); }
    .dash-fast { border-color: var(--guide-fast) !important; box-shadow: inset 0 0 20px rgba(244, 67, 54, 0.2); }
    .dash-good { border-color: var(--guide-good) !important; box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.2); }

    .int-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; z-index: 5; position: relative;}
    .int-phase-info { display: flex; flex-direction: column; max-width: 55%; }
    .int-phase-name { font-size: 1.3rem; font-weight: 900; color: white; font-style: italic; text-transform: uppercase; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.5);}
    .int-step-count { background: #0f1724; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; color: #aaa; font-weight: bold; margin-top: 4px; width: fit-content; }
    
    .int-timer-block { text-align: right; }
    .int-timer-big { font-size: 2.2rem; font-weight: bold; color: white; line-height: 0.9; font-family: monospace; }
    .int-timer-status { font-size: 0.6rem; color: #ffd700; font-weight: bold; text-transform: uppercase;}

    .int-main-visual { 
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 5px;
        align-items: center; 
        position: relative; 
        z-index: 2;
    }

    .center-viz-container { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; }
    .rower-container { position: relative; width: 100%; display: flex; justify-content: center; align-items: flex-end; }
    
    canvas#rower-canvas {
        width: 100% !important;
        height: auto !important;
        max-width: 500px;
        aspect-ratio: 450/220;
    }

    .rower-overlay-text { position: absolute; top: 10px; right: 10px; text-align: right; pointer-events: none; }
    .target-big { font-size: 2rem; font-weight: 900; color: white; opacity: 0.9; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
    .target-lbl { font-size: 0.6rem; color: var(--primary-color); text-transform: uppercase; font-weight: bold;}

    .int-guidance { 
        position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
        text-align: center; display: flex; flex-direction: column; align-items: center; 
        pointer-events: none; 
    }
    .int-arrow { font-size: 3rem; line-height: 0.8; transition: all 0.3s ease; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .int-guidance-text { font-weight: 900; font-size: 1rem; letter-spacing: 1px; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 4px;}

    .int-right-col { display: flex; flex-direction: row; justify-content: space-around; width: 100%; margin-top: 5px; align-items: center;}
    .int-actual-val { text-align: center; }
    .int-actual-num { font-size: 2.8rem; font-weight: bold; color: white; line-height: 1; }
    .int-actual-lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; }

    .next-interval-box { background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 6px; border-left: 3px solid #555; text-align: left; }
    .next-lbl { font-size: 0.55rem; color: #aaa; text-transform: uppercase; display: block;}
    .next-val { font-size: 0.85rem; color: white; font-weight: bold;}

    .linear-gauge-container { width: 90%; height: 8px; display: flex; gap: 2px; margin-top: 5px; }
    .gauge-segment { flex: 1; background: #333; border-radius: 2px; }
    .gauge-segment.active { opacity: 1; box-shadow: 0 0 5px currentColor; }
    
    .int-progress-container { width: 100%; height: 4px; background: #0f1724; border-radius: 2px; margin-top: 10px;}
    .int-progress-bar { height: 100%; background: #2aa7ff; width: 100%; transition: width 1s linear; }

    .guide-up { color: var(--guide-slow); } .guide-down { color: var(--guide-fast); } .guide-ok { color: var(--guide-good); } 

    /* M√©tricas Generales */
    .dashboard{display:flex; flex-direction:column; gap:10px; width:100%}
    .metrics-row{display:flex; gap:8px; justify-content:center; flex-wrap: wrap;}
    .metric-card{
        background:var(--card-color); padding:10px; border-radius:8px; text-align:center;
        display:flex; flex-direction:column; justify-content:center;
        flex: 1 1 30%; min-width: 80px;
    }
    .metric-card .label{font-size:.65rem; color:var(--secondary-color); text-transform: uppercase;}
    .metric-card .value{font-size:1.4rem; font-weight:bold; color:var(--primary-color);}
    .metric-card .unit{font-size:.6rem; color: #888;}
    .card-pulse { animation: pulse-green 1s infinite; }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }

    /* Media Queries */
    @media (orientation: portrait) {
        .int-main-visual { grid-template-rows: auto auto auto; }
        .int-guidance { position: relative; top: 0; transform: none; margin-bottom: 5px; background: rgba(255,255,255,0.05); padding: 5px 20px; border-radius: 20px; width: fit-content; margin: 0 auto; flex-direction: row; gap: 10px;}
        .int-arrow { font-size: 1.5rem; margin: 0; }
        .int-guidance-text { font-size: 0.9rem; margin: 0; background: none;}
        .metric-card { flex: 1 1 40%; }
    }

    @media (orientation: landscape) and (max-height: 500px) {
        body { padding: 5px; }
        h1, header { display: none; }
        .buttons { margin: 5px 0; justify-content: flex-start; }
        button { padding: 6px 10px; font-size: 11px; min-width: auto; }
        
        #interval-dashboard {
            flex-direction: row; flex-wrap: wrap; padding: 5px; align-items: center; justify-content: center; height: 75vh;
        }
        .int-header { position: absolute; top: 10px; right: 10px; flex-direction: column; align-items: flex-end; width: auto; text-align: right; }
        .int-phase-info { align-items: flex-end; } .int-phase-name { font-size: 1.1rem; } .int-timer-big { font-size: 1.8rem; }
        .int-main-visual { grid-template-columns: 1.5fr 1fr; width: 100%; height: 100%; align-items: center; }
        .center-viz-container { height: 100%; justify-content: center; }
        .rower-container { height: 100%; width: auto; align-items: center; }
        canvas#rower-canvas { width: auto !important; height: 100% !important; max-height: 70vh !important; aspect-ratio: 450/220; }
        .rower-overlay-text { top: auto; bottom: 5px; right: 5px; } .target-big { font-size: 1.5rem; }
        .int-right-col { flex-direction: column; justify-content: center; height: 100%; gap: 10px; }
        .int-guidance { position: relative; top: auto; left: auto; transform: none; margin-bottom: 10px; }
        .int-progress-container { position: absolute; bottom: 0; left: 0; height: 3px; margin: 0; }
        .dashboard { display: none; } 
    }

    /* Utiles ocultos */
    #power-card .label, #power-card .power-controls, #power-card .subtle { display: none !important; }
    
    /* Modales */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a2e; width: 95%; max-width: 500px; max-height: 95vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #444;}
    .modal-header { padding: 10px 15px; background: #16213e; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
    .interval-row { display: grid; grid-template-columns: 0.8fr 0.8fr 2fr 30px; gap: 5px; align-items: center; background: #222; padding: 8px; border-radius: 4px; margin-bottom: 5px;}
    .interval-row input, .interval-row select { width: 100%; background: #333; border: none; color: white; padding: 8px; border-radius: 4px; }

    #results-screen{display:none; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-color); width:100%; min-height:100vh; position:absolute; top:0; left:0; z-index:200}
    .results-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; max-width:400px; margin-bottom:20px}
    .result-item{text-align:center; background: var(--card-color); padding: 10px; border-radius: 8px;}
    
    #err-banner{position:fixed; left:10px; right:10px; bottom:20px; background:#332020; color:#ffd1d1; border:1px solid #7a2c2c; padding:10px; border-radius:8px; display:none; z-index:9999; font-size:12px; text-align: center;}
  </style>
</head>
<body>

  <div id="err-banner"></div>

  <div class="container" id="main-screen">
    <header><h1>Panel Remo PRO</h1></header>

    <div class="buttons">
      <button id="connect-rower-btn">üîó Remo</button>
      <button id="connect-hr-btn">‚ù§Ô∏è HR</button>
      <button id="routine-btn">‚ö° Rutina</button>
      <button id="end-session-btn">‚èπ Finalizar</button>
      <button id="export-btn" disabled>‚¨á CSV</button>
    </div>

    <div class="status-bar">
      <div id="rower-status" class="status disconnected">Remo: Desconectado</div>
      <div id="hr-status" class="status disconnected">HR: --</div>
    </div>

    <!-- INTERVAL DASHBOARD -->
    <div id="interval-dashboard">
      <div class="int-header">
        <div class="int-phase-info">
          <div class="int-phase-name" id="int-phase-name">CALENTAMIENTO</div>
          <span class="int-step-count" id="int-step-count">1 / 4</span>
        </div>
        <div class="int-timer-block">
          <div class="int-timer-big" id="int-timer">00:00</div>
          <div class="int-timer-status" id="int-status">LISTO</div>
        </div>
      </div>

      <div class="int-main-visual">
        <div class="int-guidance">
          <span class="int-arrow" id="int-arrow">‚àí</span>
          <div class="int-guidance-text" id="int-msg">REMA</div>
        </div>

        <div class="center-viz-container">
            <div class="rower-container">
                <canvas id="rower-canvas" width="450" height="220"></canvas>
                <div class="rower-overlay-text">
                    <div class="target-big" id="int-target-spm">20</div>
                    <div class="target-lbl">OBJETIVO</div>
                </div>
            </div>
             <div class="linear-gauge-container" id="gauge-bar"></div>
        </div>

        <div class="int-right-col">
            <div class="int-actual-val">
                <span class="int-actual-num" id="int-current-spm">0</span>
                <span class="int-actual-lbl">ACTUAL SPM</span>
            </div>
            <div class="next-interval-box" id="next-interval-box" style="display:none;">
                <span class="next-lbl">LUEGO:</span>
                <span class="next-val" id="next-interval-val">--</span>
            </div>
        </div>
      </div>

      <div class="int-progress-container">
        <div class="int-progress-bar" id="int-progress-bar" style="width: 100%"></div>
      </div>
    </div>

    <!-- METRICAS -->
    <div class="dashboard">
      <div class="metrics-row">
        <div class="metric-card"><div class="label">Ritmo</div><div><span class="value" id="stroke-rate">0</span><span class="unit">SPM</span></div></div>
        <div class="metric-card" id="hr-card"><div class="label">Pulso</div><div><span class="value" id="heart-rate">--</span><span class="unit">BPM</span></div></div>
        <div class="metric-card"><div class="label">Paladas</div><div class="value" id="total-strokes">0</div></div>
        <div class="metric-card"><div class="label">Distancia</div><div><span class="value" id="distance">0.00</span><span class="unit">km</span></div></div>
      </div>
      <div class="metrics-row">
        <div class="metric-card" id="power-card">
          <div class="label" style="display:block!important">Potencia</div>
          <div><span class="value" id="power">0</span><span class="unit">W</span></div>
          <div class="power-controls" style="display:none!important">
            <select id="power-mode"><option value="equiv">Equiv</option><option value="ble">BLE</option><option value="corr">Corr</option></select>
            <input id="corr-factor" type="number" step="0.1" value="7.2">
          </div>
          <div class="subtle" id="power-source" style="display:block!important">Fuente: Equiv</div>
        </div>
        <div class="metric-card"><div class="label">Tiempo</div><div class="value" id="duration">00:00</div></div>
        <div class="metric-card"><div class="label">Calor√≠as</div><div><span class="value" id="calories">0</span><span class="unit">kcal</span></div></div>
        <div class="metric-card"><div class="label">Pace/500</div><div class="value" id="pace">--:--</div></div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results-screen">
    <h2>Resumen Sesi√≥n</h2>
    <div class="results-grid">
      <div class="result-item"><div class="label">Tiempo</div><div class="value" id="res-duration">00:00</div></div>
      <div class="result-item"><div class="label">Distancia</div><div class="value" id="res-distance">0.00 km</div></div>
      <div class="result-item"><div class="label">Calor√≠as</div><div class="value" id="res-calories">0 kcal</div></div>
      <div class="result-item"><div class="label">Paladas</div><div class="value" id="res-strokes">0</div></div>
      <div class="result-item"><div class="label">Ritmo Med</div><div class="value" id="res-avg-spm">0 SPM</div></div>
    </div>
    <div class="buttons">
      <button id="download-report-btn" disabled>Guardar Datos</button>
      <button id="new-session-btn">Nueva Sesi√≥n</button>
    </div>
  </div>

  <!-- MODAL RUTINA -->
  <div class="modal-overlay" id="routine-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 style="color:white;margin:0">Editor Rutina</h3><span class="close-modal" id="close-modal" style="cursor:pointer;color:#888;font-size:24px">&times;</span></div>
      <div class="modal-body">
        <div style="margin-bottom:15px"><label style="color:#aaa;font-size:11px">NOMBRE</label><input type="text" id="routine-name" style="width:100%;box-sizing:border-box;background:#333;border:none;color:white;padding:10px;border-radius:6px" placeholder="Ej: Tabata"></div>
        <div style="margin-bottom:10px"><label style="color:#aaa;font-size:11px">INTERVALOS</label><div id="intervals-container" style="display:flex;flex-direction:column;gap:5px;margin-top:5px"></div></div>
        <button id="add-interval-btn" style="width:100%;background:#3498db;color:white;padding:12px;border:none;border-radius:6px;cursor:pointer">+ Agregar</button>
      </div>
      <div style="padding:15px;border-top:1px solid #333;display:flex;justify-content:space-between"><button id="cancel-routine-btn" style="background:transparent;border:1px solid #555;color:#aaa">Cancelar</button><button id="start-routine-btn" style="background:#2ecc71;color:white">INICIAR</button></div>
    </div>
  </div>

  <script>
    /* ----------------- Utilidades & DOM ----------------- */
    const showError=(msg)=>{const b=document.getElementById('err-banner'); if(b){b.innerText=msg; b.style.display='block'; setTimeout(()=>b.style.display='none',5000);}};
    const formatMMSS=(s)=>{const m=Math.floor(s/60),sec=Math.max(0,Math.round(s%60));return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;}
    const nowTs=()=>{const d=new Date();return `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;}
    function updateText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }

    const dom = {
      rowerStatus: document.getElementById('rower-status'), hrStatus: document.getElementById('hr-status'),
      hrCard: document.getElementById('hr-card'), connectRowerBtn: document.getElementById('connect-rower-btn'), 
      connectHrBtn: document.getElementById('connect-hr-btn'), endSessionBtn: document.getElementById('end-session-btn'), 
      routineBtn: document.getElementById('routine-btn'), exportBtn: document.getElementById('export-btn'),
      intervalDashboard: document.getElementById('interval-dashboard'), intPhaseName: document.getElementById('int-phase-name'), 
      intStepCount: document.getElementById('int-step-count'), intTimer: document.getElementById('int-timer'), 
      intStatus: document.getElementById('int-status'), intArrow: document.getElementById('int-arrow'), 
      intMsg: document.getElementById('int-msg'), intTargetSpm: document.getElementById('int-target-spm'), 
      intCurrentSpm: document.getElementById('int-current-spm'), intProgressBar: document.getElementById('int-progress-bar'), 
      nextBox: document.getElementById('next-interval-box'), nextVal: document.getElementById('next-interval-val'),
      spmVal: document.getElementById('stroke-rate'), powerVal: document.getElementById('power'), 
      hrVal: document.getElementById('heart-rate'), powerMode: document.getElementById('power-mode'), 
      corrFactor: document.getElementById('corr-factor'), mainScreen: document.getElementById('main-screen'), 
      resultsScreen: document.getElementById('results-screen'), modal: document.getElementById('routine-modal'), 
      closeModal: document.getElementById('close-modal'), addIntervalBtn: document.getElementById('add-interval-btn'), 
      intervalsContainer: document.getElementById('intervals-container'), startRoutineBtn: document.getElementById('start-routine-btn'), 
      cancelRoutineBtn: document.getElementById('cancel-routine-btn'), canvas: document.getElementById('rower-canvas'),
      gaugeBar: document.getElementById('gauge-bar')
    };

    let sessionTimer=null, elapsedSeconds=0, sessionActive=false, currentSpm=0;
    let isRowing=false, rowingTimeout=null;
    let activeRoutine=null, currentStepIndex=0, stepTimeRemaining=0, inIntervalMode=false;
    let lastPaceSeconds=null, lastPowerBle=null;
    let rawEvents = [];

    /* =========================================================================
       WAKE LOCK MEJORADO (Adaptado del Contexto 1)
       ========================================================================= */
    let wakeLock = null;
    let connectedRower = false;
    let connectedHr = false;
    let isFullscreen = false;

    // Condici√≥n: Mantener pantalla si hay remo conectado, HR conectado, o sesi√≥n activa
    function shouldHoldWakeLock() {
      return connectedRower || connectedHr || sessionActive || isFullscreen;
    }

    async function acquireWakeLockOnce() {
      if (!('wakeLock' in navigator) || wakeLock) return;
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          wakeLock = null;
          // Re-intentar adquirir si todav√≠a es necesario y la app es visible
          if (document.visibilityState === 'visible' && shouldHoldWakeLock()) {
            acquireWakeLockOnce().catch(() => {});
          }
        });
        console.log("Wake Lock adquirido");
      } catch (err) {
        console.warn("Wake Lock fail:", err);
      }
    }

    async function releaseWakeLockIfHeld() {
      if (!wakeLock) return;
      try { await wakeLock.release(); } catch (err) {}
      wakeLock = null;
      console.log("Wake Lock liberado");
    }

    async function syncWakeLock() {
      if (document.visibilityState !== 'visible') return;
      if (shouldHoldWakeLock()) {
        await acquireWakeLockOnce();
      } else {
        await releaseWakeLockIfHeld();
      }
    }

    // Event Listeners del Sistema
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') syncWakeLock();
    });
    
    document.addEventListener('fullscreenchange', () => {
      isFullscreen = !!document.fullscreenElement;
      syncWakeLock();
    });
    
    // Backup para navegadores m√≥viles a veces perezosos
    document.addEventListener('touchstart', async () => { 
        if(shouldHoldWakeLock() && !wakeLock) await syncWakeLock(); 
    }, {passive: true});


    /* ----------------- GAUGE & VISUALS ----------------- */
    const SEGMENT_COUNT = 20;
    function initGauge() {
        if(!dom.gaugeBar) return;
        dom.gaugeBar.innerHTML = '';
        for (let i = 0; i < SEGMENT_COUNT; i++) {
            const seg = document.createElement('div'); seg.className = 'gauge-segment inactive';
            let color = '#4caf50'; 
            if (i >= 5) color = '#ffeb3b'; if (i >= 10) color = '#ff9800'; if (i >= 15) color = '#f44336'; 
            seg.dataset.color = color; dom.gaugeBar.appendChild(seg);
        }
    }
    function updateGauge(phase, isDrive) {
        if(!dom.gaugeBar) return;
        const segments = dom.gaugeBar.children;
        const activeCount = Math.floor(phase * SEGMENT_COUNT);
        for (let i = 0; i < SEGMENT_COUNT; i++) {
            const seg = segments[i];
            if ((isDrive && i <= activeCount) || (!isDrive && i <= activeCount)) { 
                seg.className = 'gauge-segment active'; seg.style.background = seg.dataset.color; 
            } else { seg.className = 'gauge-segment inactive'; seg.style.background = ''; }
        }
    }

    /* ----------------- CANVAS ----------------- */
    const ctx = dom.canvas.getContext('2d');
    let animFrame = null;
    let lastBeepTime = 0;

    function lerpColor(a, b, amount) {
        const ar = a >> 16, ag = a >> 8 & 0xff, ab = a & 0xff;
        const br = b >> 16, bg = b >> 8 & 0xff, bb = b & 0xff;
        return '#' + ((1 << 24) + ((ar + amount * (br - ar)) << 16) + ((ag + amount * (bg - ag)) << 8) + ((ab + amount * (bb - ab)) | 0)).toString(16).slice(1);
    }

    function drawRower(phase, isDrive = true) {
        if(!ctx) return;
        const dpr = window.devicePixelRatio || 1;
        const rect = dom.canvas.getBoundingClientRect();
        if(dom.canvas.width !== Math.floor(rect.width * dpr) || dom.canvas.height !== Math.floor(rect.height * dpr)){
             dom.canvas.width = rect.width * dpr; dom.canvas.height = rect.height * dpr;
             ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
        }
        ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
        
        ctx.save();
        const globalScale = Math.min(dom.canvas.width / 450, dom.canvas.height / 220);
        const offsetX = (dom.canvas.width - (450 * globalScale)) / 2;
        const offsetY = (dom.canvas.height - (220 * globalScale)) / 2;
        ctx.translate(offsetX, offsetY); ctx.scale(globalScale, globalScale);

        const colorHex = lerpColor(0x4caf50, 0xf44336, phase);
        ctx.strokeStyle = colorHex; ctx.fillStyle = colorHex;

        const cx = 225, cy = 180, scale = 0.9; 
        const ankle = { x: cx - 140 * scale, y: cy - 20 * scale }; 
        const slideLen = 180 * scale; 
        const seatX = (ankle.x + (50 * scale)) + (slideLen * phase);
        const hip = { x: seatX, y: cy - 30 * scale };
        const kneeX = (hip.x + ankle.x) / 2;
        const kneeY = hip.y - (60 * scale) * (1 - phase); 
        const knee = { x: kneeX, y: kneeY };
        const torsoLen = 120 * scale; 
        const swingAngle = -25 + (phase * 50); 
        const rad = swingAngle * Math.PI / 180;
        const shoulder = { x: hip.x + Math.sin(rad) * torsoLen, y: hip.y - Math.cos(rad) * torsoLen };
        const head = { x: shoulder.x + Math.sin(rad) * 25 * scale, y: shoulder.y - Math.cos(rad) * 25 * scale };
        let armExtension = 1; if (phase > 0.5) armExtension = 1 - ((phase - 0.5) * 2 * 0.9);
        const hand = { x: shoulder.x - (125 * scale * armExtension), y: shoulder.y + 40 * scale };

        ctx.beginPath(); ctx.lineWidth = 8; ctx.strokeStyle = '#333';
        ctx.moveTo(cx - 180 * scale, cy); ctx.lineTo(cx + 180 * scale, cy); ctx.stroke(); // Riel

        ctx.strokeStyle = colorHex; ctx.lineWidth = 16;
        ctx.beginPath(); ctx.moveTo(ankle.x, ankle.y); ctx.lineTo(knee.x, knee.y); ctx.lineTo(hip.x, hip.y); ctx.stroke(); 
        ctx.beginPath(); ctx.moveTo(hip.x, hip.y); ctx.lineTo(shoulder.x, shoulder.y); ctx.stroke(); 
        ctx.beginPath(); ctx.arc(head.x, head.y, 15 * scale, 0, Math.PI * 2); ctx.fill(); 
        ctx.beginPath(); ctx.lineWidth = 14; ctx.moveTo(shoulder.x, shoulder.y); ctx.lineTo(hand.x, hand.y); ctx.stroke(); 
        ctx.beginPath(); ctx.lineWidth = 5; ctx.strokeStyle = '#e0e0e0'; ctx.moveTo(hand.x, hand.y); ctx.lineTo(cx - 200 * scale, hand.y); ctx.stroke();
        
        ctx.restore();
    }

    function startMetronomeLoop() {
      if(animFrame) cancelAnimationFrame(animFrame);
      const loop = () => {
        if(!inIntervalMode || !activeRoutine) return;
        if(isRowing) {
            const step = activeRoutine.steps[currentStepIndex];
            const targetSpm = step.spm > 0 ? step.spm : 20; 
            const cycleMs = (60 / targetSpm) * 1000;
            const now = Date.now();
            if(now - lastBeepTime > cycleMs) { lastBeepTime = now; playBeep(880, 0.1); }
            const progress = (now - lastBeepTime) / cycleMs; 
            let drivePhase = 0; let isDrive = true;
            if (progress < 0.35) { drivePhase = progress / 0.35; isDrive = true; } 
            else { const recovProgress = (progress - 0.35) / 0.65; drivePhase = 1.0 - recovProgress; isDrive = false; }
            drawRower(Math.min(1, Math.max(0, drivePhase)), isDrive); updateGauge(Math.min(1, Math.max(0, drivePhase)), isDrive);
        } else { drawRower(0, true); updateGauge(0, true); }
        animFrame = requestAnimationFrame(loop);
      };
      animFrame = requestAnimationFrame(loop);
    }

    /* ----------------- Audio & Logic ----------------- */
    let audioCtx = null;
    function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playBeep(freq=880, dur=0.1) {
      if(!audioCtx) return; if(audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur); osc.stop(audioCtx.currentTime + dur);
    }

    dom.routineBtn.addEventListener('click', () => { dom.modal.style.display = 'flex'; loadRoutineForm(); });
    dom.closeModal.addEventListener('click', () => dom.modal.style.display = 'none');
    dom.cancelRoutineBtn.addEventListener('click', () => dom.modal.style.display = 'none');
    dom.addIntervalBtn.addEventListener('click', () => addIntervalRow());

    function addIntervalRow(data = {sec: 60, spm: 20, label: 'Trabajo'}) {
      const div = document.createElement('div'); div.className = 'interval-row';
      div.innerHTML = `<input type="number" class="int-dur" value="${data.sec}"><input type="number" class="int-spm" value="${data.spm}"><select class="int-lbl"><option value="Calentar" ${data.label==='Calentar'?'selected':''}>Calentar</option><option value="Trabajo" ${data.label==='Trabajo'?'selected':''}>Trabajo</option><option value="Sprint" ${data.label==='Sprint'?'selected':''}>Sprint</option><option value="Descanso" ${data.label==='Descanso'?'selected':''}>Descanso</option></select><button class="del-row-btn" style="background:#ff4545;color:white;border:none;border-radius:4px">&times;</button>`;
      div.querySelector('.del-row-btn').onclick = () => div.remove(); dom.intervalsContainer.appendChild(div);
    }
    function loadRoutineForm() {
      dom.intervalsContainer.innerHTML = ''; const saved = localStorage.getItem('lastRoutine');
      if (saved) { const r = JSON.parse(saved); document.getElementById('routine-name').value = r.name; r.steps.forEach(s => addIntervalRow(s)); }
      else { addIntervalRow({sec: 300, spm: 18, label: 'Calentar'}); addIntervalRow({sec: 60, spm: 24, label: 'Trabajo'}); addIntervalRow({sec: 60, spm: 20, label: 'Descanso'}); }
    }
    dom.startRoutineBtn.addEventListener('click', () => {
      initAudio(); const name = document.getElementById('routine-name').value || 'Rutina';
      const rows = Array.from(document.querySelectorAll('.interval-row')); if(!rows.length) return;
      const steps = rows.map(r => ({ sec: parseInt(r.querySelector('.int-dur').value)||60, spm: parseInt(r.querySelector('.int-spm').value)||20, label: r.querySelector('.int-lbl').value }));
      localStorage.setItem('lastRoutine', JSON.stringify({ name, steps }));
      startIntervalSession({ name, steps }); dom.modal.style.display = 'none';
      // Sync Wake Lock al iniciar rutina
      syncWakeLock();
    });

    function startIntervalSession(routine) {
      if(sessionActive) stopTimer(); resetUI();
      activeRoutine = routine; currentStepIndex = 0; inIntervalMode = true; isRowing = false;
      dom.intervalDashboard.style.display = 'flex'; loadStep(0); startTimer(); startMetronomeLoop();
    }
    function loadStep(idx) {
      if (idx >= activeRoutine.steps.length) { finishRoutine(); return; }
      currentStepIndex = idx; const step = activeRoutine.steps[idx]; stepTimeRemaining = step.sec;
      updateText('int-phase-name', step.label); updateText('int-step-count', `${idx + 1} / ${activeRoutine.steps.length}`);
      updateText('int-target-spm', step.spm);
      const nextStep = activeRoutine.steps[idx+1];
      if(nextStep && dom.nextBox) { dom.nextBox.style.display = 'block'; updateText('next-interval-val', `${nextStep.label} @ ${nextStep.spm}`); } 
      else if(dom.nextBox) { dom.nextBox.style.display = 'none'; }
      updateIntervalUI();
    }
    function updateIntervalUI() {
      if(!activeRoutine) return;
      const step = activeRoutine.steps[currentStepIndex];
      updateText('int-timer', formatMMSS(stepTimeRemaining));
      if(dom.intProgressBar) dom.intProgressBar.style.width = `${((step.sec - stepTimeRemaining) / step.sec) * 100}%`;
      updateText('int-current-spm', currentSpm);
      
      const dash = dom.intervalDashboard; const arrow = dom.intArrow; 
      if(dash) dash.className = ''; if(arrow) arrow.className = 'int-arrow';
      
      if (!isRowing) { updateText('int-arrow', "‚àí"); updateText('int-msg', "REMA"); if(arrow) arrow.style.color = "#888"; if(dash) dash.style.borderColor = "#444"; }
      else {
        const diff = currentSpm - step.spm;
        if (diff < -2) { updateText('int-arrow', "‚ñ≤"); updateText('int-msg', "SUBE"); arrow.classList.add('guide-up'); dash.classList.add('dash-slow'); }
        else if (diff > 2) { updateText('int-arrow', "‚ñº"); updateText('int-msg', "BAJA"); arrow.classList.add('guide-down'); dash.classList.add('dash-fast'); }
        else { updateText('int-arrow', "‚óè"); updateText('int-msg', "BIEN"); arrow.classList.add('guide-ok'); dash.classList.add('dash-good'); }
      }
    }
    function checkRowingStatus(spm) {
        if (spm > 0) {
            isRowing = true; updateText('int-status', "REMA"); 
            if(dom.intStatus) dom.intStatus.style.color = "#4caf50";
            if(rowingTimeout) clearTimeout(rowingTimeout);
            rowingTimeout = setTimeout(() => { 
                isRowing = false; updateText('int-status', "PAUSA"); if(dom.intStatus) dom.intStatus.style.color = "#ffd700"; 
                updateIntervalUI(); drawRower(0, true); updateGauge(0, true); 
            }, 4000);
        }
    }

    const FTMS_UUID=0x1826; const ROWER_CHAR_UUID=0x2AD1; const HR_SERVICE_UUID=0x180D; const HR_CHAR_UUID=0x2A37;
    
    // --- CONEXI√ìN REMO CON GESTI√ìN DE DESCONEXI√ìN ---
    dom.connectRowerBtn.addEventListener('click', async ()=>{
      try{ if(!navigator.bluetooth) throw new Error("Bluetooth API Off"); 
        const dev = await navigator.bluetooth.requestDevice({filters:[{services:[FTMS_UUID]}], optionalServices:[FTMS_UUID]});
        
        // Listener de desconexi√≥n (Portado de Context 1)
        dev.addEventListener('gattserverdisconnected', onRowerDisconnected);
        
        const server = await dev.gatt.connect(); 
        connectedRower=true; 
        updateText('rower-status', dev.name); if(dom.rowerStatus) dom.rowerStatus.className='status connected';
        
        const svc = await server.getPrimaryService(FTMS_UUID); const ch = await svc.getCharacteristic(ROWER_CHAR_UUID);
        await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', handleRowerData); 
        
        syncWakeLock(); // Activar pantalla
      }catch(e){ showError("Err Remo: " + e.message); connectedRower=false; syncWakeLock(); }
    });

    function onRowerDisconnected() {
        connectedRower = false;
        updateText('rower-status', 'Remo: Desconectado');
        if(dom.rowerStatus) dom.rowerStatus.className = 'status disconnected';
        alert("El remo se ha desconectado.");
        stopTimer(); 
        syncWakeLock(); // Liberar pantalla si no hay nada m√°s
    }

    // --- CONEXI√ìN HR CON GESTI√ìN DE DESCONEXI√ìN ---
    dom.connectHrBtn.addEventListener('click', async ()=>{
      try{ if(!navigator.bluetooth) throw new Error("Bluetooth Off");
        const dev = await navigator.bluetooth.requestDevice({ filters:[{services:[HR_SERVICE_UUID]}], optionalServices:[HR_SERVICE_UUID] });
        
        dev.addEventListener('gattserverdisconnected', onHrDisconnected);

        const server = await dev.gatt.connect(); 
        connectedHr=true; 
        updateText('hr-status', dev.name); if(dom.hrStatus) dom.hrStatus.className='status connected';
        
        const svc = await server.getPrimaryService(HR_SERVICE_UUID); const ch = await svc.getCharacteristic(HR_CHAR_UUID);
        await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', e=>{ 
            const v=e.target.value; const val = (v.getUint8(0) & 1) ? v.getUint16(1, true) : v.getUint8(1);
            updateText('heart-rate', val); if(dom.hrCard) { dom.hrCard.classList.remove('card-pulse'); void dom.hrCard.offsetWidth; dom.hrCard.classList.add('card-pulse'); }
        }); 
        
        syncWakeLock(); // Activar pantalla
      }catch(e){ showError("Err HR: " + e.message); connectedHr=false; syncWakeLock(); }
    });

    function onHrDisconnected() {
        connectedHr = false;
        updateText('hr-status', 'HR: --');
        if(dom.hrStatus) dom.hrStatus.className = 'status disconnected';
        updateText('heart-rate', '--');
        syncWakeLock();
    }

    function handleRowerData(e){ 
        // Si llegan datos y no hay sesi√≥n timer, iniciar (Auto-start)
        if(!sessionTimer && !inIntervalMode) startTimer(); 
        parseRowerData(e.target.value); 
    }

    function parseRowerData(data){
      const flags=data.getUint16(0,true); let offset=2; const parsed={};
      const sr=data.getUint8(offset)/2.0; offset+=1; currentSpm = Math.round(sr); 
      updateText('stroke-rate', currentSpm); parsed.spm = currentSpm; checkRowingStatus(currentSpm); if(inIntervalMode) updateIntervalUI();
      const strokes=data.getUint16(offset,true); offset+=2; updateText('total-strokes', strokes); parsed.strokes=strokes;
      if(flags&0x0002) offset+=1; 
      if(flags&0x0004){ const dist=(data.getUint32(offset,true)&0x00FFFFFF); offset+=3; updateText('distance', (dist/1000).toFixed(2)); parsed.dist_m=dist; }
      if(flags&0x0008){ const pace=data.getUint16(offset,true); offset+=2; lastPaceSeconds = pace; updateText('pace', formatMMSS(pace)); parsed.pace_s=pace; }
      if(flags&0x0010) offset+=2; 
      if(flags&0x0020){ const p=data.getInt16(offset,true); offset+=2; lastPowerBle = p; parsed.power_ble=p; }
      if(flags&0x0080) offset+=2; 
      if(flags&0x0100){ const kcal=data.getUint16(offset,true); offset+=5; updateText('calories', kcal); parsed.kcal=kcal; }
      parsed.power_display = applyPowerDisplay(); if(sessionActive && isRowing){ rawEvents.push({ts:nowTs(), parsed}); }
    }
    
    function applyPowerDisplay(){
      const mode=dom.powerMode.value, fact=dom.corrFactor.value;
      const pC2 = (lastPaceSeconds>0) ? 2.8/Math.pow(lastPaceSeconds/500,3) : 0; const pCorr=Math.max(0, (lastPowerBle||0)*fact);
      let val=0; if(mode==='equiv'){ val=pC2||pCorr||lastPowerBle||0; } else if(mode==='ble'){ val=lastPowerBle||0; } else { val=pCorr||pC2||0; }
      updateText('power', Math.round(val)); return Math.round(val);
    }
    dom.powerMode.addEventListener('change', applyPowerDisplay); dom.corrFactor.addEventListener('input', applyPowerDisplay);

    function startTimer(){ 
        if(sessionTimer) return; 
        sessionActive = true; 
        syncWakeLock(); // Asegurar pantalla encendida
        dom.exportBtn.disabled=false; 
        
        sessionTimer = setInterval(()=>{ 
            // La pantalla sigue activa aunque no se reme, porque sessionActive=true
            if(isRowing) { 
                elapsedSeconds++; 
                updateText('duration', formatMMSS(elapsedSeconds)); 
                if(inIntervalMode) { 
                    stepTimeRemaining--; 
                    updateIntervalUI(); 
                    if(stepTimeRemaining <= 0) loadStep(currentStepIndex + 1); 
                } 
            } 
        }, 1000); 
    }

    function stopTimer(){ 
        clearInterval(sessionTimer); 
        if(animFrame) cancelAnimationFrame(animFrame); 
        sessionTimer = null; 
        sessionActive = false; // Importante para el Wake Lock
        inIntervalMode = false; 
        isRowing = false; 
        dom.intervalDashboard.style.display = 'none'; 
        syncWakeLock(); // Intentar liberar pantalla
    }

    function finishRoutine() { inIntervalMode = false; activeRoutine = null; alert("¬°Rutina completada!"); dom.endSessionBtn.click(); }
    
    dom.endSessionBtn.addEventListener('click', ()=>{ 
        if(!rawEvents.length && !sessionActive && elapsedSeconds === 0) return alert("Sin datos"); 
        stopTimer(); 
        dom.mainScreen.style.display='none'; dom.resultsScreen.style.display='flex'; 
        updateText('res-duration', formatMMSS(elapsedSeconds)); updateText('res-distance', document.getElementById('distance').textContent + " km"); 
        updateText('res-calories', document.getElementById('calories').textContent + " kcal"); updateText('res-strokes', document.getElementById('total-strokes').textContent); 
        const spms = rawEvents.map(e=>e.parsed.spm).filter(x=>x>0); updateText('res-avg-spm', (spms.length ? Math.round(spms.reduce((a,b)=>a+b,0)/spms.length) : 0) + " SPM");
        document.getElementById('download-report-btn').disabled = false;
    });

    document.getElementById('new-session-btn').addEventListener('click', ()=>{ 
        dom.resultsScreen.style.display='none'; dom.mainScreen.style.display='flex'; resetUI(); 
        syncWakeLock(); // Actualizar estado de pantalla
    });

    function resetUI(){ 
        elapsedSeconds=0; rawEvents=[]; ['duration','distance','calories','total-strokes','stroke-rate','power'].forEach(id=>updateText(id, '0')); updateText('pace', '--:--'); dom.exportBtn.disabled=true; lastPaceSeconds=null; lastPowerBle=null; 
        document.getElementById('download-report-btn').disabled = true;
    }
    
    const exportData = () => {
        if(!rawEvents.length) return alert("Sin datos");
        let csv = "Timestamp,SPM,Watts,Pace,Strokes,Dist\n";
        rawEvents.forEach(e => { csv += `${e.ts},${e.parsed.spm},${e.parsed.power_display},${e.parsed.pace_s||0},${e.parsed.strokes},${e.parsed.dist_m||0}\n`; });
        const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `remo_sesion_${Date.now()}.csv`; a.click();
    };
    dom.exportBtn.addEventListener('click', exportData); document.getElementById('download-report-btn').addEventListener('click', exportData);
    
    // Inicializaci√≥n visual
    drawRower(0, true); initGauge();
  </script>
</body>
</html>
